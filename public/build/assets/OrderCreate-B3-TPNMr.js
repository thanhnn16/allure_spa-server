import{Z as j,F as J}from"./@inertiajs-D0DMCEQB.js";import{_ as X}from"./SectionMain-Vot1TOkK.js";import{L as Z}from"./LayoutAuthenticated-CTVOLc3W.js";import{r as C,c as Q,e as O,b2 as q,aU as i,a0 as W,bH as B,aa as H,a3 as r,bM as Y,bJ as b,bA as U,a2 as l,F as f,b0 as h,bf as m,a9 as V,a1 as I,bz as T}from"./@vue-BRgAy5zV.js";import{a as x}from"./axios-CCb-kr4I.js";import{l as $}from"./lodash-D4AGecfG.js";import{u as ee}from"./vue-toastification-ejyjJRED.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-ArhfA4cU.js";import"./app-CsQixHrY.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const te={components:{Head:j,SectionMain:X,LayoutAuthenticated:Z},props:{vouchers:Array,paymentMethods:Array},setup(S){const e=ee(),d=C({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),a=C(""),p=C([]),R=C(null),N=$.debounce(async()=>{if(a.value.length<2){p.value=[];return}try{const o=await x.get("/api/users/search",{params:{query:a.value}});p.value=o.data.data}catch(o){console.error("Search error:",o),p.value=[]}},300),F=o=>{d.value.user_id=o.id,R.value=o,a.value=o.full_name,p.value=[]},M=()=>{d.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},t=o=>{d.value.order_items.splice(o,1)},u=async o=>{const s=d.value.order_items[o];if(s.search.length<2){s.searchResults=[];return}try{const c=s.item_type==="product"?"/api/products/search":"/api/services/search",w=await x.get(c,{params:{query:s.search}});s.searchResults=w.data.data.map(y=>({...y,item_type:s.item_type}))}catch(c){console.error("Error searching items:",c),s.searchResults=[]}},n=(o,s)=>{const c=d.value.order_items[o];c.selectedItem=s,c.item_id=s.id,c.search=s.name||s.service_name,s.item_type==="service"?_(c):c.price=Number(s.price),c.searchResults=[],D()},k=()=>d.value.order_items.reduce((o,s)=>o+s.quantity*s.price,0),v=()=>{if(!d.value.voucher_id)return 0;const o=S.vouchers.find(c=>c.id===d.value.voucher_id);if(!o)return 0;const s=k();return o.discount_type==="percentage"?s*(o.discount_value/100):o.discount_value},E=()=>Math.max(0,k()-v()),D=()=>{d.value.total_amount=E(),d.value.discount_amount=v()},z=async()=>{var o,s,c,w;try{if(!d.value.user_id){e.error("Vui lòng chọn khách hàng");return}if(d.value.order_items.length===0){e.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}for(const g of d.value.order_items)if(!g.item_id||!g.selectedItem){e.error("Vui lòng chọn đầy đủ thông tin cho tất cả sản phẩm/dịch vụ");return}d.value.total_amount=k(),d.value.discount_amount=v();const L=(await x.post("/api/orders",d.value)).data.data;if(d.value.payment_method_id===3)try{const P=(await x.post(`/api/orders/${L.id}/create-invoice`)).data.data,A=await x.post(`/api/invoices/${P.id}/pay-with-payos`,{returnUrl:`${window.location.origin}/payment/callback`,cancelUrl:`${window.location.origin}/payment/callback?status=cancel`});A.data.success?window.location.href=A.data.checkoutUrl:e.error("Có lỗi xảy ra khi tạo link thanh toán")}catch(g){console.error("Error creating payment link:",g),e.error(((s=(o=g.response)==null?void 0:o.data)==null?void 0:s.message)||"Có lỗi xảy ra khi xử lý thanh toán")}else J.visit(`/orders/${L.id}`)}catch(y){console.error("Error creating order:",y),e.error(((w=(c=y.response)==null?void 0:c.data)==null?void 0:w.message)||"Có lỗi xảy ra khi tạo đơn hàng")}},G=o=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(o),K=Q(()=>["pending","confirmed","shipping","delivered"].includes(S.order.status));O(()=>d.value.order_items,o=>{o.forEach(s=>{s.selectedItem&&s.item_type==="service"&&_(s)})},{deep:!0});const _=o=>{if(o.selectedItem){switch(o.service_type){case"combo_5":o.price=Number(o.selectedItem.combo_5_price||0);break;case"combo_10":o.price=Number(o.selectedItem.combo_10_price||0);break;default:o.price=Number(o.selectedItem.single_price||0);break}D()}};return O(()=>d.value.order_items.map(o=>o.service_type),()=>{d.value.order_items.forEach(o=>{o.item_type==="service"&&o.selectedItem&&_(o)})},{deep:!0}),{form:d,userSearch:a,userResults:p,selectedUser:R,searchUsers:N,selectUser:F,addOrderItem:M,removeOrderItem:t,searchItems:u,selectItem:n,calculateTotal:k,calculateDiscount:v,calculateFinalTotal:E,formatCurrency:G,submitForm:z,canUpdateStatus:K,updateServicePrice:_}}},oe={class:"container mx-auto px-4 py-8"},ae={class:"mb-4"},se={class:"relative"},de={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border"},ne=["onClick"],ie={class:"font-medium text-gray-900 dark:text-dark-text"},le={class:"text-sm text-gray-500 dark:text-dark-text-muted"},ce={key:0,class:"ml-2"},me={class:"grid grid-cols-2 gap-4"},ue=["onUpdate:modelValue","onChange"],be={key:0},pe=["onUpdate:modelValue"],ge={class:"mt-4"},ke=["onUpdate:modelValue","onInput","placeholder"],ye={key:0,class:"mt-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto focus:outline-none sm:text-sm"},fe=["onClick"],he={class:"flex flex-col"},xe={class:"font-medium text-gray-900 dark:text-dark-text"},ve={key:0,class:"text-sm text-gray-600 dark:text-dark-text-muted"},_e={key:1,class:"text-sm text-gray-600 dark:text-dark-text-muted"},we={class:"mt-4 grid grid-cols-3 gap-4"},Ce=["onUpdate:modelValue"],Ue=["value"],Ve=["value"],Ie=["onClick"],Te=["value"],Se=["value"],Re={class:"flex justify-between items-center"},Ne={class:"text-right"},Fe={class:"text-sm text-gray-600 dark:text-gray-400"},Me={class:"text-sm text-red-600 dark:text-red-400"},qe={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"};function Ee(S,e,d,a,p,R){const N=q("Head"),F=q("SectionMain"),M=q("LayoutAuthenticated");return i(),W(M,null,{default:B(()=>[H(N,{title:"Tạo đơn hàng mới"}),H(F,null,{default:B(()=>[r("div",oe,[e[24]||(e[24]=r("h1",{class:"text-3xl font-bold mb-6 text-gray-900 dark:text-dark-text"},"Tạo đơn hàng mới",-1)),r("form",{onSubmit:e[6]||(e[6]=Y((...t)=>a.submitForm&&a.submitForm(...t),["prevent"])),class:"space-y-6"},[r("div",ae,[e[7]||(e[7]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1"}," Khách hàng ",-1)),r("div",se,[b(r("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.userSearch=t),onInput:e[1]||(e[1]=(...t)=>a.searchUsers&&a.searchUsers(...t)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"},null,544),[[U,a.userSearch]]),a.userResults.length>0?(i(),l("div",de,[(i(!0),l(f,null,h(a.userResults,t=>(i(),l("div",{key:t.id,onClick:u=>a.selectUser(t),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface-hover cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[r("div",ie,m(t.full_name),1),r("div",le,[V(" SĐT: "+m(t.phone_number)+" ",1),t.email?(i(),l("span",ce,"Email: "+m(t.email),1)):I("",!0)])],8,ne))),128))])):I("",!0)])]),r("div",null,[e[18]||(e[18]=r("h3",{class:"text-lg font-medium text-gray-900 dark:text-dark-text mb-2"},"Sản phẩm/Dịch vụ",-1)),r("button",{type:"button",onClick:e[2]||(e[2]=(...t)=>a.addOrderItem&&a.addOrderItem(...t)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg"}," Thêm sản phẩm/dịch vụ "),(i(!0),l(f,null,h(a.form.order_items,(t,u)=>(i(),l("div",{key:u,class:"mb-4 p-4 border rounded-md border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface"},[r("div",me,[r("div",null,[e[9]||(e[9]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),b(r("select",{"onUpdate:modelValue":n=>t.item_type=n,onChange:n=>a.searchItems(u),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[8]||(e[8]=[r("option",{value:"product"},"Sản phẩm",-1),r("option",{value:"service"},"Dịch vụ",-1)]),40,ue),[[T,t.item_type]])]),t.item_type==="service"?(i(),l("div",be,[e[11]||(e[11]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),b(r("select",{"onUpdate:modelValue":n=>t.service_type=n,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[10]||(e[10]=[r("option",{value:"single"},"Đơn lẻ",-1),r("option",{value:"combo_5"},"Combo 5",-1),r("option",{value:"combo_10"},"Combo 10",-1)]),8,pe),[[T,t.service_type]])])):I("",!0)]),r("div",ge,[e[14]||(e[14]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),b(r("input",{type:"text","onUpdate:modelValue":n=>t.search=n,onInput:n=>a.searchItems(u),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:t.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ke),[[U,t.search]]),t.searchResults.length>0?(i(),l("ul",ye,[(i(!0),l(f,null,h(t.searchResults,n=>(i(),l("li",{key:n.id,onClick:k=>a.selectItem(u,n),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-primary-50 dark:hover:bg-dark-surface-hover"},[r("div",he,[r("span",xe,m(n.name||n.service_name),1),n.item_type==="service"?(i(),l("span",ve,[V(" Đơn lẻ: "+m(a.formatCurrency(n.single_price))+" ",1),e[12]||(e[12]=r("br",null,null,-1)),V(" Combo 5: "+m(a.formatCurrency(n.combo_5_price))+" ",1),e[13]||(e[13]=r("br",null,null,-1)),V(" Combo 10: "+m(a.formatCurrency(n.combo_10_price)),1)])):(i(),l("span",_e,m(a.formatCurrency(n.price)),1))])],8,fe))),128))])):I("",!0)]),r("div",we,[r("div",null,[e[15]||(e[15]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Số lượng:",-1)),b(r("input",{"onUpdate:modelValue":n=>t.quantity=n,type:"number",min:"1",class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-dark-border rounded-md dark:bg-dark-surface dark:text-dark-text"},null,8,Ce),[[U,t.quantity,void 0,{number:!0}]])]),r("div",null,[e[16]||(e[16]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Đơn giá:",-1)),r("input",{value:a.formatCurrency(t.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ue)]),r("div",null,[e[17]||(e[17]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Thành tiền:",-1)),r("input",{value:a.formatCurrency(t.quantity*t.price),class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ve)])]),r("button",{type:"button",onClick:n=>a.removeOrderItem(u),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,Ie)]))),128))]),r("div",null,[e[20]||(e[20]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),b(r("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.form.voucher_id=t),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[e[19]||(e[19]=r("option",{value:""},"Không áp dụng",-1)),(i(!0),l(f,null,h(d.vouchers,t=>(i(),l("option",{key:t.id,value:t.id},m(t.code)+" - "+m(t.discount_type==="percentage"?`${t.discount_value}%`:a.formatCurrency(t.discount_value)),9,Te))),128))],512),[[T,a.form.voucher_id]])]),r("div",null,[e[21]||(e[21]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),b(r("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.form.payment_method_id=t),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(i(!0),l(f,null,h(d.paymentMethods,t=>(i(),l("option",{key:t.id,value:t.id},m(t.method_name),9,Se))),128))],512),[[T,a.form.payment_method_id]])]),r("div",null,[e[22]||(e[22]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),b(r("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.form.note=t),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[U,a.form.note]])]),r("div",Re,[e[23]||(e[23]=r("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Tạo đơn hàng và hóa đơn ",-1)),r("div",Ne,[r("p",Fe,"Tổng tiền: "+m(a.formatCurrency(a.calculateTotal())),1),r("p",Me,"Giảm giá: -"+m(a.formatCurrency(a.calculateDiscount())),1),r("p",qe,"Thành tiền: "+m(a.formatCurrency(a.calculateFinalTotal())),1)])])],32)])]),_:1})]),_:1})}const Cr=re(te,[["render",Ee],["__scopeId","data-v-bc8f33d2"]]);export{Cr as default};

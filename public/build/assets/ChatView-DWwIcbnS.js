import{c as pe,r as u,o as ge,b as X,e as ee,aL as he,n as z,aU as o,a0 as ke,bH as te,aa as re,bl as a,a3 as t,bJ as se,bA as ae,q as oe,a2 as l,F as H,b0 as q,bf as x,a1 as f,j as w,bM as xe}from"./@vue-BRgAy5zV.js";import{L as ye}from"./LayoutAuthenticated-CnzsnGDD.js";import{Z as be,Q as _e}from"./@inertiajs-D0DMCEQB.js";import{a as U}from"./axios-CCb-kr4I.js";import{h as W}from"./moment-C5S46NFB.js";import{d as le}from"./lodash-D4AGecfG.js";import{_ as we}from"./SectionMain-Vot1TOkK.js";import{p as Me,q as Ce}from"./@mdi-DWfqH7fj.js";import"./emoji-picker-element-B5_9ws1R.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-YDObI9lJ.js";import"./jspdf-Ciebq7We.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./vue-toastification-ejyjJRED.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./deepmerge-CtOfIP5S.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const je={class:"flex h-[calc(100vh-6rem)] bg-white dark:bg-dark-surface rounded-lg shadow-lg mx-4"},Ee={class:"w-1/3 min-w-[300px] max-w-[400px] border-r dark:border-dark-border flex flex-col"},Be={class:"p-4 border-b dark:border-dark-border bg-gray-50 dark:bg-dark-surface"},He={key:0,class:"absolute z-50 left-0 right-0 mt-2 bg-white dark:bg-dark-modal rounded-xl shadow-xl border dark:border-dark-border max-h-[300px] overflow-y-auto"},Ue=["onClick"],Te=["src","alt"],$e={class:"flex-1 min-w-0"},Se={class:"font-medium dark:text-dark-text truncate"},Ve={class:"text-sm text-gray-500 dark:text-gray-400"},ze={class:"flex-1 overflow-y-auto aside-scrollbars"},Ae={key:0,class:"flex flex-col items-center justify-center h-full p-4"},De={key:1},Fe=["onClick"],Ne={class:"flex items-center space-x-3"},Oe={class:"relative"},Pe=["src","alt"],Re={class:"flex-1 min-w-0"},Ie={class:"flex items-center justify-between"},qe={class:"font-medium dark:text-dark-text"},We={class:"text-xs text-gray-500 dark:text-gray-400"},Ye={class:"flex items-center space-x-2"},Ze={class:"text-sm text-gray-500 dark:text-gray-400 truncate"},Qe={key:0,class:"flex-shrink-0 w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},Je={class:"flex-1 flex flex-col bg-gray-50 dark:bg-dark-bg"},Ge={class:"p-4 bg-white dark:bg-dark-surface border-b dark:border-dark-border"},Ke={class:"flex items-center justify-between"},Xe={class:"flex items-center space-x-3"},et={class:"relative"},tt=["src","alt"],rt={class:"font-medium dark:text-dark-text"},st={class:"text-sm text-gray-500 dark:text-gray-400"},at={key:0,class:"flex justify-center py-2"},ot={key:1,class:"flex justify-center"},lt={key:0},it={key:0,class:"flex-shrink-0 mr-3"},nt=["src"],dt={key:0,class:"mb-2"},ut=["src"],ct=["src"],vt={class:"break-words whitespace-pre-wrap"},mt={class:"p-4 bg-white dark:bg-dark-surface border-t dark:border-dark-border"},ft={key:0,class:"mb-4"},pt={class:"relative inline-block group"},gt=["src"],ht=["src"],kt={class:"flex-1 relative"},xt={class:"absolute right-2 bottom-1/2 transform translate-y-1/2 flex items-center space-x-2"},yt={viewBox:"0 0 24 24",class:"w-5 h-5"},bt=["d"],_t={viewBox:"0 0 24 24",class:"w-5 h-5"},wt=["d"],Mt=["disabled"],Ct={class:"w-6 h-6 block"},Lt={key:0,class:"animate-spin",viewBox:"0 0 24 24"},jt={key:1,viewBox:"0 0 24 24"},Et={key:1,class:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-dark-bg"},Bt={__name:"ChatView",props:{chats:Array},setup(A){const p=A,g=pe(()=>_e().props.auth.user),h=u(""),b=u([]),n=u(null),c=u([]),v=u(""),D=u(null),M=u(!1),T=u(1),$=u(!1),E=u(!1),S=u(!0),_=u(null),m=u(null),C=u(!1),k=u(null),L=u(!1),F=u(null),N=u(null),j=u(!1),ie=r=>{const e=W(r),s=W().startOf("day");return e.isSame(s,"day")?e.format("HH:mm"):e.isSame(s.clone().subtract(1,"day"),"day")?"Hôm qua "+e.format("HH:mm"):e.format("DD/MM/YYYY HH:mm")},ne=le(async()=>{if(!h.value){b.value=[],j.value=!1;return}try{M.value=!0;const r=await U.get(`/api/users/search?q=${h.value}`);b.value=r.data.data.filter(e=>e.id!==g.value.id),j.value=!0}catch(r){console.error("Error searching users:",r)}finally{M.value=!1}},300),O=async(r,e=1,s=!1)=>{try{e===1?M.value=!0:E.value=!0;const i=await U.get(`/chats/${r}/messages`,{params:{page:e,per_page:20}}),{messages:d,has_more:V}=i.data.data;$.value=V;const B=[...d].reverse();s?c.value=[...B,...c.value]:c.value=B,T.value=e,await z(),(S.value||!s)&&(R(!0),S.value=!1),e===1&&J(r)}catch(i){console.error("Error loading messages:",i)}finally{M.value=!1,E.value=!1}},de=async()=>{if(!(!n.value||!v.value.trim()&&!m.value))try{C.value=!0;const r=new FormData;r.append("chat_id",n.value.id),v.value.trim()&&r.append("message",v.value),m.value&&r.append("file",m.value);const e=await U.post("/chats/send",r,{headers:{"Content-Type":"multipart/form-data"}});Array.isArray(c.value)||(c.value=[]);const s=e.data.data;c.value=[...c.value,s],v.value="";const i=p.chats.findIndex(d=>d.id===n.value.id);if(i!==-1){const d={...p.chats[i]};d.messages=[s],p.chats.splice(i,1),p.chats.unshift(d)}await z(),R(!0),m.value=null,k.value=null,_.value&&(_.value.value="")}catch(r){console.error("Error sending message:",r)}finally{C.value=!1}},ue=()=>{m.value=null,k.value=null,_.value&&(_.value.value="")};ge(()=>{n.value&&Z(n.value.id),window.addEventListener("refresh-chat-messages",Y),document.addEventListener("click",K),document.addEventListener("click",I)}),X(()=>{P()});const P=()=>{var r;(r=n.value)!=null&&r.id&&Echo.leave(`chat.${n.value.id}`),window.removeEventListener("refresh-chat-messages",Y),document.removeEventListener("click",K),document.removeEventListener("click",I),h.value="",T.value=1,$.value=!1,E.value=!1,S.value=!0,M.value=!1,C.value=!1,L.value=!1,v.value="",n.value=null,c.value=[],b.value=[],m.value=null,k.value&&(URL.revokeObjectURL(k.value),k.value=null),_.value&&(_.value.value=""),document.removeEventListener("click",I),j.value=!1};ee(()=>n.value,(r,e)=>{e!=null&&e.id&&Echo.leave(`chat.${e.id}`),r!=null&&r.id&&Z(r.id)},{deep:!0}),he(()=>{P()}),X(()=>{P()});const Y=r=>{var e;((e=n.value)==null?void 0:e.id)===r.detail.chatId&&O(n.value.id,1)},Z=r=>{Echo.private(`chat.${r}`).listen("NewMessage",e=>{if(!c.value.some(i=>i.id===e.message.id)){c.value=[...c.value,e.message];const i=p.chats.findIndex(d=>d.id===r);if(i!==-1){const d={...p.chats[i]};d.messages=[e.message],p.chats.splice(i,1),p.chats.unshift(d)}z(()=>{R(!0),e.message.sender_id!==g.value.id&&J(r)})}})};ee(h,ne);const Q=async r=>{n.value=r,c.value=[],T.value=1,$.value=!1,S.value=!0,await O(r.id,1)},y=r=>r.user_id===g.value.id?r.staff:r.user,R=(r=!1)=>{if(D.value){const e=D.value,s=e.scrollHeight-e.scrollTop-e.clientHeight<100;(r||s)&&z(()=>{e.scrollTop=e.scrollHeight})}},ce=r=>r.messages&&r.messages.length>0&&r.messages.some(e=>!e.is_read&&e.sender_id!==g.value.id),J=async r=>{try{await U.post(`/chats/${r}/mark-as-read`)}catch(e){console.error("Error marking messages as read:",e)}},ve=r=>{if(!r)return"";try{return W(r).format("HH:mm")}catch(e){return console.error("Error formatting date:",e),""}},G=le(async r=>{const e=r.target;if(e.scrollTop<=100&&$.value&&!E.value){const s=T.value+1,i=e.scrollHeight;await O(n.value.id,s,!0);const d=e.scrollHeight;e.scrollTop=d-i}},200),me=r=>{const e=r.detail.unicode;v.value+=e,L.value=!1},K=r=>{F.value&&!F.value.contains(r.target)&&(L.value=!1)},fe=async r=>{try{const e=await U.post("/chats/",{user_id:r});p.chats.unshift(e.data.data),await Q(e.data.data),h.value="",b.value=[]}catch(e){console.error("Error creating chat:",e)}},I=r=>{N.value&&!N.value.contains(r.target)&&(j.value=!1,h.value="",b.value=[])};return(r,e)=>(o(),ke(ye,null,{default:te(()=>[re(a(be),{title:"Chats"}),re(we,null,{default:te(()=>[t("div",je,[t("div",Ee,[t("div",Be,[t("div",{class:"relative",ref_key:"searchContainer",ref:N},[se(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>oe(h)?h.value=s:null),type:"text",placeholder:"Tìm kiếm người dùng...",onFocus:e[1]||(e[1]=s=>j.value=!0),class:"w-full px-4 py-3 pl-10 rounded-full border bg-white dark:bg-dark-modal dark:border-dark-border dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 transition-all"},null,544),[[ae,a(h)]]),e[7]||(e[7]=t("span",{class:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})])],-1)),a(j)&&a(b).length>0?(o(),l("div",He,[(o(!0),l(H,null,q(a(b),s=>(o(),l("div",{key:s.id,onClick:i=>fe(s.id),class:"p-3 flex items-center space-x-3 hover:bg-gray-50 dark:hover:bg-dark-hover cursor-pointer first:rounded-t-xl last:rounded-b-xl border-b last:border-0 dark:border-dark-border transition-colors duration-200"},[t("img",{src:s.avatar_url,alt:s.full_name,class:"w-10 h-10 rounded-full object-cover border-2 border-gray-200 dark:border-dark-border"},null,8,Te),t("div",$e,[t("div",Se,x(s.full_name),1),t("div",Ve,x(s.phone_number),1)]),e[6]||(e[6]=t("div",{class:"text-gray-400 dark:text-gray-500"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})])],-1))],8,Ue))),128))])):f("",!0)],512)]),t("div",ze,[A.chats.length===0?(o(),l("div",Ae,e[8]||(e[8]=[t("svg",{class:"w-16 h-16 text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),t("p",{class:"text-gray-500 dark:text-gray-400"},"Chưa có cuộc trò chuyện nào",-1)]))):(o(),l("div",De,[(o(!0),l(H,null,q(A.chats,s=>{var i,d,V,B;return o(),l("div",{key:s.id,onClick:Ht=>Q(s),class:w(["p-4 hover:bg-gray-50 dark:hover:bg-dark-hover cursor-pointer transition-all duration-200",((i=a(n))==null?void 0:i.id)===s.id?"bg-primary-50 dark:bg-primary-900/20":""])},[t("div",Ne,[t("div",Oe,[t("img",{src:y(s).avatar||"storage/images/users/default.png",alt:y(s).full_name,class:w(["w-12 h-12 rounded-full object-cover ring-2 ring-offset-2 dark:ring-offset-dark-surface",[((d=a(n))==null?void 0:d.id)===s.id?"ring-primary-500":"ring-transparent"]])},null,10,Pe),e[9]||(e[9]=t("span",{class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-dark-surface rounded-full"},null,-1))]),t("div",Re,[t("div",Ie,[t("span",qe,x(y(s).full_name),1),t("span",We,x(ve((B=(V=s.messages)==null?void 0:V[0])==null?void 0:B.created_at)),1)]),t("div",Ye,[t("p",Ze,x(s.messages&&s.messages.length>0?s.messages[0].message:"Bắt đầu cuộc trò chuyện"),1),ce(s)?(o(),l("div",Qe,e[10]||(e[10]=[t("span",{class:"text-xs text-white"},"1",-1)]))):f("",!0)])])])],10,Fe)}),128))]))])]),t("div",Je,[a(n)?(o(),l(H,{key:0},[t("div",Ge,[t("div",Ke,[t("div",Xe,[t("div",et,[t("img",{src:y(a(n)).avatar||"storage/images/users/default.png",alt:y(a(n)).full_name,class:"w-10 h-10 rounded-full object-cover"},null,8,tt)]),t("div",null,[t("div",rt,x(y(a(n)).full_name),1),t("div",st,x(y(a(n)).phone_number),1)])]),e[11]||(e[11]=t("div",{class:"flex items-center space-x-3"},[t("button",{class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})])])],-1))])]),t("div",{ref_key:"messageContainer",ref:D,class:"flex-1 overflow-y-auto p-4 space-y-4 aside-scrollbars",onScroll:e[2]||(e[2]=(...s)=>a(G)&&a(G)(...s))},[a(E)?(o(),l("div",at,e[12]||(e[12]=[t("div",{class:"w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full animate-spin"},null,-1)]))):f("",!0),a(M)?(o(),l("div",ot,e[13]||(e[13]=[t("div",{class:"w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"},null,-1)]))):(o(),l(H,{key:2},[a(c)&&a(c).length>0?(o(),l("div",lt,[(o(!0),l(H,null,q(a(c),s=>{var i,d;return o(),l("div",{key:s.id,class:w(["flex mb-4",s.sender_id===g.value.id?"justify-end":"justify-start"])},[s.sender_id!==g.value.id?(o(),l("div",it,[t("img",{src:y(a(n)).avatar||"storage/images/users/default.png",class:"w-8 h-8 rounded-full"},null,8,nt)])):f("",!0),t("div",{class:w(["max-w-[70%]",s.sender_id===g.value.id?"order-1":"order-2"])},[t("div",{class:w(["px-4 py-2 rounded-2xl",s.sender_id===g.value.id?"bg-primary-500 text-white rounded-br-none":"bg-white dark:bg-dark-surface dark:text-dark-text rounded-bl-none"])},[s.file_url?(o(),l("div",dt,[(i=s.file_type)!=null&&i.startsWith("image/")?(o(),l("img",{key:0,src:s.file_url,class:"rounded-lg max-w-full max-h-[300px] object-contain",alt:"Uploaded image"},null,8,ut)):(d=s.file_type)!=null&&d.startsWith("video/")?(o(),l("video",{key:1,src:s.file_url,class:"rounded-lg max-w-full max-h-[300px]",controls:""},null,8,ct)):f("",!0)])):f("",!0),t("div",vt,x(s.message),1)],2),t("div",{class:w(["mt-1 text-xs",[s.sender_id===g.value.id?"text-right text-gray-500 dark:text-gray-400":"text-left text-gray-500 dark:text-gray-400"]])},x(ie(s.created_at)),3)],2)],2)}),128))])):f("",!0)],64))],544),t("div",mt,[a(m)?(o(),l("div",ft,[t("div",pt,[a(k)&&a(m).type.startsWith("image/")?(o(),l("img",{key:0,src:a(k),class:"max-h-[200px] rounded-lg border dark:border-dark-border",alt:"Preview"},null,8,gt)):a(k)&&a(m).type.startsWith("video/")?(o(),l("video",{key:1,src:a(k),class:"max-h-[200px] rounded-lg border dark:border-dark-border",controls:""},null,8,ht)):f("",!0),t("button",{onClick:ue,class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition-colors shadow-lg"},e[14]||(e[14]=[t("span",{class:"w-4 h-4 block"},[t("svg",{viewBox:"0 0 24 24",class:"w-full h-full"},[t("path",{fill:"currentColor",d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})])],-1)]))])])):f("",!0),t("form",{onSubmit:xe(de,["prevent"]),class:"flex items-end space-x-3"},[t("div",kt,[se(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>oe(v)?v.value=s:null),type:"text",placeholder:"Nhập tin nhắn...",class:"w-full px-4 py-3 pr-24 border rounded-full dark:bg-dark-modal dark:border-dark-border dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 transition-all"},null,512),[[ae,a(v)]]),t("div",xt,[t("div",{class:"relative",ref_key:"emojiPickerContainer",ref:F},[t("button",{type:"button",onClick:e[4]||(e[4]=s=>L.value=!a(L)),class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[(o(),l("svg",yt,[t("path",{fill:"currentColor",d:a(Me)},null,8,bt)]))]),a(L)?(o(),l("emoji-picker",{key:0,class:"absolute bottom-full right-0 mb-2",onEmojiClick:me},null,32)):f("",!0)],512),t("button",{type:"button",onClick:e[5]||(e[5]=()=>_.value.click()),class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[(o(),l("svg",_t,[t("path",{fill:"currentColor",d:a(Ce)},null,8,wt)]))])])]),t("button",{type:"submit",disabled:!a(v).trim()&&!a(m)||a(C),class:w(["p-3 rounded-full transition-all duration-200 flex items-center justify-center min-w-[3rem] disabled:opacity-50",[(a(v).trim()||a(m))&&!a(C)?"bg-primary-500 hover:bg-primary-600 text-white shadow-lg":"bg-gray-200 dark:bg-dark-modal text-gray-500 dark:text-gray-400 cursor-not-allowed"]])},[t("span",Ct,[a(C)?(o(),l("svg",Lt,e[15]||(e[15]=[t("path",{fill:"currentColor",d:"M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"},null,-1)]))):(o(),l("svg",jt,e[16]||(e[16]=[t("path",{fill:"currentColor",d:"M2,21L23,12L2,3V10L17,12L2,14V21Z"},null,-1)])))])],10,Mt)],32)])],64)):(o(),l("div",Et,e[17]||(e[17]=[t("div",{class:"text-center space-y-4"},[t("div",{class:"w-20 h-20 mx-auto bg-gray-200 dark:bg-dark-modal rounded-full flex items-center justify-center"},[t("svg",{class:"w-10 h-10 text-gray-500 dark:text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})])]),t("div",{class:"space-y-2"},[t("p",{class:"text-xl font-medium dark:text-dark-text"},"Chào mừng đến với tin nhắn"),t("p",{class:"text-gray-500 dark:text-gray-400"},"Chọn một cuộc trò chuyện để bắt đầu")])],-1)])))])])]),_:1})]),_:1}))}},br=Le(Bt,[["__scopeId","data-v-edc5547d"]]);export{br as default};

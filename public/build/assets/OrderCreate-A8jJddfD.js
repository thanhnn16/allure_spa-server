import{Z as z,F as C}from"./@inertiajs-D0DMCEQB.js";import{_ as j}from"./SectionMain-Vot1TOkK.js";import{L as J}from"./LayoutAuthenticated-D078pk3d.js";import{r as U,c as X,e as D,b2 as M,aU as l,a0 as Z,bH as E,aa as B,a3 as r,bM as Q,bJ as g,bA as T,a2 as c,F as k,b0 as f,bf as u,a9 as V,a1 as I,bz as S}from"./@vue-BRgAy5zV.js";import{a as x}from"./axios-CCb-kr4I.js";import{l as W}from"./lodash-D4AGecfG.js";import{u as Y}from"./vue-toastification-ejyjJRED.js";import{_ as $}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-ArhfA4cU.js";import"./app-B23a1NkA.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const ee={components:{Head:z,SectionMain:j,LayoutAuthenticated:J},props:{vouchers:Array,paymentMethods:Array},setup(P){const e=Y(),d=U({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),a=U(""),p=U([]),N=U(null),R=W.debounce(async()=>{if(a.value.length<2){p.value=[];return}try{const o=await x.get("/api/users/search",{params:{query:a.value}});p.value=o.data.data}catch(o){console.error("Search error:",o),p.value=[]}},300),F=o=>{d.value.user_id=o.id,N.value=o,a.value=o.full_name,p.value=[]},L=()=>{d.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},t=o=>{d.value.order_items.splice(o,1)},b=async o=>{const s=d.value.order_items[o];if(s.search.length<2){s.searchResults=[];return}try{const n=s.item_type==="product"?"/api/products/search":"/api/services/search",m=await x.get(n,{params:{query:s.search}});s.searchResults=m.data.data.map(h=>({...h,item_type:s.item_type}))}catch(n){console.error("Error searching items:",n),s.searchResults=[]}},i=(o,s)=>{const n=d.value.order_items[o];n.selectedItem=s,n.item_id=s.id,n.search=s.name||s.service_name,s.item_type==="service"?_(n):n.price=Number(s.price),n.searchResults=[],O()},y=()=>d.value.order_items.reduce((o,s)=>o+s.quantity*s.price,0),v=()=>{if(!d.value.voucher_id)return 0;const o=P.vouchers.find(n=>n.id===d.value.voucher_id);if(!o)return 0;const s=y();return o.discount_type==="percentage"?s*(o.discount_value/100):o.discount_value},q=()=>Math.max(0,y()-v()),O=()=>{d.value.total_amount=q(),d.value.discount_amount=v()},H=async()=>{var o,s,n;try{if(console.log("Bắt đầu submit form với dữ liệu:",d.value),!d.value.user_id){e.error("Vui lòng chọn khách hàng");return}if(d.value.order_items.length===0){e.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}d.value.total_amount=y(),d.value.discount_amount=v(),console.log("Tổng tiền đã tính:",{total:d.value.total_amount,discount:d.value.discount_amount}),console.log("Gọi API tạo đơn hàng");const m=await x.post("/api/orders",d.value);console.log("Response tạo đơn hàng:",m.data);const h=m.data.data;d.value.payment_method_id===3?(console.log("Phương thức thanh toán PayOS được chọn"),await A(h)):(console.log("Chuyển hướng đến trang chi tiết đơn hàng"),C.visit(`/orders/${h.id}`))}catch(m){console.error("Chi tiết lỗi tạo đơn hàng:",{message:m.message,response:(o=m.response)==null?void 0:o.data,stack:m.stack}),e.error(((n=(s=m.response)==null?void 0:s.data)==null?void 0:n.message)||"Có lỗi xảy ra khi tạo đơn hàng")}},G=o=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(o),K=X(()=>["pending","confirmed","shipping","delivered"].includes(P.order.status));D(()=>d.value.order_items,o=>{o.forEach(s=>{s.selectedItem&&s.item_type==="service"&&_(s)})},{deep:!0});const _=o=>{if(o.selectedItem){switch(o.service_type){case"combo_5":o.price=Number(o.selectedItem.combo_5_price||0);break;case"combo_10":o.price=Number(o.selectedItem.combo_10_price||0);break;default:o.price=Number(o.selectedItem.single_price||0);break}O()}};D(()=>d.value.order_items.map(o=>o.service_type),()=>{d.value.order_items.forEach(o=>{o.item_type==="service"&&o.selectedItem&&_(o)})},{deep:!0});const A=async o=>{var s,n;try{const m=`${window.location.origin}/payment/callback`,h=`${window.location.origin}/payment/callback?status=cancel`,w=await x.post(`/api/orders/${o.id}/payment-link`,{returnUrl:m,cancelUrl:h});if(w.data.success&&w.data.data.checkoutUrl)window.location.href=w.data.data.checkoutUrl;else throw new Error(w.data.message||"Không thể tạo link thanh toán")}catch(m){e.error("Lỗi xử lý thanh toán: "+(((n=(s=m.response)==null?void 0:s.data)==null?void 0:n.message)||m.message)),C.visit(`/orders/${o.id}`)}};return{form:d,userSearch:a,userResults:p,selectedUser:N,searchUsers:R,selectUser:F,addOrderItem:L,removeOrderItem:t,searchItems:b,selectItem:i,calculateTotal:y,calculateDiscount:v,calculateFinalTotal:q,formatCurrency:G,submitForm:H,canUpdateStatus:K,updateServicePrice:_,handlePayOSPayment:A,handlePaymentCallback:async()=>{const s=new URLSearchParams(window.location.search).get("orderCode");if(!s){e.error("Thiếu thông tin đơn hàng");return}try{const n=await x.post("/api/payment/verify",{orderCode:s});n.data.success?(e.success("Thanh toán thành công"),C.visit(`/orders/${n.data.data.order_id}`)):(e.error("Thanh toán thất bại"),C.visit("/orders"))}catch(n){console.error("Payment verification error:",n),e.error("Lỗi xác thực thanh toán")}}}}},re={class:"container mx-auto px-4 py-8"},te={class:"mb-4"},oe={class:"relative"},ae={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border"},se=["onClick"],de={class:"font-medium text-gray-900 dark:text-dark-text"},ne={class:"text-sm text-gray-500 dark:text-dark-text-muted"},ie={key:0,class:"ml-2"},le={class:"grid grid-cols-2 gap-4"},ce=["onUpdate:modelValue","onChange"],me={key:0},ue=["onUpdate:modelValue"],be={class:"mt-4"},ge=["onUpdate:modelValue","onInput","placeholder"],pe={key:0,class:"mt-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto focus:outline-none sm:text-sm"},he=["onClick"],ye={class:"flex flex-col"},ke={class:"font-medium text-gray-900 dark:text-dark-text"},fe={key:0,class:"text-sm text-gray-600 dark:text-dark-text-muted"},xe={key:1,class:"text-sm text-gray-600 dark:text-dark-text-muted"},ve={class:"mt-4 grid grid-cols-3 gap-4"},_e=["onUpdate:modelValue"],we=["value"],Ce=["value"],Ue=["onClick"],Te=["value"],Ve=["value"],Ie={class:"flex justify-between items-center"},Se={class:"text-right"},Pe={class:"text-sm text-gray-600 dark:text-gray-400"},Ne={class:"text-sm text-red-600 dark:text-red-400"},Re={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"};function Fe(P,e,d,a,p,N){const R=M("Head"),F=M("SectionMain"),L=M("LayoutAuthenticated");return l(),Z(L,null,{default:E(()=>[B(R,{title:"Tạo đơn hàng mới"}),B(F,null,{default:E(()=>[r("div",re,[e[24]||(e[24]=r("h1",{class:"text-3xl font-bold mb-6 text-gray-900 dark:text-dark-text"},"Tạo đơn hàng mới",-1)),r("form",{onSubmit:e[6]||(e[6]=Q((...t)=>a.submitForm&&a.submitForm(...t),["prevent"])),class:"space-y-6"},[r("div",te,[e[7]||(e[7]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1"}," Khách hàng ",-1)),r("div",oe,[g(r("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.userSearch=t),onInput:e[1]||(e[1]=(...t)=>a.searchUsers&&a.searchUsers(...t)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"},null,544),[[T,a.userSearch]]),a.userResults.length>0?(l(),c("div",ae,[(l(!0),c(k,null,f(a.userResults,t=>(l(),c("div",{key:t.id,onClick:b=>a.selectUser(t),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface-hover cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[r("div",de,u(t.full_name),1),r("div",ne,[V(" SĐT: "+u(t.phone_number)+" ",1),t.email?(l(),c("span",ie,"Email: "+u(t.email),1)):I("",!0)])],8,se))),128))])):I("",!0)])]),r("div",null,[e[18]||(e[18]=r("h3",{class:"text-lg font-medium text-gray-900 dark:text-dark-text mb-2"},"Sản phẩm/Dịch vụ",-1)),r("button",{type:"button",onClick:e[2]||(e[2]=(...t)=>a.addOrderItem&&a.addOrderItem(...t)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg"}," Thêm sản phẩm/dịch vụ "),(l(!0),c(k,null,f(a.form.order_items,(t,b)=>(l(),c("div",{key:b,class:"mb-4 p-4 border rounded-md border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface"},[r("div",le,[r("div",null,[e[9]||(e[9]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),g(r("select",{"onUpdate:modelValue":i=>t.item_type=i,onChange:i=>a.searchItems(b),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[8]||(e[8]=[r("option",{value:"product"},"Sản phẩm",-1),r("option",{value:"service"},"Dịch vụ",-1)]),40,ce),[[S,t.item_type]])]),t.item_type==="service"?(l(),c("div",me,[e[11]||(e[11]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),g(r("select",{"onUpdate:modelValue":i=>t.service_type=i,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[10]||(e[10]=[r("option",{value:"single"},"Đơn lẻ",-1),r("option",{value:"combo_5"},"Combo 5",-1),r("option",{value:"combo_10"},"Combo 10",-1)]),8,ue),[[S,t.service_type]])])):I("",!0)]),r("div",be,[e[14]||(e[14]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),g(r("input",{type:"text","onUpdate:modelValue":i=>t.search=i,onInput:i=>a.searchItems(b),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:t.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ge),[[T,t.search]]),t.searchResults.length>0?(l(),c("ul",pe,[(l(!0),c(k,null,f(t.searchResults,i=>(l(),c("li",{key:i.id,onClick:y=>a.selectItem(b,i),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-primary-50 dark:hover:bg-dark-surface-hover"},[r("div",ye,[r("span",ke,u(i.name||i.service_name),1),i.item_type==="service"?(l(),c("span",fe,[V(" Đơn lẻ: "+u(a.formatCurrency(i.single_price))+" ",1),e[12]||(e[12]=r("br",null,null,-1)),V(" Combo 5: "+u(a.formatCurrency(i.combo_5_price))+" ",1),e[13]||(e[13]=r("br",null,null,-1)),V(" Combo 10: "+u(a.formatCurrency(i.combo_10_price)),1)])):(l(),c("span",xe,u(a.formatCurrency(i.price)),1))])],8,he))),128))])):I("",!0)]),r("div",ve,[r("div",null,[e[15]||(e[15]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Số lượng:",-1)),g(r("input",{"onUpdate:modelValue":i=>t.quantity=i,type:"number",min:"1",class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-dark-border rounded-md dark:bg-dark-surface dark:text-dark-text"},null,8,_e),[[T,t.quantity,void 0,{number:!0}]])]),r("div",null,[e[16]||(e[16]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Đơn giá:",-1)),r("input",{value:a.formatCurrency(t.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,we)]),r("div",null,[e[17]||(e[17]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Thành tiền:",-1)),r("input",{value:a.formatCurrency(t.quantity*t.price),class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ce)])]),r("button",{type:"button",onClick:i=>a.removeOrderItem(b),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,Ue)]))),128))]),r("div",null,[e[20]||(e[20]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),g(r("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.form.voucher_id=t),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[e[19]||(e[19]=r("option",{value:""},"Không áp dụng",-1)),(l(!0),c(k,null,f(d.vouchers,t=>(l(),c("option",{key:t.id,value:t.id},u(t.code)+" - "+u(t.discount_type==="percentage"?`${t.discount_value}%`:a.formatCurrency(t.discount_value)),9,Te))),128))],512),[[S,a.form.voucher_id]])]),r("div",null,[e[21]||(e[21]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),g(r("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.form.payment_method_id=t),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(l(!0),c(k,null,f(d.paymentMethods,t=>(l(),c("option",{key:t.id,value:t.id},u(t.method_name),9,Ve))),128))],512),[[S,a.form.payment_method_id]])]),r("div",null,[e[22]||(e[22]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),g(r("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.form.note=t),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[T,a.form.note]])]),r("div",Ie,[e[23]||(e[23]=r("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Tạo đơn hàng và hóa đơn ",-1)),r("div",Se,[r("p",Pe,"Tổng tiền: "+u(a.formatCurrency(a.calculateTotal())),1),r("p",Ne,"Giảm giá: -"+u(a.formatCurrency(a.calculateDiscount())),1),r("p",Re,"Thành tiền: "+u(a.formatCurrency(a.calculateFinalTotal())),1)])])],32)])]),_:1})]),_:1})}const wr=$(ee,[["render",Fe],["__scopeId","data-v-97d9b8a1"]]);export{wr as default};

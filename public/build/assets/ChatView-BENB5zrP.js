import{c as ce,r as u,o as me,b as Z,e as Q,aL as ve,n as T,aU as o,a0 as fe,bH as J,aa as G,bl as a,a3 as t,bJ as K,bA as X,q as ee,a2 as l,F as V,b0 as te,j as b,bf as _,a1 as g,bM as pe}from"./@vue-BRgAy5zV.js";import{L as ge}from"./LayoutAuthenticated-CjOjFKI3.js";import{Z as he,Q as ke}from"./@inertiajs-D0DMCEQB.js";import{a as $}from"./axios-CCb-kr4I.js";import{h as I}from"./moment-C5S46NFB.js";import{d as se}from"./lodash-D4AGecfG.js";import{_ as xe}from"./SectionMain-Vot1TOkK.js";import{p as ye,q as be}from"./@mdi-ArhfA4cU.js";import"./emoji-picker-element-B5_9ws1R.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-B6OIabzy.js";import"./jspdf-Ciebq7We.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./vue-toastification-ejyjJRED.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./deepmerge-CtOfIP5S.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const we={class:"flex h-[calc(100vh-6rem)] bg-white dark:bg-dark-surface rounded-lg shadow-lg mx-4"},Me={class:"w-1/3 min-w-[300px] max-w-[400px] border-r dark:border-dark-border flex flex-col"},Le={class:"p-4 border-b dark:border-dark-border bg-gray-50 dark:bg-dark-surface"},je={class:"relative"},Ce={class:"flex-1 overflow-y-auto aside-scrollbars"},Ee={key:0,class:"flex flex-col items-center justify-center h-full p-4"},He={key:1},Be=["onClick"],Ue={class:"flex items-center space-x-3"},Te={class:"relative"},Ve=["src","alt"],$e={class:"flex-1 min-w-0"},Ae={class:"flex items-center justify-between"},De={class:"font-medium dark:text-dark-text"},Se={class:"text-xs text-gray-500 dark:text-gray-400"},ze={class:"flex items-center space-x-2"},Fe={class:"text-sm text-gray-500 dark:text-gray-400 truncate"},Ne={key:0,class:"flex-shrink-0 w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center"},Pe={class:"flex-1 flex flex-col bg-gray-50 dark:bg-dark-bg"},Ie={class:"p-4 bg-white dark:bg-dark-surface border-b dark:border-dark-border"},Oe={class:"flex items-center justify-between"},Re={class:"flex items-center space-x-3"},qe={class:"relative"},We=["src","alt"],Ye={class:"font-medium dark:text-dark-text"},Ze={class:"text-sm text-gray-500 dark:text-gray-400"},Qe={key:0,class:"flex justify-center py-2"},Je={key:1,class:"flex justify-center"},Ge={key:0},Ke={key:0,class:"flex-shrink-0 mr-3"},Xe=["src"],et={key:0,class:"mb-2"},tt=["src"],st=["src"],rt={class:"break-words whitespace-pre-wrap"},at={class:"p-4 bg-white dark:bg-dark-surface border-t dark:border-dark-border"},ot={key:0,class:"mb-4"},lt={class:"relative inline-block group"},it=["src"],nt=["src"],dt={class:"flex-1 relative"},ut={class:"absolute right-2 bottom-1/2 transform translate-y-1/2 flex items-center space-x-2"},ct={viewBox:"0 0 24 24",class:"w-5 h-5"},mt=["d"],vt={viewBox:"0 0 24 24",class:"w-5 h-5"},ft=["d"],pt=["disabled"],gt={class:"w-6 h-6 block"},ht={key:0,class:"animate-spin",viewBox:"0 0 24 24"},kt={key:1,viewBox:"0 0 24 24"},xt={key:1,class:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-dark-bg"},yt={__name:"ChatView",props:{chats:Array},setup(A){const h=A,f=ce(()=>ke().props.auth.user),x=u(""),D=u([]),i=u(null),c=u([]),m=u(""),S=u(null),w=u(!1),E=u(1),H=u(!1),j=u(!1),B=u(!0),y=u(null),v=u(null),M=u(!1),p=u(null),L=u(!1),z=u(null),re=s=>{const e=I(s),r=I().startOf("day");return e.isSame(r,"day")?e.format("HH:mm"):e.isSame(r.clone().subtract(1,"day"),"day")?"Hôm qua "+e.format("HH:mm"):e.format("DD/MM/YYYY HH:mm")},ae=se(async()=>{if(!x.value){D.value=[];return}try{w.value=!0;const s=await $.get(`/api/users/search?q=${x.value}`);D.value=s.data.data.filter(e=>e.id!==f.value.id)}catch(s){console.error("Error searching users:",s)}finally{w.value=!1}},300),F=async(s,e=1,r=!1)=>{try{e===1?w.value=!0:j.value=!0;const n=await $.get(`/chats/${s}/messages`,{params:{page:e,per_page:20}}),{messages:d,has_more:U}=n.data.data;H.value=U;const C=[...d].reverse();r?c.value=[...C,...c.value]:c.value=C,E.value=e,await T(),(B.value||!r)&&(P(!0),B.value=!1),e===1&&q(s)}catch(n){console.error("Error loading messages:",n)}finally{w.value=!1,j.value=!1}},oe=async()=>{if(!(!i.value||!m.value.trim()&&!v.value))try{M.value=!0;const s=new FormData;s.append("chat_id",i.value.id),m.value.trim()&&s.append("message",m.value),v.value&&s.append("file",v.value);const e=await $.post("/chats/send",s,{headers:{"Content-Type":"multipart/form-data"}});Array.isArray(c.value)||(c.value=[]);const r=e.data.data;c.value=[...c.value,r],m.value="";const n=h.chats.findIndex(d=>d.id===i.value.id);if(n!==-1){const d={...h.chats[n]};d.messages=[r],h.chats.splice(n,1),h.chats.unshift(d)}await T(),P(!0),v.value=null,p.value=null,y.value&&(y.value.value="")}catch(s){console.error("Error sending message:",s)}finally{M.value=!1}},le=()=>{v.value=null,p.value=null,y.value&&(y.value.value="")};me(()=>{i.value&&R(i.value.id),window.addEventListener("refresh-chat-messages",O),document.addEventListener("click",Y)}),Z(()=>{N()});const N=()=>{var s;(s=i.value)!=null&&s.id&&Echo.leave(`chat.${i.value.id}`),window.removeEventListener("refresh-chat-messages",O),document.removeEventListener("click",Y),x.value="",E.value=1,H.value=!1,j.value=!1,B.value=!0,w.value=!1,M.value=!1,L.value=!1,m.value="",i.value=null,c.value=[],D.value=[],v.value=null,p.value&&(URL.revokeObjectURL(p.value),p.value=null),y.value&&(y.value.value="")};Q(()=>i.value,(s,e)=>{e!=null&&e.id&&Echo.leave(`chat.${e.id}`),s!=null&&s.id&&R(s.id)},{deep:!0}),ve(()=>{N()}),Z(()=>{N()});const O=s=>{var e;((e=i.value)==null?void 0:e.id)===s.detail.chatId&&F(i.value.id,1)},R=s=>{Echo.private(`chat.${s}`).listen("NewMessage",e=>{if(!c.value.some(n=>n.id===e.message.id)){c.value=[...c.value,e.message];const n=h.chats.findIndex(d=>d.id===s);if(n!==-1){const d={...h.chats[n]};d.messages=[e.message],h.chats.splice(n,1),h.chats.unshift(d)}T(()=>{P(!0),e.message.sender_id!==f.value.id&&q(s)})}})};Q(x,ae);const ie=async s=>{i.value=s,c.value=[],E.value=1,H.value=!1,B.value=!0,await F(s.id,1)},k=s=>s.user_id===f.value.id?s.staff:s.user,P=(s=!1)=>{if(S.value){const e=S.value,r=e.scrollHeight-e.scrollTop-e.clientHeight<100;(s||r)&&T(()=>{e.scrollTop=e.scrollHeight})}},ne=s=>s.messages&&s.messages.length>0&&s.messages.some(e=>!e.is_read&&e.sender_id!==f.value.id),q=async s=>{try{await $.post(`/chats/${s}/mark-as-read`)}catch(e){console.error("Error marking messages as read:",e)}},de=s=>{if(!s)return"";try{return I(s).format("HH:mm")}catch(e){return console.error("Error formatting date:",e),""}},W=se(async s=>{const e=s.target;if(e.scrollTop<=100&&H.value&&!j.value){const r=E.value+1,n=e.scrollHeight;await F(i.value.id,r,!0);const d=e.scrollHeight;e.scrollTop=d-n}},200),ue=s=>{const e=s.detail.unicode;m.value+=e,L.value=!1},Y=s=>{z.value&&!z.value.contains(s.target)&&(L.value=!1)};return(s,e)=>(o(),fe(ge,null,{default:J(()=>[G(a(he),{title:"Chats"}),G(xe,null,{default:J(()=>[t("div",we,[t("div",Me,[t("div",Le,[t("div",je,[K(t("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>ee(x)?x.value=r:null),type:"text",placeholder:"Tìm kiếm người dùng...",class:"w-full px-4 py-3 pl-10 rounded-full border bg-white dark:bg-dark-modal dark:border-dark-border dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 transition-all"},null,512),[[X,a(x)]]),e[5]||(e[5]=t("span",{class:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})])],-1))])]),t("div",Ce,[A.chats.length===0?(o(),l("div",Ee,e[6]||(e[6]=[t("svg",{class:"w-16 h-16 text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),t("p",{class:"text-gray-500 dark:text-gray-400"},"Chưa có cuộc trò chuyện nào",-1)]))):(o(),l("div",He,[(o(!0),l(V,null,te(A.chats,r=>{var n,d,U,C;return o(),l("div",{key:r.id,onClick:bt=>ie(r),class:b(["p-4 hover:bg-gray-50 dark:hover:bg-dark-hover cursor-pointer transition-all duration-200",((n=a(i))==null?void 0:n.id)===r.id?"bg-primary-50 dark:bg-primary-900/20":""])},[t("div",Ue,[t("div",Te,[t("img",{src:k(r).avatar||"storage/images/users/default.png",alt:k(r).full_name,class:b(["w-12 h-12 rounded-full object-cover ring-2 ring-offset-2 dark:ring-offset-dark-surface",[((d=a(i))==null?void 0:d.id)===r.id?"ring-primary-500":"ring-transparent"]])},null,10,Ve),e[7]||(e[7]=t("span",{class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-dark-surface rounded-full"},null,-1))]),t("div",$e,[t("div",Ae,[t("span",De,_(k(r).full_name),1),t("span",Se,_(de((C=(U=r.messages)==null?void 0:U[0])==null?void 0:C.created_at)),1)]),t("div",ze,[t("p",Fe,_(r.messages&&r.messages.length>0?r.messages[0].message:"Bắt đầu cuộc trò chuyện"),1),ne(r)?(o(),l("div",Ne,e[8]||(e[8]=[t("span",{class:"text-xs text-white"},"1",-1)]))):g("",!0)])])])],10,Be)}),128))]))])]),t("div",Pe,[a(i)?(o(),l(V,{key:0},[t("div",Ie,[t("div",Oe,[t("div",Re,[t("div",qe,[t("img",{src:k(a(i)).avatar||"storage/images/users/default.png",alt:k(a(i)).full_name,class:"w-10 h-10 rounded-full object-cover"},null,8,We)]),t("div",null,[t("div",Ye,_(k(a(i)).full_name),1),t("div",Ze,_(k(a(i)).phone_number),1)])]),e[9]||(e[9]=t("div",{class:"flex items-center space-x-3"},[t("button",{class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})])])],-1))])]),t("div",{ref_key:"messageContainer",ref:S,class:"flex-1 overflow-y-auto p-4 space-y-4 aside-scrollbars",onScroll:e[1]||(e[1]=(...r)=>a(W)&&a(W)(...r))},[a(j)?(o(),l("div",Qe,e[10]||(e[10]=[t("div",{class:"w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full animate-spin"},null,-1)]))):g("",!0),a(w)?(o(),l("div",Je,e[11]||(e[11]=[t("div",{class:"w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"},null,-1)]))):(o(),l(V,{key:2},[a(c)&&a(c).length>0?(o(),l("div",Ge,[(o(!0),l(V,null,te(a(c),r=>{var n,d;return o(),l("div",{key:r.id,class:b(["flex mb-4",r.sender_id===f.value.id?"justify-end":"justify-start"])},[r.sender_id!==f.value.id?(o(),l("div",Ke,[t("img",{src:k(a(i)).avatar||"storage/images/users/default.png",class:"w-8 h-8 rounded-full"},null,8,Xe)])):g("",!0),t("div",{class:b(["max-w-[70%]",r.sender_id===f.value.id?"order-1":"order-2"])},[t("div",{class:b(["px-4 py-2 rounded-2xl",r.sender_id===f.value.id?"bg-primary-500 text-white rounded-br-none":"bg-white dark:bg-dark-surface dark:text-dark-text rounded-bl-none"])},[r.file_url?(o(),l("div",et,[(n=r.file_type)!=null&&n.startsWith("image/")?(o(),l("img",{key:0,src:r.file_url,class:"rounded-lg max-w-full max-h-[300px] object-contain",alt:"Uploaded image"},null,8,tt)):(d=r.file_type)!=null&&d.startsWith("video/")?(o(),l("video",{key:1,src:r.file_url,class:"rounded-lg max-w-full max-h-[300px]",controls:""},null,8,st)):g("",!0)])):g("",!0),t("div",rt,_(r.message),1)],2),t("div",{class:b(["mt-1 text-xs",[r.sender_id===f.value.id?"text-right text-gray-500 dark:text-gray-400":"text-left text-gray-500 dark:text-gray-400"]])},_(re(r.created_at)),3)],2)],2)}),128))])):g("",!0)],64))],544),t("div",at,[a(v)?(o(),l("div",ot,[t("div",lt,[a(p)&&a(v).type.startsWith("image/")?(o(),l("img",{key:0,src:a(p),class:"max-h-[200px] rounded-lg border dark:border-dark-border",alt:"Preview"},null,8,it)):a(p)&&a(v).type.startsWith("video/")?(o(),l("video",{key:1,src:a(p),class:"max-h-[200px] rounded-lg border dark:border-dark-border",controls:""},null,8,nt)):g("",!0),t("button",{onClick:le,class:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition-colors shadow-lg"},e[12]||(e[12]=[t("span",{class:"w-4 h-4 block"},[t("svg",{viewBox:"0 0 24 24",class:"w-full h-full"},[t("path",{fill:"currentColor",d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})])],-1)]))])])):g("",!0),t("form",{onSubmit:pe(oe,["prevent"]),class:"flex items-end space-x-3"},[t("div",dt,[K(t("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>ee(m)?m.value=r:null),type:"text",placeholder:"Nhập tin nhắn...",class:"w-full px-4 py-3 pr-24 border rounded-full dark:bg-dark-modal dark:border-dark-border dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 transition-all"},null,512),[[X,a(m)]]),t("div",ut,[t("div",{class:"relative",ref_key:"emojiPickerContainer",ref:z},[t("button",{type:"button",onClick:e[3]||(e[3]=r=>L.value=!a(L)),class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[(o(),l("svg",ct,[t("path",{fill:"currentColor",d:a(ye)},null,8,mt)]))]),a(L)?(o(),l("emoji-picker",{key:0,class:"absolute bottom-full right-0 mb-2",onEmojiClick:ue},null,32)):g("",!0)],512),t("button",{type:"button",onClick:e[4]||(e[4]=()=>y.value.click()),class:"p-2 text-gray-500 hover:text-primary-500 dark:text-gray-400 dark:hover:text-primary-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-hover transition-all"},[(o(),l("svg",vt,[t("path",{fill:"currentColor",d:a(be)},null,8,ft)]))])])]),t("button",{type:"submit",disabled:!a(m).trim()&&!a(v)||a(M),class:b(["p-3 rounded-full transition-all duration-200 flex items-center justify-center min-w-[3rem] disabled:opacity-50",[(a(m).trim()||a(v))&&!a(M)?"bg-primary-500 hover:bg-primary-600 text-white shadow-lg":"bg-gray-200 dark:bg-dark-modal text-gray-500 dark:text-gray-400 cursor-not-allowed"]])},[t("span",gt,[a(M)?(o(),l("svg",ht,e[13]||(e[13]=[t("path",{fill:"currentColor",d:"M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"},null,-1)]))):(o(),l("svg",kt,e[14]||(e[14]=[t("path",{fill:"currentColor",d:"M2,21L23,12L2,3V10L17,12L2,14V21Z"},null,-1)])))])],10,pt)],32)])],64)):(o(),l("div",xt,e[15]||(e[15]=[t("div",{class:"text-center space-y-4"},[t("div",{class:"w-20 h-20 mx-auto bg-gray-200 dark:bg-dark-modal rounded-full flex items-center justify-center"},[t("svg",{class:"w-10 h-10 text-gray-500 dark:text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})])]),t("div",{class:"space-y-2"},[t("p",{class:"text-xl font-medium dark:text-dark-text"},"Chào mừng đến với tin nhắn"),t("p",{class:"text-gray-500 dark:text-gray-400"},"Chọn một cuộc trò chuyện để bắt đầu")])],-1)])))])])]),_:1})]),_:1}))}},ms=_e(yt,[["__scopeId","data-v-aba50cad"]]);export{ms as default};

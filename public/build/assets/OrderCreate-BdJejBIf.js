import{Z,F as U}from"./@inertiajs-D0DMCEQB.js";import{_ as Q}from"./SectionMain-Vot1TOkK.js";import{L as W}from"./LayoutAuthenticated-BBAlSYbr.js";import{r as T,c as Y,e as H,b2 as R,aU as l,a0 as $,bH as G,aa as K,a3 as r,bM as ee,bJ as g,bA as V,a2 as c,F as x,b0 as v,bf as m,a9 as I,a1 as S,bz as P}from"./@vue-BRgAy5zV.js";import{a as _}from"./axios-CCb-kr4I.js";import{l as re}from"./lodash-D4AGecfG.js";import{u as te}from"./vue-toastification-ejyjJRED.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-ArhfA4cU.js";import"./app-BdM1Db11.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const ae={components:{Head:Z,SectionMain:Q,LayoutAuthenticated:W},props:{vouchers:Array,paymentMethods:Array},setup(N){const e=te(),d=T({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),a=T(""),y=T([]),L=T(null),q=re.debounce(async()=>{if(a.value.length<2){y.value=[];return}try{const o=await _.get("/api/users/search",{params:{query:a.value}});y.value=o.data.data}catch(o){console.error("Search error:",o),y.value=[]}},300),F=o=>{d.value.user_id=o.id,L.value=o,a.value=o.full_name,y.value=[]},M=()=>{d.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},t=o=>{d.value.order_items.splice(o,1)},b=async o=>{const s=d.value.order_items[o];if(s.search.length<2){s.searchResults=[];return}try{const n=s.item_type==="product"?"/api/products/search":"/api/services/search",u=await _.get(n,{params:{query:s.search}});s.searchResults=u.data.data.map(p=>({...p,item_type:s.item_type}))}catch(n){console.error("Error searching items:",n),s.searchResults=[]}},i=(o,s)=>{const n=d.value.order_items[o];n.selectedItem=s,n.item_id=s.id,n.search=s.name||s.service_name,s.item_type==="service"?C(n):n.price=Number(s.price),n.searchResults=[],A()},f=()=>d.value.order_items.reduce((o,s)=>o+s.quantity*s.price,0),w=()=>{if(!d.value.voucher_id)return 0;const o=N.vouchers.find(n=>n.id===d.value.voucher_id);if(!o)return 0;const s=f();return o.discount_type==="percentage"?s*(o.discount_value/100):o.discount_value},O=()=>Math.max(0,f()-w()),A=()=>{d.value.total_amount=O(),d.value.discount_amount=w()},z=async()=>{var o,s,n;try{if(console.log("Bắt đầu submit form với dữ liệu:",d.value),!d.value.user_id){e.error("Vui lòng chọn khách hàng");return}if(d.value.order_items.length===0){e.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}d.value.total_amount=f(),d.value.discount_amount=w(),console.log("Tổng tiền đã tính:",{total:d.value.total_amount,discount:d.value.discount_amount}),console.log("Gọi API tạo đơn hàng");const u=await _.post("/api/orders",d.value);console.log("Response tạo đơn hàng:",u.data);const p=u.data.data;d.value.payment_method_id===3?(console.log("Phương thức thanh toán PayOS được chọn"),await D(p)):(console.log("Chuyển hướng đến trang chi tiết đơn hàng"),U.visit(`/orders/${p.id}`))}catch(u){console.error("Chi tiết lỗi tạo đơn hàng:",{message:u.message,response:(o=u.response)==null?void 0:o.data,stack:u.stack}),e.error(((n=(s=u.response)==null?void 0:s.data)==null?void 0:n.message)||"Có lỗi xảy ra khi tạo đơn hàng")}},j=o=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(o),J=Y(()=>["pending","confirmed","shipping","delivered"].includes(N.order.status));H(()=>d.value.order_items,o=>{o.forEach(s=>{s.selectedItem&&s.item_type==="service"&&C(s)})},{deep:!0});const C=o=>{if(o.selectedItem){switch(o.service_type){case"combo_5":o.price=Number(o.selectedItem.combo_5_price||0);break;case"combo_10":o.price=Number(o.selectedItem.combo_10_price||0);break;default:o.price=Number(o.selectedItem.single_price||0);break}A()}};H(()=>d.value.order_items.map(o=>o.service_type),()=>{d.value.order_items.forEach(o=>{o.item_type==="service"&&o.selectedItem&&C(o)})},{deep:!0});const D=async o=>{var s,n,u,p,E;try{console.log("Bắt đầu xử lý thanh toán PayOS:",{orderId:o.id,totalAmount:o.total_amount}),e.info("Đang xử lý thanh toán...");const h=`${window.location.origin}/payment/callback`,B=`${window.location.origin}/payment/callback?status=cancel`;console.log("URLs callback:",{returnUrl:h,cancelUrl:B});const k=await _.post(`/api/orders/${o.id}/payment-link`,{returnUrl:h,cancelUrl:B});if(!((s=k==null?void 0:k.data)!=null&&s.success))throw new Error(((n=k==null?void 0:k.data)==null?void 0:n.message)||"Không thể tạo link thanh toán");const{checkoutUrl:X}=k.data.data;window.location.href=X}catch(h){console.error("Chi tiết lỗi thanh toán:",{message:h.message,response:(u=h.response)==null?void 0:u.data,request:h.request}),e.error(((E=(p=h.response)==null?void 0:p.data)==null?void 0:E.message)||"Lỗi xử lý thanh toán"),U.visit(`/orders/${o.id}`)}};return{form:d,userSearch:a,userResults:y,selectedUser:L,searchUsers:q,selectUser:F,addOrderItem:M,removeOrderItem:t,searchItems:b,selectItem:i,calculateTotal:f,calculateDiscount:w,calculateFinalTotal:O,formatCurrency:j,submitForm:z,canUpdateStatus:J,updateServicePrice:C,handlePayOSPayment:D,handlePaymentCallback:async()=>{const s=new URLSearchParams(window.location.search).get("orderCode");if(!s){e.error("Thiếu thông tin đơn hàng");return}try{const n=await _.post("/api/payment/verify",{orderCode:s});n.data.success?(e.success("Thanh toán thành công"),U.visit(`/orders/${n.data.data.order_id}`)):(e.error("Thanh toán thất bại"),U.visit("/orders"))}catch(n){console.error("Payment verification error:",n),e.error("Lỗi xác thực thanh toán")}}}}},se={class:"container mx-auto px-4 py-8"},de={class:"mb-4"},ne={class:"relative"},ie={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border"},le=["onClick"],ce={class:"font-medium text-gray-900 dark:text-dark-text"},me={class:"text-sm text-gray-500 dark:text-dark-text-muted"},ue={key:0,class:"ml-2"},be={class:"grid grid-cols-2 gap-4"},ge=["onUpdate:modelValue","onChange"],pe={key:0},he=["onUpdate:modelValue"],ke={class:"mt-4"},ye=["onUpdate:modelValue","onInput","placeholder"],fe={key:0,class:"mt-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto focus:outline-none sm:text-sm"},xe=["onClick"],ve={class:"flex flex-col"},_e={class:"font-medium text-gray-900 dark:text-dark-text"},we={key:0,class:"text-sm text-gray-600 dark:text-dark-text-muted"},Ce={key:1,class:"text-sm text-gray-600 dark:text-dark-text-muted"},Ue={class:"mt-4 grid grid-cols-3 gap-4"},Te=["onUpdate:modelValue"],Ve=["value"],Ie=["value"],Se=["onClick"],Pe=["value"],Ne=["value"],Le={class:"flex justify-between items-center"},qe={class:"text-right"},Fe={class:"text-sm text-gray-600 dark:text-gray-400"},Me={class:"text-sm text-red-600 dark:text-red-400"},Re={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"};function Oe(N,e,d,a,y,L){const q=R("Head"),F=R("SectionMain"),M=R("LayoutAuthenticated");return l(),$(M,null,{default:G(()=>[K(q,{title:"Tạo đơn hàng mới"}),K(F,null,{default:G(()=>[r("div",se,[e[24]||(e[24]=r("h1",{class:"text-3xl font-bold mb-6 text-gray-900 dark:text-dark-text"},"Tạo đơn hàng mới",-1)),r("form",{onSubmit:e[6]||(e[6]=ee((...t)=>a.submitForm&&a.submitForm(...t),["prevent"])),class:"space-y-6"},[r("div",de,[e[7]||(e[7]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1"}," Khách hàng ",-1)),r("div",ne,[g(r("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.userSearch=t),onInput:e[1]||(e[1]=(...t)=>a.searchUsers&&a.searchUsers(...t)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"},null,544),[[V,a.userSearch]]),a.userResults.length>0?(l(),c("div",ie,[(l(!0),c(x,null,v(a.userResults,t=>(l(),c("div",{key:t.id,onClick:b=>a.selectUser(t),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface-hover cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[r("div",ce,m(t.full_name),1),r("div",me,[I(" SĐT: "+m(t.phone_number)+" ",1),t.email?(l(),c("span",ue,"Email: "+m(t.email),1)):S("",!0)])],8,le))),128))])):S("",!0)])]),r("div",null,[e[18]||(e[18]=r("h3",{class:"text-lg font-medium text-gray-900 dark:text-dark-text mb-2"},"Sản phẩm/Dịch vụ",-1)),r("button",{type:"button",onClick:e[2]||(e[2]=(...t)=>a.addOrderItem&&a.addOrderItem(...t)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg"}," Thêm sản phẩm/dịch vụ "),(l(!0),c(x,null,v(a.form.order_items,(t,b)=>(l(),c("div",{key:b,class:"mb-4 p-4 border rounded-md border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface"},[r("div",be,[r("div",null,[e[9]||(e[9]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),g(r("select",{"onUpdate:modelValue":i=>t.item_type=i,onChange:i=>a.searchItems(b),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[8]||(e[8]=[r("option",{value:"product"},"Sản phẩm",-1),r("option",{value:"service"},"Dịch vụ",-1)]),40,ge),[[P,t.item_type]])]),t.item_type==="service"?(l(),c("div",pe,[e[11]||(e[11]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),g(r("select",{"onUpdate:modelValue":i=>t.service_type=i,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},e[10]||(e[10]=[r("option",{value:"single"},"Đơn lẻ",-1),r("option",{value:"combo_5"},"Combo 5",-1),r("option",{value:"combo_10"},"Combo 10",-1)]),8,he),[[P,t.service_type]])])):S("",!0)]),r("div",ke,[e[14]||(e[14]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),g(r("input",{type:"text","onUpdate:modelValue":i=>t.search=i,onInput:i=>a.searchItems(b),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:t.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ye),[[V,t.search]]),t.searchResults.length>0?(l(),c("ul",fe,[(l(!0),c(x,null,v(t.searchResults,i=>(l(),c("li",{key:i.id,onClick:f=>a.selectItem(b,i),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-primary-50 dark:hover:bg-dark-surface-hover"},[r("div",ve,[r("span",_e,m(i.name||i.service_name),1),i.item_type==="service"?(l(),c("span",we,[I(" Đơn lẻ: "+m(a.formatCurrency(i.single_price))+" ",1),e[12]||(e[12]=r("br",null,null,-1)),I(" Combo 5: "+m(a.formatCurrency(i.combo_5_price))+" ",1),e[13]||(e[13]=r("br",null,null,-1)),I(" Combo 10: "+m(a.formatCurrency(i.combo_10_price)),1)])):(l(),c("span",Ce,m(a.formatCurrency(i.price)),1))])],8,xe))),128))])):S("",!0)]),r("div",Ue,[r("div",null,[e[15]||(e[15]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Số lượng:",-1)),g(r("input",{"onUpdate:modelValue":i=>t.quantity=i,type:"number",min:"1",class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-dark-border rounded-md dark:bg-dark-surface dark:text-dark-text"},null,8,Te),[[V,t.quantity,void 0,{number:!0}]])]),r("div",null,[e[16]||(e[16]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Đơn giá:",-1)),r("input",{value:a.formatCurrency(t.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ve)]),r("div",null,[e[17]||(e[17]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Thành tiền:",-1)),r("input",{value:a.formatCurrency(t.quantity*t.price),class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ie)])]),r("button",{type:"button",onClick:i=>a.removeOrderItem(b),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,Se)]))),128))]),r("div",null,[e[20]||(e[20]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),g(r("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.form.voucher_id=t),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[e[19]||(e[19]=r("option",{value:""},"Không áp dụng",-1)),(l(!0),c(x,null,v(d.vouchers,t=>(l(),c("option",{key:t.id,value:t.id},m(t.code)+" - "+m(t.discount_type==="percentage"?`${t.discount_value}%`:a.formatCurrency(t.discount_value)),9,Pe))),128))],512),[[P,a.form.voucher_id]])]),r("div",null,[e[21]||(e[21]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),g(r("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.form.payment_method_id=t),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(l(!0),c(x,null,v(d.paymentMethods,t=>(l(),c("option",{key:t.id,value:t.id},m(t.method_name),9,Ne))),128))],512),[[P,a.form.payment_method_id]])]),r("div",null,[e[22]||(e[22]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),g(r("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.form.note=t),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[V,a.form.note]])]),r("div",Le,[e[23]||(e[23]=r("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Tạo đơn hàng và hóa đơn ",-1)),r("div",qe,[r("p",Fe,"Tổng tiền: "+m(a.formatCurrency(a.calculateTotal())),1),r("p",Me,"Giảm giá: -"+m(a.formatCurrency(a.calculateDiscount())),1),r("p",Re,"Thành tiền: "+m(a.formatCurrency(a.calculateFinalTotal())),1)])])],32)])]),_:1})]),_:1})}const Vr=oe(ae,[["render",Oe],["__scopeId","data-v-90cb60a4"]]);export{Vr as default};

import{F as y,Z as k}from"./@inertiajs-D0DMCEQB.js";import{a as C}from"./axios-CCb-kr4I.js";import{_ as f}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as m,o as w,aU as a,a2 as d,a3 as o,bf as v,b2 as b,aa as x,F as P}from"./@vue-BRgAy5zV.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";const $={props:{orderCode:{type:String,required:!0},invoice_id:{type:String,required:!0},status:{type:String,default:""}},setup(t){const e=m(!0),l=m(!1),r=m(null),g=m(null),u=m(null),n=async()=>{try{if(console.log("Bắt đầu xác thực thanh toán với dữ liệu:",{orderCode:t.orderCode,invoice_id:t.invoice_id,status:t.status}),!t.orderCode)throw new Error("Không tìm thấy mã đơn hàng");const s=t.invoice_id;if(console.log("Invoice ID:",s),t.status==="CANCELLED")throw console.log("Giao dịch bị hủy với status:",t.status),new Error("Giao dịch đã bị hủy");let c=3;for(;c>0;)try{console.log(`Thử xác thực lần ${4-c}`);const i=await C.post("/api/payos/verify",{orderCode:t.orderCode,invoice_id:s});if(console.log("Kết quả xác thực:",i.data),i.data.success){console.log("Xác thực thành công"),l.value=!0,i.data.transactionId&&(g.value=i.data.transactionId);break}c--,console.log(`Còn lại ${c} lần thử`)}catch(i){if(console.error("Lỗi trong quá trình xác thực:",i),c===0)throw i;console.log("Đợi 2 giây trước khi thử lại..."),await new Promise(_=>setTimeout(_,2e3))}}catch(s){console.error("Lỗi cuối cùng:",s),r.value=s.message||"Có lỗi xảy ra khi xác thực thanh toán",l.value=!1}finally{e.value=!1}},p=()=>{u.value?y.visit(`/orders/${u.value}`):y.visit("/orders")},h=()=>{y.visit("/invoices")};return w(()=>{n()}),{loading:e,success:l,error:r,transactionId:g,goToOrder:p,retryPayment:h}}},I={class:"payment-callback"},T={key:0,class:"loading"},E={key:1,class:"max-w-lg mx-auto p-6"},L={key:0,class:"success bg-green-50 dark:bg-green-900/20 p-6 rounded-lg"},S={class:"text-center"},q={class:"text-gray-600 dark:text-gray-400 mb-4"},B={key:1,class:"failed bg-red-50 dark:bg-red-900/20 p-6 rounded-lg"},F={class:"text-center"},D={class:"text-gray-600 dark:text-gray-400 mb-4"};function H(t,e,l,r,g,u){return a(),d("div",I,[r.loading?(a(),d("div",T,e[2]||(e[2]=[o("div",{class:"flex items-center justify-center"},[o("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"}),o("span",{class:"ml-3"},"Đang xác thực thanh toán...")],-1)]))):(a(),d("div",E,[r.success?(a(),d("div",L,[o("div",S,[e[3]||(e[3]=o("i",{class:"mdi mdi-check-circle text-5xl text-green-500 mb-4"},null,-1)),e[4]||(e[4]=o("h3",{class:"text-xl font-semibold text-green-700 dark:text-green-400 mb-2"}," Thanh toán thành công! ",-1)),o("p",q," Mã giao dịch: "+v(r.transactionId),1),o("button",{onClick:e[0]||(e[0]=(...n)=>r.goToOrder&&r.goToOrder(...n)),class:"btn bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg"}," Xem chi tiết đơn hàng ")])])):(a(),d("div",B,[o("div",F,[e[5]||(e[5]=o("i",{class:"mdi mdi-close-circle text-5xl text-red-500 mb-4"},null,-1)),e[6]||(e[6]=o("h3",{class:"text-xl font-semibold text-red-700 dark:text-red-400 mb-2"}," Thanh toán thất bại ",-1)),o("p",D,v(r.error),1),o("button",{onClick:e[1]||(e[1]=(...n)=>r.retryPayment&&r.retryPayment(...n)),class:"btn bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg"}," Quay lại trang hoá đơn ")])]))]))])}const N=f($,[["render",H]]),O={components:{Head:k,PaymentCallback:N},setup(){const t=new URLSearchParams(window.location.search);return{orderCode:t.get("orderCode"),invoice_id:t.get("invoice_id"),status:t.get("status")}}},j={class:"min-h-screen flex items-center justify-center bg-gray-100 dark:bg-dark-bg"},G={class:"max-w-md w-full"};function K(t,e,l,r,g,u){var h,s;const n=b("Head"),p=b("PaymentCallback",!0);return a(),d(P,null,[x(n,{title:"Thanh toán"}),o("div",j,[o("div",G,[x(p,{orderCode:t.$page.props.orderCode||((h=t.$page.url.split("orderCode=")[1])==null?void 0:h.split("&")[0]),invoice_id:t.$page.props.invoice_id,status:(s=t.$page.url.split("status=")[1])==null?void 0:s.split("&")[0]},null,8,["orderCode","invoice_id","status"])])])],64)}const mt=f(O,[["render",K]]);export{mt as default};

import{r as v,c as _,e as n,o as re,b as ie,aU as i,a2 as l,a3 as r,bf as o,bM as J,a9 as f,bJ as g,bA as C,F as k,b0 as x,a1 as p,bz as M,j as R,bK as le,n as oe}from"./@vue-BRgAy5zV.js";import{u as ne}from"./vue-toastification-ejyjJRED.js";import{F as de}from"./@inertiajs-D0DMCEQB.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./axios-CCb-kr4I.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";const ce={class:"relative bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full m-4 transform transition-all"},ve={class:"p-6 border-b border-gray-200 dark:border-gray-700"},ge={class:"text-2xl font-semibold text-gray-800 dark:text-white"},pe={class:"mt-1 text-sm text-gray-500 dark:text-gray-400"},me={class:"grid grid-cols-2 gap-6"},_e={class:"relative"},fe={class:"relative"},he={key:0,class:"absolute z-20 mt-1 w-full bg-white dark:bg-slate-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto"},be=["onClick"],ye={class:"font-medium dark:text-gray-200"},ke={class:"text-sm text-gray-500 dark:text-gray-400"},xe=["value"],we={class:"col-span-2 grid grid-cols-2 gap-6"},Se={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Te={key:0,class:"text-sm text-gray-500"},Ve=["disabled"],Ue=["value"],Ce={key:0,class:"mt-1 text-sm text-red-600"},Me={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Ee={key:0,class:"text-sm text-gray-500"},De=["disabled"],Fe=["value"],Le={key:0,class:"mt-1 text-sm text-red-600"},Ke={class:"col-span-2 grid grid-cols-2 gap-6"},$e=["value","disabled"],Ae={class:"col-span-2 grid grid-cols-2 gap-6"},je=["value"],Be=["max"],Ne={key:0,class:"mt-1 text-sm text-red-600"},ze={key:1,class:"text-xs text-gray-500 dark:text-gray-400 mt-1"},Ie={class:"col-span-2"},Ge={class:"mt-8 flex justify-end space-x-4"},Pe={__name:"AddAppointmentModal",props:{show:Boolean,appointments:{type:Array,default:()=>[]},closeModal:{type:Function,required:!0},selectedTimeSlot:{type:Object,default:()=>({})}},emits:["close","save","appointmentAdded"],setup(L,{emit:Y}){var P,q;const E=ne(),d=L,K=Y,h=v(""),m=v([]),$=v(null),u=v({}),y=v([]),w=v([]),D=v([]),c=v([]),F=()=>{var a,e;t.value={user_id:"",service_id:"",staff_id:c.value.length>0?c.value[0].id:"",appointment_date:((a=d.selectedTimeSlot)==null?void 0:a.date)||"",time_slot_id:((e=d.selectedTimeSlot)==null?void 0:e.timeSlotId)||"",appointment_type:"consultation",status:"pending",note:"",slots:1},$.value=null,h.value=""},t=v({user_id:"",staff_id:"",appointment_date:((P=d.selectedTimeSlot)==null?void 0:P.date)||"",time_slot_id:((q=d.selectedTimeSlot)==null?void 0:q.id)||"",appointment_type:"service",status:"confirmed",note:"",slots:1,service_id:null,user_service_package_id:null}),A=_(()=>d.appointments&&d.appointments.length>0?"Chỉnh sửa lịch hẹn":"Thêm lịch hẹn mới"),j=_(()=>!!t.value.user_service_package_id),B=_(()=>!!t.value.service_id);_(()=>[{value:"service",label:"Thực hiện dịch vụ"},{value:"service_package",label:"Thực hiện combo"},{value:"consultation",label:"Tư vấn"},{value:"others",label:"Khác"}]),n(()=>t.value.service_id,a=>{a&&(t.value.user_service_package_id=null,t.value.appointment_type="service")}),n(()=>t.value.user_service_package_id,a=>{a&&(t.value.service_id=null,t.value.appointment_type="service_package")});const N=async()=>{try{const a=await axios.get("/api/time-slots",{params:{date:t.value.appointment_date,service_id:t.value.service_id}});a.data&&a.data.data&&(w.value=a.data.data.map(e=>({...e,available:e.current_bookings<e.max_bookings,displayText:`${e.start_time.substring(0,5)} - ${e.end_time.substring(0,5)} (${e.current_bookings}/${e.max_bookings})`})))}catch(a){console.error("Error fetching time slots:",a),w.value=[]}};n([()=>t.value.appointment_date,()=>t.value.service_id],()=>{t.value.appointment_date&&N()}),n(()=>t.value.service_id,a=>{if(a){const e=y.value.find(s=>s.id===a);e&&(t.value.appointment_type=e.service_type)}}),n(()=>d.appointments,a=>{a&&a.length>0?(F(),Object.keys(a[0]).forEach(e=>{t.value[e]!==void 0&&(t.value[e]=a[0][e])}),t.value.start_date=z(a[0].start),t.value.end_date=z(a[0].end)):F()},{immediate:!0}),n(()=>d.selectedTimeSlot,a=>{a&&a.date&&oe(()=>{t.value={...t.value,appointment_date:a.date,time_slot_id:a.timeSlotId}})},{immediate:!0});function z(a){if(!a)return"";let e=new Date(a);return e.getFullYear()+"-"+S(e.getMonth()+1)+"-"+S(e.getDate())+"T"+S(e.getHours())+":"+S(e.getMinutes())}function S(a){return a<10?"0"+a:a}const T=()=>{F(),K("close")};function Q(){h.value.length>2?axios.get(`/api/users/search?query=${h.value}`).then(a=>{a.data&&a.data.data?m.value=a.data.data:(m.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error searching users:",a.response?a.response.data:a.message),m.value=[]}):m.value=[]}function W(a){$.value=a,t.value.user_id=a.id,m.value=[],h.value=a.full_name,X(a.id)}function X(a){axios.get(`/api/user-treatment-packages/${a}`).then(e=>{D.value=e.data.data||[]}).catch(e=>{console.error("Error fetching user treatment packages:",e),D.value=[]})}re(()=>{Z(),I(),document.addEventListener("keydown",G),c.value.length>0&&(t.staff_id=c.value[0].id),N(),I()});const Z=async()=>{try{const a=await axios.get("/api/services/appointment");a.data&&a.data.data&&(y.value=a.data.data.map(e=>({...e,service_category:e.service_category||null})))}catch(a){console.error("Error fetching services:",a),y.value=[]}};function I(){axios.get("/api/users/get-staff-list").then(a=>{a.data&&a.data.data?(c.value=a.data.data,!t.value.staff_id&&c.value.length>0&&(t.value.staff_id=c.value[0].id)):(c.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error fetching staff list:",a.response?a.response.data:a.message),c.value=[]})}function G(a){a.key==="Escape"&&d.show&&T()}ie(()=>{document.removeEventListener("keydown",G)});function ee(){if(!V.value)return;const a={user_id:t.value.user_id,staff_id:t.value.staff_id,appointment_date:t.value.appointment_date,time_slot_id:t.value.time_slot_id,appointment_type:t.value.appointment_type,status:"pending",note:t.value.note||"",slots:parseInt(t.value.slots)||1,service_id:t.value.service_id||null,user_service_package_id:t.value.user_service_package_id||null};te(a)}function te(a){axios.post(route("appointments.store"),a).then(e=>{e.data.success?(K("appointmentAdded",e.data.data),d.closeModal(),E.success(e.data.message||"Đặt lịch hẹn thành công"),de.visit(window.location.pathname,{preserveScroll:!0,preserveState:!1})):(e.data.errors&&(u.value=e.data.errors),E.error(e.data.message||"Có lỗi xảy ra khi tạo lịch hẹn"))}).catch(e=>{var s,b,O,H;console.error("Submit error:",e),(b=(s=e.response)==null?void 0:s.data)!=null&&b.errors?u.value=e.response.data.errors:u.value={general:["Đã có lỗi xảy ra khi tạo lịch hẹn"]},E.error(((H=(O=e.response)==null?void 0:O.data)==null?void 0:H.message)||"Có lỗi xảy ra khi tạo lịch hẹn")})}n(()=>y.value,()=>{},{deep:!0});const V=_(()=>!!(t.value.user_id&&t.value.staff_id&&t.value.appointment_date&&t.value.time_slot_id&&t.value.slots>=1&&t.value.slots<=U.value&&(t.value.service_id&&!t.value.user_service_package_id||!t.value.service_id&&t.value.user_service_package_id)));n(()=>t.value,()=>{u.value={}},{deep:!0});const U=_(()=>{if(!t.value.time_slot_id)return 0;const a=w.value.find(e=>e.id===t.value.time_slot_id);return a?a.max_bookings-a.current_bookings:0});n(()=>t.service_id,async a=>{var e;if(a)try{const s=await axios.get(`/api/services/${a}`);s.data.data&&(t.appointment_type=((e=s.data.data.category)==null?void 0:e.toLowerCase())||"others")}catch(s){console.error("Error fetching service details:",s)}}),n(()=>t.value.user_service_package_id,a=>{a?t.value.appointment_type="service_package":t.value.service_id||(t.value.appointment_type="consultation")});const ae=_(()=>{switch(t.value.appointment_type){case"service":return"Dịch vụ đơn lẻ";case"service_package":return"Gói điều trị";case"consultation":return"Tư vấn";default:return"Khác"}});n([()=>t.value.service_id,()=>t.value.user_service_package_id],([a,e])=>{e?t.value.appointment_type="service_package":a?t.value.appointment_type="service":t.value.appointment_type="consultation"});function se(){return t.value.user_id?t.value.staff_id?t.value.appointment_date?t.value.time_slot_id?!t.value.slots||t.value.slots<1||t.value.slots>2?"Số lượng slot không hợp lệ":!t.value.service_id&&!t.value.user_service_package_id?"Vui lòng chọn dịch vụ hoặc gói điều trị":t.value.service_id&&t.value.user_service_package_id?"Vui lòng chỉ chọn một trong hai: dịch vụ hoặc gói điều trị":"Vui lòng điền đầy đủ thông tin":"Vui lòng chọn khung giờ":"Vui lòng chọn ngày hẹn":"Vui lòng chọn nhân viên":"Vui lòng chọn khách hàng"}return(a,e)=>L.show?(i(),l("div",{key:0,class:"fixed inset-0 bg-gray-600/75 dark:bg-gray-900/90 overflow-y-auto h-full w-full flex justify-center items-center z-50 backdrop-blur-sm",onClick:J(T,["self"]),onKeydown:le(T,["esc"]),tabindex:"0"},[r("div",ce,[r("div",ve,[r("h2",ge,o(A.value),1),r("p",pe," Điền thông tin để "+o(A.value.toLowerCase()),1)]),r("form",{onSubmit:J(ee,["prevent"]),class:"p-6"},[r("div",me,[r("div",_e,[e[8]||(e[8]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khách hàng "),r("span",{class:"text-red-500"},"*")],-1)),r("div",fe,[g(r("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),onInput:Q,placeholder:"Tìm theo tên hoặc số điện thoại",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,544),[[C,h.value]]),m.value.length>0?(i(),l("div",he,[(i(!0),l(k,null,x(m.value,s=>(i(),l("div",{key:s.id,onClick:b=>W(s),class:"p-3 hover:bg-gray-50 dark:hover:bg-slate-600 cursor-pointer border-b last:border-0 dark:border-gray-600"},[r("div",ye,o(s.full_name),1),r("div",ke,o(s.phone_number),1)],8,be))),128))])):p("",!0)])]),r("div",null,[e[9]||(e[9]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Nhân viên phụ trách "),r("span",{class:"text-red-500"},"*")],-1)),g(r("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>t.value.staff_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[(i(!0),l(k,null,x(c.value,s=>(i(),l("option",{key:s.id,value:s.id},o(s.full_name),9,xe))),128))],512),[[M,t.value.staff_id]])]),r("div",we,[r("div",null,[r("label",Se,[e[10]||(e[10]=f(" Gói điều trị ")),B.value?(i(),l("span",Te,"(Đã chọn dịch vụ)")):p("",!0)]),g(r("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>t.value.user_service_package_id=s),disabled:B.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[11]||(e[11]=r("option",{value:""},"Chọn gói điều trị",-1)),(i(!0),l(k,null,x(D.value,s=>{var b;return i(),l("option",{key:s.id,value:s.id},o(((b=s.service)==null?void 0:b.service_name)||s.service_name)+" ("+o(s.remaining_sessions)+" buổi) ",9,Ue)}),128))],8,Ve),[[M,t.value.user_service_package_id]]),u.value.user_service_package_id?(i(),l("div",Ce,o(u.value.user_service_package_id[0]),1)):p("",!0)]),r("div",null,[r("label",Me,[e[12]||(e[12]=f(" Dịch vụ ")),j.value?(i(),l("span",Ee,"(Đã chọn gói)")):p("",!0)]),g(r("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>t.value.service_id=s),disabled:j.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[13]||(e[13]=r("option",{value:""},"Chọn dịch vụ",-1)),(i(!0),l(k,null,x(y.value,s=>(i(),l("option",{key:s.id,value:s.id},o(s.name||s.service_name),9,Fe))),128))],8,De),[[M,t.value.service_id]]),u.value.service_id?(i(),l("div",Le,o(u.value.service_id[0]),1)):p("",!0)])]),r("div",Ke,[r("div",null,[e[14]||(e[14]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Ngày hẹn "),r("span",{class:"text-red-500"},"*")],-1)),g(r("input",{type:"date","onUpdate:modelValue":e[4]||(e[4]=s=>t.value.appointment_date=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,512),[[C,t.value.appointment_date]])]),r("div",null,[e[16]||(e[16]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khung giờ "),r("span",{class:"text-red-500"},"*")],-1)),g(r("select",{"onUpdate:modelValue":e[5]||(e[5]=s=>t.value.time_slot_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[15]||(e[15]=r("option",{value:""},"Chọn khung giờ",-1)),(i(!0),l(k,null,x(w.value,s=>(i(),l("option",{key:s.id,value:s.id,disabled:!s.available,class:R({"text-gray-400":!s.available})},o(s.displayText),11,$e))),128))],512),[[M,t.value.time_slot_id]])])]),r("div",Ae,[r("div",null,[e[17]||(e[17]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Loại lịch hẹn",-1)),r("input",{type:"text",value:ae.value,disabled:"",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white bg-gray-100"},null,8,je)]),r("div",null,[e[18]||(e[18]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Số lượng slot "),r("span",{class:"text-red-500"},"*")],-1)),g(r("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=s=>t.value.slots=s),min:"1",max:U.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,8,Be),[[C,t.value.slots]]),u.value.slots?(i(),l("div",Ne,o(u.value.slots[0]),1)):p("",!0),U.value?(i(),l("span",ze," Còn trống: "+o(U.value)+" slot ",1)):p("",!0)])]),r("div",Ie,[e[19]||(e[19]=r("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Ghi chú",-1)),g(r("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>t.value.note=s),rows:"3",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200",placeholder:"Thêm ghi chú cho lịch hẹn..."},null,512),[[C,t.value.note]])])]),r("div",Ge,[r("button",{onClick:T,type:"button",class:"px-6 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"}," Đóng "),r("button",{type:"submit",class:R(["px-6 py-2.5 rounded-lg font-medium transition-all duration-200",{"bg-indigo-600 text-white hover:bg-indigo-700":V.value,"bg-gray-300 text-gray-500 cursor-not-allowed":!V.value}])},o(V.value?"Lưu":se()),3)])],32)])],32)):p("",!0)}},pt=ue(Pe,[["__scopeId","data-v-6b819d49"]]);export{pt as default};

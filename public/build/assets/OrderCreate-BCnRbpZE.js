import{Z as z,F as G}from"./@inertiajs-D0DMCEQB.js";import{_ as K}from"./SectionMain-Vot1TOkK.js";import{L as P}from"./LayoutAuthenticated-efRhzLqt.js";import{r as v,c as j,e as D,b2 as M,aU as l,a0 as J,bH as E,aa as L,a3 as e,bM as X,bJ as b,bA as _,a2 as m,F as f,b0 as y,bf as c,a9 as w,a1 as C,bz as V}from"./@vue-BRgAy5zV.js";import{a as F}from"./axios-CCb-kr4I.js";import{l as Z}from"./lodash-D4AGecfG.js";import{u as Q}from"./vue-toastification-ejyjJRED.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-D7koDRFv.js";import"./app-CCOuM6Nc.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const Y={components:{Head:z,SectionMain:K,LayoutAuthenticated:P},props:{vouchers:Array,paymentMethods:Array},setup(U){const r=Q(),s=v({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),a=v(""),p=v([]),I=v(null),T=Z.debounce(async()=>{if(a.value.length<2){p.value=[];return}try{const o=await F.get("/api/users/search",{params:{query:a.value}});p.value=o.data.data}catch(o){console.error("Search error:",o),p.value=[]}},300),S=o=>{s.value.user_id=o.id,I.value=o,a.value=o.full_name,p.value=[]},N=()=>{s.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},t=o=>{s.value.order_items.splice(o,1)},u=async o=>{const d=s.value.order_items[o];if(d.search.length<2){d.searchResults=[];return}try{const i=d.item_type==="product"?"/api/products/search":"/api/services/search",g=await F.get(i,{params:{query:d.search}});d.searchResults=g.data.data.map(H=>({...H,item_type:d.item_type}))}catch(i){console.error("Error searching items:",i),d.searchResults=[]}},n=(o,d)=>{const i=s.value.order_items[o];i.selectedItem=d,i.item_id=d.id,i.search=d.name||d.service_name,d.item_type==="service"?x(i):i.price=Number(d.price),i.searchResults=[],q()},k=()=>s.value.order_items.reduce((o,d)=>o+d.quantity*d.price,0),h=()=>{if(!s.value.voucher_id)return 0;const o=U.vouchers.find(i=>i.id===s.value.voucher_id);if(!o)return 0;const d=k();return o.discount_type==="percentage"?d*(o.discount_value/100):o.discount_value},R=()=>Math.max(0,k()-h()),q=()=>{s.value.total_amount=R(),s.value.discount_amount=h()},A=async()=>{var o,d;try{if(!s.value.user_id){r.error("Vui lòng chọn khách hàng");return}if(s.value.order_items.length===0){r.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}for(const g of s.value.order_items)if(!g.item_id||!g.selectedItem){r.error("Vui lòng chọn đầy đủ thông tin cho tất cả sản phẩm/dịch vụ");return}s.value.total_amount=k(),s.value.discount_amount=h();const i=await F.post("/orders",s.value);r.success("Đơn hàng và hóa đơn đã được tạo thành công!"),G.visit(`/orders/${i.data.data.id}`)}catch(i){console.error("Error creating order:",i);const g=((d=(o=i.response)==null?void 0:o.data)==null?void 0:d.message)||"Có lỗi xảy ra khi tạo đơn hàng!";r.error(g)}},O=o=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(o),B=j(()=>["pending","confirmed","shipping","delivered"].includes(U.order.status));D(()=>s.value.order_items,o=>{o.forEach(d=>{d.selectedItem&&d.item_type==="service"&&x(d)})},{deep:!0});const x=o=>{if(o.selectedItem){switch(o.service_type){case"combo_5":o.price=Number(o.selectedItem.combo_5_price||0);break;case"combo_10":o.price=Number(o.selectedItem.combo_10_price||0);break;default:o.price=Number(o.selectedItem.single_price||0);break}q()}};return D(()=>s.value.order_items.map(o=>o.service_type),()=>{s.value.order_items.forEach(o=>{o.item_type==="service"&&o.selectedItem&&x(o)})},{deep:!0}),{form:s,userSearch:a,userResults:p,selectedUser:I,searchUsers:T,selectUser:S,addOrderItem:N,removeOrderItem:t,searchItems:u,selectItem:n,calculateTotal:k,calculateDiscount:h,calculateFinalTotal:R,formatCurrency:O,submitForm:A,canUpdateStatus:B,updateServicePrice:x}}},$={class:"container mx-auto px-4 py-8"},ee={class:"mb-4"},re={class:"relative"},te={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border"},oe=["onClick"],ae={class:"font-medium text-gray-900 dark:text-dark-text"},de={class:"text-sm text-gray-500 dark:text-dark-text-muted"},se={key:0,class:"ml-2"},ne={class:"grid grid-cols-2 gap-4"},ie=["onUpdate:modelValue","onChange"],le={key:0},me=["onUpdate:modelValue"],ce={class:"mt-4"},ue=["onUpdate:modelValue","onInput","placeholder"],be={key:0,class:"mt-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto focus:outline-none sm:text-sm"},pe=["onClick"],ge={class:"flex flex-col"},ke={class:"font-medium text-gray-900 dark:text-dark-text"},fe={key:0,class:"text-sm text-gray-600 dark:text-dark-text-muted"},ye={key:1,class:"text-sm text-gray-600 dark:text-dark-text-muted"},he={class:"mt-4 grid grid-cols-3 gap-4"},xe=["onUpdate:modelValue"],ve=["value"],_e=["value"],we=["onClick"],Ce=["value"],Ve=["value"],Ue={class:"flex justify-between items-center"},Ie={class:"text-right"},Te={class:"text-sm text-gray-600 dark:text-gray-400"},Se={class:"text-sm text-red-600 dark:text-red-400"},Ne={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"};function Me(U,r,s,a,p,I){const T=M("Head"),S=M("SectionMain"),N=M("LayoutAuthenticated");return l(),J(N,null,{default:E(()=>[L(T,{title:"Tạo đơn hàng mới"}),L(S,null,{default:E(()=>[e("div",$,[r[24]||(r[24]=e("h1",{class:"text-3xl font-bold mb-6 text-gray-900 dark:text-dark-text"},"Tạo đơn hàng mới",-1)),e("form",{onSubmit:r[6]||(r[6]=X((...t)=>a.submitForm&&a.submitForm(...t),["prevent"])),class:"space-y-6"},[e("div",ee,[r[7]||(r[7]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1"}," Khách hàng ",-1)),e("div",re,[b(e("input",{"onUpdate:modelValue":r[0]||(r[0]=t=>a.userSearch=t),onInput:r[1]||(r[1]=(...t)=>a.searchUsers&&a.searchUsers(...t)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"},null,544),[[_,a.userSearch]]),a.userResults.length>0?(l(),m("div",te,[(l(!0),m(f,null,y(a.userResults,t=>(l(),m("div",{key:t.id,onClick:u=>a.selectUser(t),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface-hover cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[e("div",ae,c(t.full_name),1),e("div",de,[w(" SĐT: "+c(t.phone_number)+" ",1),t.email?(l(),m("span",se,"Email: "+c(t.email),1)):C("",!0)])],8,oe))),128))])):C("",!0)])]),e("div",null,[r[18]||(r[18]=e("h3",{class:"text-lg font-medium text-gray-900 dark:text-dark-text mb-2"},"Sản phẩm/Dịch vụ",-1)),e("button",{type:"button",onClick:r[2]||(r[2]=(...t)=>a.addOrderItem&&a.addOrderItem(...t)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg"}," Thêm sản phẩm/dịch vụ "),(l(!0),m(f,null,y(a.form.order_items,(t,u)=>(l(),m("div",{key:u,class:"mb-4 p-4 border rounded-md border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface"},[e("div",ne,[e("div",null,[r[9]||(r[9]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),b(e("select",{"onUpdate:modelValue":n=>t.item_type=n,onChange:n=>a.searchItems(u),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},r[8]||(r[8]=[e("option",{value:"product"},"Sản phẩm",-1),e("option",{value:"service"},"Dịch vụ",-1)]),40,ie),[[V,t.item_type]])]),t.item_type==="service"?(l(),m("div",le,[r[11]||(r[11]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),b(e("select",{"onUpdate:modelValue":n=>t.service_type=n,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},r[10]||(r[10]=[e("option",{value:"single"},"Đơn lẻ",-1),e("option",{value:"combo_5"},"Combo 5",-1),e("option",{value:"combo_10"},"Combo 10",-1)]),8,me),[[V,t.service_type]])])):C("",!0)]),e("div",ce,[r[14]||(r[14]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),b(e("input",{type:"text","onUpdate:modelValue":n=>t.search=n,onInput:n=>a.searchItems(u),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:t.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ue),[[_,t.search]]),t.searchResults.length>0?(l(),m("ul",be,[(l(!0),m(f,null,y(t.searchResults,n=>(l(),m("li",{key:n.id,onClick:k=>a.selectItem(u,n),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-primary-50 dark:hover:bg-dark-surface-hover"},[e("div",ge,[e("span",ke,c(n.name||n.service_name),1),n.item_type==="service"?(l(),m("span",fe,[w(" Đơn lẻ: "+c(a.formatCurrency(n.single_price))+" ",1),r[12]||(r[12]=e("br",null,null,-1)),w(" Combo 5: "+c(a.formatCurrency(n.combo_5_price))+" ",1),r[13]||(r[13]=e("br",null,null,-1)),w(" Combo 10: "+c(a.formatCurrency(n.combo_10_price)),1)])):(l(),m("span",ye,c(a.formatCurrency(n.price)),1))])],8,pe))),128))])):C("",!0)]),e("div",he,[e("div",null,[r[15]||(r[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Số lượng:",-1)),b(e("input",{"onUpdate:modelValue":n=>t.quantity=n,type:"number",min:"1",class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-dark-border rounded-md dark:bg-dark-surface dark:text-dark-text"},null,8,xe),[[_,t.quantity,void 0,{number:!0}]])]),e("div",null,[r[16]||(r[16]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Đơn giá:",-1)),e("input",{value:a.formatCurrency(t.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,ve)]),e("div",null,[r[17]||(r[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Thành tiền:",-1)),e("input",{value:a.formatCurrency(t.quantity*t.price),class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,_e)])]),e("button",{type:"button",onClick:n=>a.removeOrderItem(u),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,we)]))),128))]),e("div",null,[r[20]||(r[20]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),b(e("select",{"onUpdate:modelValue":r[3]||(r[3]=t=>a.form.voucher_id=t),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[r[19]||(r[19]=e("option",{value:""},"Không áp dụng",-1)),(l(!0),m(f,null,y(s.vouchers,t=>(l(),m("option",{key:t.id,value:t.id},c(t.code)+" - "+c(t.discount_type==="percentage"?`${t.discount_value}%`:a.formatCurrency(t.discount_value)),9,Ce))),128))],512),[[V,a.form.voucher_id]])]),e("div",null,[r[21]||(r[21]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),b(e("select",{"onUpdate:modelValue":r[4]||(r[4]=t=>a.form.payment_method_id=t),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(l(!0),m(f,null,y(s.paymentMethods,t=>(l(),m("option",{key:t.id,value:t.id},c(t.method_name),9,Ve))),128))],512),[[V,a.form.payment_method_id]])]),e("div",null,[r[22]||(r[22]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),b(e("textarea",{"onUpdate:modelValue":r[5]||(r[5]=t=>a.form.note=t),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[_,a.form.note]])]),e("div",Ue,[r[23]||(r[23]=e("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Tạo đơn hàng và hóa đơn ",-1)),e("div",Ie,[e("p",Te,"Tổng tiền: "+c(a.formatCurrency(a.calculateTotal())),1),e("p",Se,"Giảm giá: -"+c(a.formatCurrency(a.calculateDiscount())),1),e("p",Ne,"Thành tiền: "+c(a.formatCurrency(a.calculateFinalTotal())),1)])])],32)])]),_:1})]),_:1})}const xr=W(Y,[["render",Me],["__scopeId","data-v-1908dd84"]]);export{xr as default};

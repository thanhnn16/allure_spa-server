import{Z,F as I}from"./@inertiajs-D0DMCEQB.js";import{_ as Q}from"./SectionMain-Vot1TOkK.js";import{L as W}from"./LayoutAuthenticated-CBLzeGQR.js";import{r as x,c as B,e as D,b2 as O,aU as l,a0 as Y,bH as E,aa as H,a3 as e,bM as $,bJ as b,bA as P,a2 as c,F as p,b0 as v,bf as m,a9 as k,a1 as _,bz as M}from"./@vue-BRgAy5zV.js";import{a as w}from"./axios-CCb-kr4I.js";import{l as ee}from"./lodash-D4AGecfG.js";import{u as te}from"./vue-toastification-ejyjJRED.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-DWfqH7fj.js";import"./app-OyFPVnvx.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const oe={components:{Head:Z,SectionMain:Q,LayoutAuthenticated:W},props:{vouchers:Array,paymentMethods:Array},setup(C){const t=te(),n=x({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),a=x(""),h=x([]),N=x(null),R=ee.debounce(async()=>{if(a.value.length<2){h.value=[];return}try{const r=await w.get("/api/users/search",{params:{query:a.value}});h.value=r.data.data}catch(r){console.error("Search error:",r),h.value=[]}},300),L=r=>{n.value.user_id=r.id,N.value=r,a.value=r.full_name,h.value=[]},A=()=>{n.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},o=r=>{n.value.order_items.splice(r,1)},g=async r=>{const s=n.value.order_items[r];if(s.search.length<2){s.searchResults=[];return}try{const d=s.item_type==="product"?"/api/products/search":"/api/services/search",u=await w.get(d,{params:{query:s.search}});s.searchResults=u.data.data.map(y=>({...y,item_type:s.item_type}))}catch(d){console.error("Error searching items:",d),s.searchResults=[]}},i=(r,s)=>{const d=n.value.order_items[r];d.selectedItem=s,d.item_id=s.id,d.search=s.name||s.service_name,s.item_type==="service"?T(d):d.price=Number(s.price),d.searchResults=[],U()},f=()=>n.value.order_items.reduce((r,s)=>r+s.quantity*s.price,0),V=()=>{if(!n.value.voucher_id)return 0;const r=C.vouchers.find(d=>d.id===n.value.voucher_id);if(!r)return 0;const s=f();return r.discount_type==="percentage"?s*(r.discount_value/100):r.discount_value},q=()=>Math.max(0,f()-V()),U=()=>{n.value.total_amount=q(),n.value.discount_amount=V()},F=x(!1),G=async()=>{var r,s,d;try{if(F.value=!0,console.log("Bắt đầu submit form với dữ liệu:",n.value),!n.value.user_id){t.error("Vui lòng chọn khách hàng");return}if(n.value.order_items.length===0){t.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}n.value.total_amount=f(),n.value.discount_amount=V(),console.log("Tổng tiền đã tính:",{total:n.value.total_amount,discount:n.value.discount_amount}),console.log("Gọi API tạo đơn hàng");const u=await w.post("/api/orders",n.value);console.log("Response tạo đơn hàng:",u.data);const y=u.data.data;n.value.payment_method_id===3?(console.log("Phương thức thanh toán PayOS được chọn"),await z(y)):(console.log("Chuyển hướng đến trang chi tiết đơn hàng"),I.visit(`/orders/${y.id}`))}catch(u){console.error("Chi tiết lỗi tạo đơn hàng:",{message:u.message,response:(r=u.response)==null?void 0:r.data,stack:u.stack}),t.error(((d=(s=u.response)==null?void 0:s.data)==null?void 0:d.message)||"Có lỗi xảy ra khi tạo đơn hàng")}finally{F.value=!1}},K=r=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(r),j=B(()=>["pending","confirmed","shipping","delivered"].includes(C.order.status));D(()=>n.value.order_items,r=>{r.forEach(s=>{s.selectedItem&&s.item_type==="service"&&T(s)})},{deep:!0});const T=r=>{if(r.selectedItem){switch(r.service_type){case"combo_5":r.price=Number(r.selectedItem.combo_5_price||0);break;case"combo_10":r.price=Number(r.selectedItem.combo_10_price||0);break;default:r.price=Number(r.selectedItem.single_price||0);break}U()}};D(()=>n.value.order_items.map(r=>r.service_type),()=>{n.value.order_items.forEach(r=>{r.item_type==="service"&&r.selectedItem&&T(r)})},{deep:!0});const z=async r=>{var s,d;try{const u=`${window.location.origin}/payment/callback`,y=`${window.location.origin}/payment/callback?status=cancel`,S=await w.post(`/api/orders/${r.id}/payment-link`,{returnUrl:u,cancelUrl:y});if(S.data.success&&S.data.data.checkoutUrl)window.location.href=S.data.data.checkoutUrl;else throw new Error(S.data.message||"Không thể tạo link thanh toán")}catch(u){t.error("Lỗi xử lý thanh toán: "+(((d=(s=u.response)==null?void 0:s.data)==null?void 0:d.message)||u.message)),I.visit(`/orders/${r.id}`)}},J=async()=>{const s=new URLSearchParams(window.location.search).get("orderCode");if(!s){t.error("Thiếu thông tin đơn hàng");return}try{const d=await w.post("/api/payment/verify",{orderCode:s});d.data.success?(t.success("Thanh toán thành công"),I.visit(`/orders/${d.data.data.order_id}`)):(t.error("Thanh toán thất bại"),I.visit("/orders"))}catch(d){console.error("Payment verification error:",d),t.error("Lỗi xác thực thanh toán")}},X=B(()=>n.value.total_amount-n.value.discount_amount);return{form:n,userSearch:a,userResults:h,selectedUser:N,searchUsers:R,selectUser:L,addOrderItem:A,removeOrderItem:o,searchItems:g,selectItem:i,calculateTotal:f,calculateDiscount:V,calculateFinalTotal:q,formatCurrency:K,submitForm:G,canUpdateStatus:j,updateServicePrice:T,handlePayOSPayment:z,handlePaymentCallback:J,finalAmount:X,applyVoucher:async r=>{try{if(n.value.voucher_id=r,r){const s=C.vouchers.find(d=>d.id===r);s&&(s.discount_type==="percentage"?n.value.discount_amount=n.value.total_amount*s.discount_value/100:n.value.discount_amount=s.discount_value)}else n.value.discount_amount=0;U()}catch(s){t.error("Lỗi khi áp dụng voucher: "+s.message)}},updateTotals:U,isProcessing:F}}},ae={class:"container mx-auto px-4 py-8"},se={class:"mb-4"},ne={class:"relative"},de={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border"},ie=["onClick"],le={class:"font-medium text-gray-900 dark:text-dark-text"},ce={class:"text-sm text-gray-500 dark:text-dark-text-muted"},me={key:0,class:"ml-2"},ue={class:"grid grid-cols-2 gap-4"},ge=["onUpdate:modelValue","onChange"],be={key:0},pe=["onUpdate:modelValue"],he={class:"mt-4"},ye=["onUpdate:modelValue","onInput","placeholder"],ke={key:0,class:"mt-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto focus:outline-none sm:text-sm"},fe=["onClick"],xe={class:"flex flex-col"},ve={class:"font-medium text-gray-900 dark:text-dark-text"},_e={key:0,class:"text-sm text-gray-600 dark:text-dark-text-muted"},we={key:1,class:"text-sm text-gray-600 dark:text-dark-text-muted"},Ce={class:"mt-4 grid grid-cols-3 gap-4"},Ve=["onUpdate:modelValue"],Ue=["value"],Te=["value"],Se=["onClick"],Ie=["value"],Pe=["value"],Me={class:"flex justify-between items-center"},Ne=["disabled"],Re={class:"text-right"},Le={class:"text-sm text-gray-600 dark:text-gray-400"},Ae={class:"text-sm text-red-600 dark:text-red-400"},Fe={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"},Oe={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},qe={class:"bg-white dark:bg-dark-surface p-6 rounded-lg shadow-xl text-center"},ze={class:"text-gray-900 dark:text-dark-text font-medium"};function Be(C,t,n,a,h,N){const R=O("Head"),L=O("SectionMain"),A=O("LayoutAuthenticated");return l(),Y(A,null,{default:E(()=>[H(R,{title:"Tạo đơn hàng mới"}),H(L,null,{default:E(()=>[e("div",ae,[t[24]||(t[24]=e("h1",{class:"text-3xl font-bold mb-6 text-gray-900 dark:text-dark-text"},"Tạo đơn hàng mới",-1)),e("form",{onSubmit:t[6]||(t[6]=$((...o)=>a.submitForm&&a.submitForm(...o),["prevent"])),class:"space-y-6"},[e("div",se,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1"}," Khách hàng ",-1)),e("div",ne,[b(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>a.userSearch=o),onInput:t[1]||(t[1]=(...o)=>a.searchUsers&&a.searchUsers(...o)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"},null,544),[[P,a.userSearch]]),a.userResults.length>0?(l(),c("div",de,[(l(!0),c(p,null,v(a.userResults,o=>(l(),c("div",{key:o.id,onClick:g=>a.selectUser(o),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface-hover cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[e("div",le,m(o.full_name),1),e("div",ce,[k(" SĐT: "+m(o.phone_number)+" ",1),o.email?(l(),c("span",me,"Email: "+m(o.email),1)):_("",!0)])],8,ie))),128))])):_("",!0)])]),e("div",null,[t[18]||(t[18]=e("h3",{class:"text-lg font-medium text-gray-900 dark:text-dark-text mb-2"},"Sản phẩm/Dịch vụ",-1)),e("button",{type:"button",onClick:t[2]||(t[2]=(...o)=>a.addOrderItem&&a.addOrderItem(...o)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-dark-bg"}," Thêm sản phẩm/dịch vụ "),(l(!0),c(p,null,v(a.form.order_items,(o,g)=>(l(),c("div",{key:g,class:"mb-4 p-4 border rounded-md border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface"},[e("div",ue,[e("div",null,[t[9]||(t[9]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),b(e("select",{"onUpdate:modelValue":i=>o.item_type=i,onChange:i=>a.searchItems(g),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},t[8]||(t[8]=[e("option",{value:"product"},"Sản phẩm",-1),e("option",{value:"service"},"Dịch vụ",-1)]),40,ge),[[M,o.item_type]])]),o.item_type==="service"?(l(),c("div",be,[t[11]||(t[11]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),b(e("select",{"onUpdate:modelValue":i=>o.service_type=i,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},t[10]||(t[10]=[e("option",{value:"single"},"Đơn lẻ",-1),e("option",{value:"combo_5"},"Combo 5",-1),e("option",{value:"combo_10"},"Combo 10",-1)]),8,pe),[[M,o.service_type]])])):_("",!0)]),e("div",he,[t[14]||(t[14]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),b(e("input",{type:"text","onUpdate:modelValue":i=>o.search=i,onInput:i=>a.searchItems(g),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:o.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ye),[[P,o.search]]),o.searchResults.length>0?(l(),c("ul",ke,[(l(!0),c(p,null,v(o.searchResults,i=>(l(),c("li",{key:i.id,onClick:f=>a.selectItem(g,i),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-primary-50 dark:hover:bg-dark-surface-hover"},[e("div",xe,[e("span",ve,m(i.name||i.service_name),1),i.item_type==="service"?(l(),c("span",_e,[k(" Đơn lẻ: "+m(a.formatCurrency(i.single_price))+" ",1),t[12]||(t[12]=e("br",null,null,-1)),k(" Combo 5: "+m(a.formatCurrency(i.combo_5_price))+" ",1),t[13]||(t[13]=e("br",null,null,-1)),k(" Combo 10: "+m(a.formatCurrency(i.combo_10_price)),1)])):(l(),c("span",we,m(a.formatCurrency(i.price)),1))])],8,fe))),128))])):_("",!0)]),e("div",Ce,[e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Số lượng:",-1)),b(e("input",{"onUpdate:modelValue":i=>o.quantity=i,type:"number",min:"1",class:"mt-1 focus:ring-primary-500 focus:border-primary-500 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-dark-border rounded-md dark:bg-dark-surface dark:text-dark-text"},null,8,Ve),[[P,o.quantity,void 0,{number:!0}]])]),e("div",null,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Đơn giá:",-1)),e("input",{value:a.formatCurrency(o.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Ue)]),e("div",null,[t[17]||(t[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-dark-text-secondary"},"Thành tiền:",-1)),e("input",{value:a.formatCurrency(o.quantity*o.price),class:"mt-1 block w-full rounded-md border-gray-300 dark:border-dark-border shadow-sm sm:text-sm bg-white dark:bg-dark-surface disabled:bg-gray-50 dark:disabled:bg-dark-surface disabled:text-gray-700 dark:disabled:text-dark-text disabled:border-gray-300 dark:disabled:border-dark-border disabled:cursor-not-allowed",readonly:""},null,8,Te)])]),e("button",{type:"button",onClick:i=>a.removeOrderItem(g),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,Se)]))),128))]),e("div",null,[t[20]||(t[20]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),b(e("select",{"onUpdate:modelValue":t[3]||(t[3]=o=>a.form.voucher_id=o),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[t[19]||(t[19]=e("option",{value:""},"Không áp dụng",-1)),(l(!0),c(p,null,v(n.vouchers,o=>(l(),c("option",{key:o.id,value:o.id},m(o.code)+" - "+m(o.discount_type==="percentage"?`${o.discount_value}%`:a.formatCurrency(o.discount_value)),9,Ie))),128))],512),[[M,a.form.voucher_id]])]),e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),b(e("select",{"onUpdate:modelValue":t[4]||(t[4]=o=>a.form.payment_method_id=o),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(l(!0),c(p,null,v(n.paymentMethods,o=>(l(),c("option",{key:o.id,value:o.id},m(o.method_name),9,Pe))),128))],512),[[M,a.form.payment_method_id]])]),e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),b(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=o=>a.form.note=o),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[P,a.form.note]])]),e("div",Me,[e("button",{type:"submit",disabled:a.isProcessing,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-opacity duration-200"},[a.isProcessing?(l(),c(p,{key:0},[t[23]||(t[23]=e("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),k(" "+m(a.form.payment_method_id===3?"Đang tạo link thanh toán...":"Đang xử lý..."),1)],64)):(l(),c(p,{key:1},[k(m(a.form.payment_method_id===3?"Tạo đơn và thanh toán PayOS":"Tạo đơn hàng và hóa đơn"),1)],64))],8,Ne),e("div",Re,[e("p",Le,"Tổng tiền: "+m(a.formatCurrency(a.calculateTotal())),1),e("p",Ae,"Giảm giá: -"+m(a.formatCurrency(a.calculateDiscount())),1),e("p",Fe,"Thành tiền: "+m(a.formatCurrency(a.calculateFinalTotal())),1)])])],32)])]),_:1}),a.isProcessing?(l(),c("div",Oe,[e("div",qe,[t[25]||(t[25]=e("svg",{class:"animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),e("p",ze,m(a.form.payment_method_id===3?"Đang tạo link thanh toán...":"Đang xử lý đơn hàng..."),1),t[26]||(t[26]=e("p",{class:"text-sm text-gray-500 dark:text-dark-text-muted mt-2"}," Vui lòng đợi trong giây lát ",-1))])])):_("",!0)]),_:1})}const Pt=re(oe,[["render",Be],["__scopeId","data-v-6b90d5ee"]]);export{Pt as default};

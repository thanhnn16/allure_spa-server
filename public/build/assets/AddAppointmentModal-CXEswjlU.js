import{r as v,c as _,e as n,o as ie,b as re,aU as r,a2 as l,a3 as i,bf as o,bM as J,a9 as f,bJ as g,bA as C,F as k,b0 as x,a1 as p,bz as M,j as R,bK as le,n as oe}from"./@vue-BRgAy5zV.js";import{u as ne}from"./vue-toastification-ejyjJRED.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"relative bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full m-4 transform transition-all"},ce={class:"p-6 border-b border-gray-200 dark:border-gray-700"},ve={class:"text-2xl font-semibold text-gray-800 dark:text-white"},ge={class:"mt-1 text-sm text-gray-500 dark:text-gray-400"},pe={class:"grid grid-cols-2 gap-6"},me={class:"relative"},_e={class:"relative"},fe={key:0,class:"absolute z-20 mt-1 w-full bg-white dark:bg-slate-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto"},he=["onClick"],be={class:"font-medium dark:text-gray-200"},ye={class:"text-sm text-gray-500 dark:text-gray-400"},ke=["value"],xe={class:"col-span-2 grid grid-cols-2 gap-6"},we={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Te={key:0,class:"text-sm text-gray-500"},Se=["disabled"],Ve=["value"],Ue={key:0,class:"mt-1 text-sm text-red-600"},Ce={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Me={key:0,class:"text-sm text-gray-500"},Ee=["disabled"],De=["value"],Le={key:0,class:"mt-1 text-sm text-red-600"},Ke={class:"col-span-2 grid grid-cols-2 gap-6"},$e=["value","disabled"],Fe={class:"col-span-2 grid grid-cols-2 gap-6"},Ae=["value"],je=["max"],Be={key:0,class:"mt-1 text-sm text-red-600"},Ne={key:1,class:"text-xs text-gray-500 dark:text-gray-400 mt-1"},ze={class:"col-span-2"},Ie={class:"mt-8 flex justify-end space-x-4"},Ge={__name:"AddAppointmentModal",props:{show:Boolean,appointments:{type:Array,default:()=>[]},closeModal:{type:Function,required:!0},selectedTimeSlot:{type:Object,default:()=>({})}},emits:["close","save","appointmentAdded"],setup(K,{emit:Y}){var P,q;const E=ne(),d=K,$=Y,h=v(""),m=v([]),F=v(null),u=v({}),y=v([]),w=v([]),D=v([]),c=v([]),L=()=>{var a,e;t.value={user_id:"",service_id:"",staff_id:c.value.length>0?c.value[0].id:"",appointment_date:((a=d.selectedTimeSlot)==null?void 0:a.date)||"",time_slot_id:((e=d.selectedTimeSlot)==null?void 0:e.timeSlotId)||"",appointment_type:"consultation",status:"pending",note:"",slots:1},F.value=null,h.value=""},t=v({user_id:"",staff_id:"",appointment_date:((P=d.selectedTimeSlot)==null?void 0:P.date)||"",time_slot_id:((q=d.selectedTimeSlot)==null?void 0:q.id)||"",appointment_type:"service",status:"confirmed",note:"",slots:1,service_id:null,user_service_package_id:null}),A=_(()=>d.appointments&&d.appointments.length>0?"Chỉnh sửa lịch hẹn":"Thêm lịch hẹn mới"),j=_(()=>!!t.value.user_service_package_id),B=_(()=>!!t.value.service_id);_(()=>[{value:"service",label:"Thực hiện dịch vụ"},{value:"service_package",label:"Thực hiện combo"},{value:"consultation",label:"Tư vấn"},{value:"others",label:"Khác"}]),n(()=>t.value.service_id,a=>{a&&(t.value.user_service_package_id=null,t.value.appointment_type="service")}),n(()=>t.value.user_service_package_id,a=>{a&&(t.value.service_id=null,t.value.appointment_type="service_package")});const N=async()=>{try{const a=await axios.get("/api/time-slots",{params:{date:t.value.appointment_date,service_id:t.value.service_id}});a.data&&a.data.data&&(w.value=a.data.data.map(e=>({...e,available:e.current_bookings<e.max_bookings,displayText:`${e.start_time.substring(0,5)} - ${e.end_time.substring(0,5)} (${e.current_bookings}/${e.max_bookings})`})))}catch(a){console.error("Error fetching time slots:",a),w.value=[]}};n([()=>t.value.appointment_date,()=>t.value.service_id],()=>{t.value.appointment_date&&N()}),n(()=>t.value.service_id,a=>{if(a){const e=y.value.find(s=>s.id===a);e&&(t.value.appointment_type=e.service_type)}}),n(()=>d.appointments,a=>{a&&a.length>0?(L(),Object.keys(a[0]).forEach(e=>{t.value[e]!==void 0&&(t.value[e]=a[0][e])}),t.value.start_date=z(a[0].start),t.value.end_date=z(a[0].end)):L()},{immediate:!0}),n(()=>d.selectedTimeSlot,a=>{a&&a.date&&oe(()=>{t.value={...t.value,appointment_date:a.date,time_slot_id:a.timeSlotId}})},{immediate:!0});function z(a){if(!a)return"";let e=new Date(a);return e.getFullYear()+"-"+T(e.getMonth()+1)+"-"+T(e.getDate())+"T"+T(e.getHours())+":"+T(e.getMinutes())}function T(a){return a<10?"0"+a:a}const S=()=>{L(),$("close")};function Q(){h.value.length>2?axios.get(`/api/users/search?query=${h.value}`).then(a=>{a.data&&a.data.data?m.value=a.data.data:(m.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error searching users:",a.response?a.response.data:a.message),m.value=[]}):m.value=[]}function W(a){F.value=a,t.value.user_id=a.id,m.value=[],h.value=a.full_name,X(a.id)}function X(a){axios.get(`/api/user-treatment-packages/${a}`).then(e=>{D.value=e.data.data||[]}).catch(e=>{console.error("Error fetching user treatment packages:",e),D.value=[]})}ie(()=>{Z(),I(),document.addEventListener("keydown",G),c.value.length>0&&(t.staff_id=c.value[0].id),N(),I()});const Z=async()=>{try{const a=await axios.get("/api/services/appointment");a.data&&a.data.data&&(y.value=a.data.data.map(e=>({...e,service_category:e.service_category||null})))}catch(a){console.error("Error fetching services:",a),y.value=[]}};function I(){axios.get("/api/users/get-staff-list").then(a=>{a.data&&a.data.data?(c.value=a.data.data,!t.value.staff_id&&c.value.length>0&&(t.value.staff_id=c.value[0].id)):(c.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error fetching staff list:",a.response?a.response.data:a.message),c.value=[]})}function G(a){a.key==="Escape"&&d.show&&S()}re(()=>{document.removeEventListener("keydown",G)});function ee(){if(!V.value)return;const a={user_id:t.value.user_id,staff_id:t.value.staff_id,appointment_date:t.value.appointment_date,time_slot_id:t.value.time_slot_id,appointment_type:t.value.appointment_type,status:"pending",note:t.value.note||"",slots:parseInt(t.value.slots)||1,service_id:t.value.service_id||null,user_service_package_id:t.value.user_service_package_id||null};te(a)}function te(a){axios.post(route("appointments.store"),a).then(e=>{e.data.success?($("appointmentAdded",e.data.data),d.closeModal(),E.success(e.data.message||"Đặt lịch hẹn thành công")):(e.data.errors&&(u.value=e.data.errors),E.error(e.data.message||"Có lỗi xảy ra khi tạo lịch hẹn"))}).catch(e=>{var s,b,O,H;console.error("Submit error:",e),(b=(s=e.response)==null?void 0:s.data)!=null&&b.errors?u.value=e.response.data.errors:u.value={general:["Đã có lỗi xảy ra khi tạo lịch hẹn"]},E.error(((H=(O=e.response)==null?void 0:O.data)==null?void 0:H.message)||"Có lỗi xảy ra khi tạo lịch hẹn")})}n(()=>y.value,()=>{},{deep:!0});const V=_(()=>!!(t.value.user_id&&t.value.staff_id&&t.value.appointment_date&&t.value.time_slot_id&&t.value.slots>=1&&t.value.slots<=U.value&&(t.value.service_id&&!t.value.user_service_package_id||!t.value.service_id&&t.value.user_service_package_id)));n(()=>t.value,()=>{u.value={}},{deep:!0});const U=_(()=>{if(!t.value.time_slot_id)return 0;const a=w.value.find(e=>e.id===t.value.time_slot_id);return a?a.max_bookings-a.current_bookings:0});n(()=>t.service_id,async a=>{var e;if(a)try{const s=await axios.get(`/api/services/${a}`);s.data.data&&(t.appointment_type=((e=s.data.data.category)==null?void 0:e.toLowerCase())||"others")}catch(s){console.error("Error fetching service details:",s)}}),n(()=>t.value.user_service_package_id,a=>{a?t.value.appointment_type="service_package":t.value.service_id||(t.value.appointment_type="consultation")});const ae=_(()=>{switch(t.value.appointment_type){case"service":return"Dịch vụ đơn lẻ";case"service_package":return"Gói điều trị";case"consultation":return"Tư vấn";default:return"Khác"}});n([()=>t.value.service_id,()=>t.value.user_service_package_id],([a,e])=>{e?t.value.appointment_type="service_package":a?t.value.appointment_type="service":t.value.appointment_type="consultation"});function se(){return t.value.user_id?t.value.staff_id?t.value.appointment_date?t.value.time_slot_id?!t.value.slots||t.value.slots<1||t.value.slots>2?"Số lượng slot không hợp lệ":!t.value.service_id&&!t.value.user_service_package_id?"Vui lòng chọn dịch vụ hoặc gói điều trị":t.value.service_id&&t.value.user_service_package_id?"Vui lòng chỉ chọn một trong hai: dịch vụ hoặc gói điều trị":"Vui lòng điền đầy đủ thông tin":"Vui lòng chọn khung giờ":"Vui lòng chọn ngày hẹn":"Vui lòng chọn nhân viên":"Vui lòng chọn khách hàng"}return(a,e)=>K.show?(r(),l("div",{key:0,class:"fixed inset-0 bg-gray-600/75 dark:bg-gray-900/90 overflow-y-auto h-full w-full flex justify-center items-center z-50 backdrop-blur-sm",onClick:J(S,["self"]),onKeydown:le(S,["esc"]),tabindex:"0"},[i("div",ue,[i("div",ce,[i("h2",ve,o(A.value),1),i("p",ge," Điền thông tin để "+o(A.value.toLowerCase()),1)]),i("form",{onSubmit:J(ee,["prevent"]),class:"p-6"},[i("div",pe,[i("div",me,[e[8]||(e[8]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khách hàng "),i("span",{class:"text-red-500"},"*")],-1)),i("div",_e,[g(i("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),onInput:Q,placeholder:"Tìm theo tên hoặc số điện thoại",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,544),[[C,h.value]]),m.value.length>0?(r(),l("div",fe,[(r(!0),l(k,null,x(m.value,s=>(r(),l("div",{key:s.id,onClick:b=>W(s),class:"p-3 hover:bg-gray-50 dark:hover:bg-slate-600 cursor-pointer border-b last:border-0 dark:border-gray-600"},[i("div",be,o(s.full_name),1),i("div",ye,o(s.phone_number),1)],8,he))),128))])):p("",!0)])]),i("div",null,[e[9]||(e[9]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Nhân viên phụ trách "),i("span",{class:"text-red-500"},"*")],-1)),g(i("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>t.value.staff_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[(r(!0),l(k,null,x(c.value,s=>(r(),l("option",{key:s.id,value:s.id},o(s.full_name),9,ke))),128))],512),[[M,t.value.staff_id]])]),i("div",xe,[i("div",null,[i("label",we,[e[10]||(e[10]=f(" Gói điều trị ")),B.value?(r(),l("span",Te,"(Đã chọn dịch vụ)")):p("",!0)]),g(i("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>t.value.user_service_package_id=s),disabled:B.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[11]||(e[11]=i("option",{value:""},"Chọn gói điều trị",-1)),(r(!0),l(k,null,x(D.value,s=>{var b;return r(),l("option",{key:s.id,value:s.id},o(((b=s.service)==null?void 0:b.service_name)||s.service_name)+" ("+o(s.remaining_sessions)+" buổi) ",9,Ve)}),128))],8,Se),[[M,t.value.user_service_package_id]]),u.value.user_service_package_id?(r(),l("div",Ue,o(u.value.user_service_package_id[0]),1)):p("",!0)]),i("div",null,[i("label",Ce,[e[12]||(e[12]=f(" Dịch vụ ")),j.value?(r(),l("span",Me,"(Đã chọn gói)")):p("",!0)]),g(i("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>t.value.service_id=s),disabled:j.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[13]||(e[13]=i("option",{value:""},"Chọn dịch vụ",-1)),(r(!0),l(k,null,x(y.value,s=>(r(),l("option",{key:s.id,value:s.id},o(s.name||s.service_name),9,De))),128))],8,Ee),[[M,t.value.service_id]]),u.value.service_id?(r(),l("div",Le,o(u.value.service_id[0]),1)):p("",!0)])]),i("div",Ke,[i("div",null,[e[14]||(e[14]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Ngày hẹn "),i("span",{class:"text-red-500"},"*")],-1)),g(i("input",{type:"date","onUpdate:modelValue":e[4]||(e[4]=s=>t.value.appointment_date=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,512),[[C,t.value.appointment_date]])]),i("div",null,[e[16]||(e[16]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khung giờ "),i("span",{class:"text-red-500"},"*")],-1)),g(i("select",{"onUpdate:modelValue":e[5]||(e[5]=s=>t.value.time_slot_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[e[15]||(e[15]=i("option",{value:""},"Chọn khung giờ",-1)),(r(!0),l(k,null,x(w.value,s=>(r(),l("option",{key:s.id,value:s.id,disabled:!s.available,class:R({"text-gray-400":!s.available})},o(s.displayText),11,$e))),128))],512),[[M,t.value.time_slot_id]])])]),i("div",Fe,[i("div",null,[e[17]||(e[17]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Loại lịch hẹn",-1)),i("input",{type:"text",value:ae.value,disabled:"",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white bg-gray-100"},null,8,Ae)]),i("div",null,[e[18]||(e[18]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Số lượng slot "),i("span",{class:"text-red-500"},"*")],-1)),g(i("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=s=>t.value.slots=s),min:"1",max:U.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,8,je),[[C,t.value.slots]]),u.value.slots?(r(),l("div",Be,o(u.value.slots[0]),1)):p("",!0),U.value?(r(),l("span",Ne," Còn trống: "+o(U.value)+" slot ",1)):p("",!0)])]),i("div",ze,[e[19]||(e[19]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Ghi chú",-1)),g(i("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>t.value.note=s),rows:"3",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200",placeholder:"Thêm ghi chú cho lịch hẹn..."},null,512),[[C,t.value.note]])])]),i("div",Ie,[i("button",{onClick:S,type:"button",class:"px-6 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"}," Đóng "),i("button",{type:"submit",class:R(["px-6 py-2.5 rounded-lg font-medium transition-all duration-200",{"bg-indigo-600 text-white hover:bg-indigo-700":V.value,"bg-gray-300 text-gray-500 cursor-not-allowed":!V.value}])},o(V.value?"Lưu":se()),3)])],32)])],32)):p("",!0)}},He=de(Ge,[["__scopeId","data-v-0fc8143c"]]);export{He as default};

import{r as h,c as D,o as le,aU as i,a2 as g,a3 as l,a0 as y,bl as c,a1 as T,aa as o,bH as d,bf as m,F,b0 as j,P as te,bM as E,j as se,e as P}from"./@vue-BRgAy5zV.js";import{b as z,a7 as oe,j as H,e as X,a8 as ne,d as re}from"./@mdi-C-p5d_Pb.js";import{_ as u}from"./BaseButton-eMTGofBM.js";import{_ as k}from"./FormField-Da_P6kO8.js";import{_ as x}from"./FormControl-BSsARiYM.js";import{_ as B}from"./CardBox-jfYP3QDG.js";import{a as f}from"./axios-CCb-kr4I.js";import{u as ie}from"./vue-toastification-ejyjJRED.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./@inertiajs-D0DMCEQB.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./colors-S7_1wET5.js";import"./BaseIcon-B4kwkOCn.js";import"./main-BNmBi4-k.js";import"./pinia-BhnhDyRZ.js";const ce={class:"space-y-6"},de={class:"flex justify-between items-center"},me={class:"flex items-center gap-4"},ve={class:"absolute top-4 right-4"},pe={class:"text-xl font-semibold mb-6"},he={class:"grid md:grid-cols-2 gap-6"},be={class:"space-y-4"},ge={class:"flex justify-between items-center"},fe={class:"flex-1"},_e={class:"flex-1"},ye={class:"flex-1"},ke={class:"flex justify-end gap-4"},xe={class:"grid gap-6 md:grid-cols-2 xl:grid-cols-3"},we={class:"absolute top-4 right-4 flex gap-2"},Ne={class:"text-lg font-semibold mb-2"},Ce={class:"text-gray-600 dark:text-gray-400 mb-4"},Ve={class:"space-y-2"},Te={class:"font-medium"},Ge={class:"mx-1"},Le={class:"font-medium"},$e={class:"mt-4 flex items-center gap-2"},Ue={class:"px-3 py-1 text-sm font-medium rounded-full bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-100"},Fe={class:"bg-white dark:bg-dark-surface p-6 rounded-lg w-full max-w-2xl mx-4"},je={class:"flex justify-between items-center mb-6"},Be={class:"grid grid-cols-2 gap-4"},Se={class:"p-4 rounded-lg bg-gray-50 dark:bg-dark-surface-hover"},Me={class:"text-2xl font-bold"},Ke={class:"p-4 rounded-lg bg-gray-50 dark:bg-dark-surface-hover"},qe={class:"text-2xl font-bold"},Ae={__name:"UserGroups",setup(De){const w=ie(),S=h([]),_=h(!1),b=h(null),v=h(!1),N=h(!1),C=h(null),G=h(!1),n=h({name:"",description:"",conditions:[{field:"",operator:"",value:""}]}),M=[{value:"loyalty_points",label:"Điểm tích lũy"},{value:"purchase_count",label:"Số lần mua hàng"},{value:"last_visit",label:"Lần ghé thăm cuối"},{value:"gender",label:"Giới tính"},{value:"age",label:"Độ tuổi"},{value:"skin_condition",label:"Tình trạng da"},{value:"total_spent",label:"Tổng chi tiêu"},{value:"membership_duration",label:"Thời gian là thành viên"},{value:"favorite_services",label:"Dịch vụ yêu thích"}],K={loyalty_points:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],purchase_count:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],last_visit:[{value:"within",label:"Trong vòng"},{value:"not_within",label:"Không trong vòng"},{value:"never",label:"Chưa từng ghé thăm"}],gender:[{value:"=",label:"Là"},{value:"!=",label:"Không phải là"}],age:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],skin_condition:[{value:"=",label:"Là"},{value:"contains",label:"Chứa"},{value:"not_contains",label:"Không chứa"}],total_spent:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],membership_duration:[{value:">=",label:"Lớn hơn hoặc bằng (tháng)"},{value:"<=",label:"Nhỏ hơn hoặc bằng (tháng)"},{value:"between",label:"Trong khoảng (tháng)"}],favorite_services:[{value:"includes",label:"Bao gồm"},{value:"excludes",label:"Không bao gồm"}]},I=D(()=>n.value.name&&n.value.conditions.every(e=>e.field&&e.operator&&ee(e))),L=e=>{P(()=>e.field,a=>{switch(e.operator="",e.value="",a){case"gender":e.operator="=",e.value="male";break;case"last_visit":e.operator="within",e.value="30";break;case"loyalty_points":case"purchase_count":e.operator=">=",e.value="0";break;case"age":e.operator=">=",e.value="18";break;case"skin_condition":e.operator="contains",e.value="";break;case"total_spent":e.operator=">=",e.value="1000000";break;case"membership_duration":e.operator=">=",e.value="1";break;case"favorite_services":e.operator="includes",e.value="";break}}),P(()=>e.operator,a=>{e.field==="last_visit"&&a==="never"?e.value="true":a==="between"&&(e.value="0,100")})},J=()=>{const e={field:"",operator:"",value:""};n.value.conditions.push(e),L(e)},O=e=>{n.value.conditions.length>1&&n.value.conditions.splice(e,1)},V=async()=>{try{v.value=!0;const e=await f.get("/api/user-groups");console.log("Fetched groups:",e.data),S.value=e.data.data}catch(e){w.error("Lỗi khi tải nhóm: "+e.message)}finally{v.value=!1}},Q=async()=>{try{G.value=!0,await f.post("/api/user-groups/sync-all"),w.success("Đồng bộ nhóm thành công"),await V()}catch(e){w.error("Lỗi khi đồng bộ nhóm: "+e.message)}finally{G.value=!1}},R=async e=>{try{v.value=!0;const a=await f.get(`/api/user-groups/${e}/stats`);C.value=a.data,N.value=!0}catch(a){w.error("Lỗi khi lấy thống kê: "+a.message)}finally{v.value=!1}},W=async()=>{try{v.value=!0,b.value?await f.put(`/api/user-groups/${b.value.id}`,n.value):await f.post("/api/user-groups",n.value),await V(),$()}catch(e){console.error("Lỗi khi lưu nhóm:",e)}finally{v.value=!1}},Y=e=>{b.value=e,n.value={name:e.name,description:e.description,conditions:Array.isArray(e.conditions)?[...e.conditions]:[{field:"",operator:"",value:""}]},n.value.conditions.forEach(a=>{L(a)}),_.value=!0},Z=async e=>{if(confirm("Bạn có chắc muốn xóa nhóm này?"))try{await f.delete(`/api/user-groups/${e}`),await V()}catch(a){console.error("Lỗi khi xóa nhóm:",a)}},$=()=>{n.value={name:"",description:"",conditions:[{field:"",operator:"",value:""}]},b.value=null,_.value=!1},ee=e=>{const{field:a,operator:t,value:s}=e;if(!s)return!1;switch(a){case"loyalty_points":case"purchase_count":case"age":if(t==="between"){const[r,p]=s.split(",");return!isNaN(r)&&!isNaN(p)&&Number(r)<=Number(p)}return!isNaN(s);case"last_visit":return t==="never"?!0:!isNaN(s)&&s>0;case"gender":return["male","female","other"].includes(s);case"skin_condition":return s.length>0;case"total_spent":if(t==="between"){const[r,p]=s.split(",");return!isNaN(r)&&!isNaN(p)&&Number(r)<=Number(p)}return!isNaN(s)&&Number(s)>=0;case"membership_duration":return!isNaN(s)&&Number(s)>0;case"favorite_services":return s.length>0;default:return!0}},ae=D(()=>e=>K[e]||[]);return le(()=>{V(),n.value.conditions.forEach(e=>{L(e)})}),(e,a)=>(i(),g("div",ce,[l("div",de,[l("div",me,[_.value?T("",!0):(i(),y(u,{key:0,color:"info",icon:c(z),label:"Tạo nhóm mới",onClick:a[0]||(a[0]=t=>_.value=!0)},null,8,["icon"])),o(u,{color:"success",icon:c(oe),loading:G.value,label:"Đồng bộ tất cả",onClick:Q},null,8,["icon","loading"])])]),_.value?(i(),y(B,{key:0,class:"mb-6 relative"},{default:d(()=>[l("div",ve,[o(u,{color:"light",icon:c(H),small:"",onClick:$},null,8,["icon"])]),l("h3",pe,m(b.value?"Chỉnh sửa nhóm":"Tạo nhóm mới"),1),l("form",{onSubmit:E(W,["prevent"]),class:"space-y-6"},[l("div",he,[o(k,{label:"Tên nhóm"},{default:d(()=>[o(x,{modelValue:n.value.name,"onUpdate:modelValue":a[1]||(a[1]=t=>n.value.name=t),type:"text",required:"",placeholder:"Nhập tên nhóm"},null,8,["modelValue"])]),_:1}),o(k,{label:"Mô tả"},{default:d(()=>[o(x,{modelValue:n.value.description,"onUpdate:modelValue":a[2]||(a[2]=t=>n.value.description=t),type:"textarea",placeholder:"Mô tả về nhóm"},null,8,["modelValue"])]),_:1})]),l("div",be,[l("div",ge,[a[5]||(a[5]=l("h4",{class:"font-semibold"},"Điều kiện",-1)),o(u,{color:"info",icon:c(z),small:"",onClick:J,label:"Thêm điều kiện"},null,8,["icon"])]),o(te,{name:"list",tag:"div",class:"space-y-4"},{default:d(()=>[(i(!0),g(F,null,j(n.value.conditions,(t,s)=>(i(),g("div",{key:s,class:"flex gap-4 items-start p-4 rounded-lg border dark:border-dark-border bg-white dark:bg-dark-surface transition-colors duration-150"},[l("div",fe,[o(k,{label:"Trường"},{default:d(()=>[o(x,{modelValue:t.field,"onUpdate:modelValue":r=>t.field=r,options:M,type:"select",required:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),l("div",_e,[o(k,{label:"Điều kiện"},{default:d(()=>[o(x,{modelValue:t.operator,"onUpdate:modelValue":r=>t.operator=r,options:ae.value(t.field),type:"select",required:""},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1024)]),l("div",ye,[o(k,{label:"Giá trị"},{default:d(()=>[o(x,{modelValue:t.value,"onUpdate:modelValue":r=>t.value=r,type:t.field==="gender"?"select":"text",options:t.field==="gender"?[{value:"male",label:"Nam"},{value:"female",label:"Nữ"},{value:"other",label:"Khác"}]:void 0,required:""},null,8,["modelValue","onUpdate:modelValue","type","options"])]),_:2},1024)]),n.value.conditions.length>1?(i(),y(u,{key:0,color:"danger",icon:c(X),small:"",onClick:r=>O(s)},null,8,["icon","onClick"])):T("",!0)]))),128))]),_:1})]),l("div",ke,[o(u,{type:"button",color:"light",label:"Hủy",onClick:$}),o(u,{type:"submit",color:"info",loading:v.value,disabled:!I.value,label:b.value?"Cập nhật":"Tạo nhóm"},null,8,["loading","disabled","label"])])],32)]),_:1})):T("",!0),l("div",xe,[(i(!0),g(F,null,j(S.value,t=>(i(),y(B,{key:t.id,class:se(["relative hover:shadow-lg transition-shadow duration-200",{"opacity-75":v.value}])},{default:d(()=>[l("div",we,[o(u,{color:"info",icon:c(ne),small:"",onClick:s=>R(t.id),title:"Xem thống kê"},null,8,["icon","onClick"]),o(u,{color:"success",icon:c(re),small:"",onClick:s=>Y(t),title:"Chỉnh sửa"},null,8,["icon","onClick"]),o(u,{color:"danger",icon:c(X),small:"",onClick:s=>Z(t.id),title:"Xóa"},null,8,["icon","onClick"])]),l("h3",Ne,m(t.name),1),l("p",Ce,m(t.description),1),l("div",Ve,[(i(!0),g(F,null,j(t.conditions,(s,r)=>{var p,q,A;return i(),g("div",{key:r,class:"text-sm text-gray-600 dark:text-gray-400 p-2 rounded-md bg-gray-50 dark:bg-dark-surface-hover"},[l("span",Te,m((p=M.find(U=>U.value===s.field))==null?void 0:p.label),1),l("span",Ge,m((A=(q=K[s.field])==null?void 0:q.find(U=>U.value===s.operator))==null?void 0:A.label),1),l("span",Le,m(s.value),1)])}),128))]),l("div",$e,[l("span",Ue,m(t.user_count)+" thành viên ",1)])]),_:2},1032,["class"]))),128))]),N.value&&C.value?(i(),y(B,{key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:a[4]||(a[4]=E(t=>N.value=!1,["self"]))},{default:d(()=>[l("div",Fe,[l("div",je,[a[6]||(a[6]=l("h3",{class:"text-xl font-semibold"},"Thống kê nhóm",-1)),o(u,{color:"light",icon:c(H),small:"",onClick:a[3]||(a[3]=t=>N.value=!1)},null,8,["icon"])]),l("div",Be,[l("div",Se,[a[7]||(a[7]=l("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"Tổng số thành viên",-1)),l("div",Me,m(C.value.total_users),1)]),l("div",Ke,[a[8]||(a[8]=l("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"Điểm trung bình",-1)),l("div",qe,m(Math.round(C.value.loyalty_points_avg)),1)])])])]),_:1})):T("",!0)]))}},ya=ue(Ae,[["__scopeId","data-v-47703163"]]);export{ya as default};

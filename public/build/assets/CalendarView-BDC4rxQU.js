import{Q as z,Z as K,F as f}from"./@inertiajs-D0DMCEQB.js";import{F as O,i as A,a as G,b as q,c as R}from"./@fullcalendar-DDjvMyrQ.js";import{L as U}from"./LayoutAuthenticated-C16ARFQf.js";import{_ as W}from"./SectionMain-Vot1TOkK.js";import Z from"./AddAppointmentModal-uaNexeIp.js";import{a as j}from"./axios-CCb-kr4I.js";import{t as Q}from"./tippy.js-CTHk8NJp.js";import{u as X}from"./vue-toastification-ejyjJRED.js";import{r as c,e as J,c as k,aU as M,a0 as Y,bH as I,aa as h,bl as N,a3 as u,a2 as tt,b0 as et,aI as st,bf as at,F as ot}from"./@vue-BRgAy5zV.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./preact-CD9qK7CG.js";import"./@mdi-D7koDRFv.js";import"./app-D7IfN5Sd.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";import"./@popperjs-CvwSYPO-.js";const rt={class:"mb-4 flex items-center gap-4 p-4 bg-white dark:bg-slate-800 rounded-lg shadow"},it={class:"flex gap-4"},nt={class:"calendar-container bg-white dark:bg-slate-800 rounded-lg shadow p-4"},te={__name:"CalendarView",props:{appointments:{type:Array,default:()=>[]},timeSlots:{type:Array,default:()=>[]},slotDuration:{type:String,default:"01:00:00"},slotMinTime:{type:String,default:"08:00:00"},slotMaxTime:{type:String,default:"18:30:00"}},setup(w){const n=w;z();const g=c(!1),P=c(null);c(!1);const y=c(null),p=c(n.appointments);J(()=>n.appointments,t=>{p.value=t},{deep:!0});const C=k(()=>p.value.map(t=>{var e,a,s,o,i;return{id:t.id,title:`${((e=t.user)==null?void 0:e.full_name)||"Không xác định"} - ${((a=t.service)==null?void 0:a.service_name)||"Không xác định"}`,start:t.start,end:t.end,className:`status-${t.status.toLowerCase()}`,slots:t.slots||1,extendedProps:{userId:t.user_id,serviceId:t.service_id,staffId:t.staff_user_id,appointmentType:t.appointment_type,status:t.status,timeSlotId:t.time_slot_id,userName:(s=t.user)==null?void 0:s.full_name,serviceName:(o=t.service)==null?void 0:o.service_name,staffName:(i=t.staff)==null?void 0:i.full_name,cancelledBy:t.cancelled_by,cancelledAt:t.cancelled_at,cancellationNote:t.cancellation_note,cancelledByUser:t.cancelled_by_user,slots:t.slots||1}}})),L=k(()=>({plugins:[A,G,q,R],initialView:"timeGridWeek",weekends:!0,events:C.value,locale:"vi",firstDay:1,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:{today:"Hôm nay",month:"Tháng",week:"Tuần",day:"Ngày",list:"Danh sách"},allDaySlot:!1,height:"auto",nowIndicator:!0,editable:!0,selectable:!0,eventResizableFromStart:!1,eventDurationEditable:!1,slotDuration:n.slotDuration,snapDuration:n.slotDuration,slotLabelInterval:n.slotDuration,slotMinTime:n.slotMinTime,slotMaxTime:n.slotMaxTime,slotLabelFormat:{hour:"numeric",minute:"2-digit",omitZeroMinute:!0,meridiem:"short"},moreLinkText:"Xem thêm",noEventsText:"Không có lịch hẹn nào",select:E,eventDragStart:t=>{t.el._tippy&&t.el._tippy.destroy(),document.querySelectorAll("[data-tippy-root]").forEach(a=>a.remove()),t.el.style.zIndex="auto"},eventDrop:t=>{b(t),t.el.style.zIndex="",setTimeout(()=>{t.el._tippy||_(t.el,t.event)},100)},eventDidMount:t=>{const e=t.event,a=e.extendedProps.slots||1,s=t.el,o=s.closest(".fc-timegrid-event-harness");if(o)if(s.addEventListener("dragstart",()=>{s._tippy&&s._tippy.destroy(),document.querySelectorAll("[data-tippy-root]").forEach(r=>r.remove()),s.style.zIndex="auto"}),s.addEventListener("dragend",()=>{s.style.zIndex="",setTimeout(()=>{s._tippy||_(s,e)},100)}),s.style="",s.classList.remove("full-slot-event","half-slot-event"),a===2)o.style.cssText=`
                    position: absolute !important;
                    inset: 0 !important;
                    width: 100% !important;
                `,s.style.cssText=`
                    position: absolute !important;
                    inset: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                `,s.classList.add("full-slot-event");else{const i=o.closest(".fc-timegrid-col"),m=Array.from(i.querySelectorAll(".fc-timegrid-event-harness")).indexOf(o);o.style.cssText=`
                    position: absolute !important;
                    top: 0 !important;
                    bottom: 0 !important;
                    width: 50% !important;
                    left: ${m===0?"0":"50%"} !important;
                `,s.style.cssText=`
                    position: absolute !important;
                    inset: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                `,s.classList.add("half-slot-event")}_(s,e)},eventClick:t=>{t.jsEvent.preventDefault(),f.visit(`/appointments/${t.event.id}`)},eventDrop:b,eventMaxStack:2,eventClassNames:t=>{const e=t.event.slots||1;return[`${t.event.extendedProps.status.toLowerCase()}-event`,"calendar-event",e===2?"full-slot-event":"half-slot-event"]},themeSystem:"standard",views:{timeGrid:{dayMaxEvents:2,eventMaxStack:2,nowIndicator:!0,eventMinHeight:29}},selectConstraint:{start:new Date().toISOString()},selectOverlap:function(t){return t?t.extendedProps.slots===1:!0},eventConstraint:{start:new Date().toISOString()}})),T=c(null);function E(t){const e=new Date(t.start),a=new Date,s=new Date(a.getTime()+60*60*1e3);if(e<s){d.error("Vui lòng đặt lịch trước ít nhất 1 tiếng");return}const o=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0"),r=n.timeSlots.find(m=>{const x=m.start_time.substring(0,5),l=`${o}:${i}`;return x===l});if(!r){d.error("Vui lòng chọn đúng khung giờ");return}if(r.current_bookings>=r.max_bookings){d.error("Khung giờ này đã đầy");return}T.value={date:t.startStr.split("T")[0],timeSlotId:r.id,startTime:r.start_time,endTime:r.end_time},g.value=!0}function b(t){const e=t.event,a=new Date(e.start),s=new Date,o=new Date(s.getTime()+60*60*1e3);if(a<o){d.error("Vui lòng đặt lịch trước ít nhất 1 tiếng"),t.revert(),f.visit(route("appointments.index"),{preserveScroll:!0,preserveState:!1,only:["appointments"]});return}const i=a.getHours().toString().padStart(2,"0"),r=a.getMinutes().toString().padStart(2,"0"),m=n.timeSlots.find(l=>{const S=l.start_time.substring(0,5),v=`${i}:${r}`;return S===v});if(!m){d.error("Vui lòng kéo thả vào đúng khung giờ"),t.revert();return}const x={staff_id:e.extendedProps.staffId,appointment_date:e.start.toISOString().split("T")[0],time_slot_id:m.id,status:e.extendedProps.status,appointment_type:e.extendedProps.appointmentType,slots:e.extendedProps.slots||1};j.put(`/api/appointments/${e.id}`,x).then(l=>{if(l.data.success)d.success("Cập nhật lịch hẹn thành công"),f.visit(route("appointments.index"),{preserveScroll:!0,preserveState:!1,only:["appointments"]});else throw new Error(l.data.message||"Có lỗi xảy ra")}).catch(l=>{var v,$;console.error("Error:",l);const S=(($=(v=l.response)==null?void 0:v.data)==null?void 0:$.message)||"Có lỗi xảy ra khi cập nhật lịch hẹn";d.error(S),t.revert(),f.visit(route("appointments.index"),{preserveScroll:!0,preserveState:!1,only:["appointments"]})})}function D(){g.value=!1,P.value=null}const d=X();function H(t){var a,s,o,i,r;if(!t||!t.time_slot){console.error("Invalid appointment data:",t);return}const e={...t,id:t.id,title:`${((a=t.user)==null?void 0:a.full_name)||"N/A"} - ${((s=t.service)==null?void 0:s.service_name)||"N/A"}`,start:`${t.appointment_date} ${t.time_slot.start_time}`,end:`${t.appointment_date} ${t.time_slot.end_time}`,extendedProps:{userId:t.user_id,serviceId:t.service_id,staffId:t.staff_id,appointmentType:t.appointment_type,status:t.status,timeSlotId:t.time_slot_id,userName:(o=t.user)==null?void 0:o.full_name,serviceName:(i=t.service)==null?void 0:i.service_name,staffName:(r=t.staff)==null?void 0:r.full_name}};p.value=[...p.value,e],y.value&&y.value.getApi().refetchEvents()}const B=[{status:"Đang chờ",class:"status-pending",color:"#fbbf24"},{status:"Đã xác nhận",class:"status-confirmed",color:"#34d399"},{status:"Đã hủy",class:"status-cancelled",color:"#ef4444"},{status:"Hoàn thành",class:"status-completed",color:"#3b82f6"}],F=c(!0);function V(t){if(!t)return"N/A";const e=new Date(t);return new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e)}function _(t,e){var o;const a=`
        <div class="p-2">
            <div class="font-bold">${e.extendedProps.userName||"Không xác định"}</div>
            <div>Dịch vụ: ${e.extendedProps.serviceName||"Không xác định"}</div>
            <div>Nhân viên: ${e.extendedProps.staffName||"Không xác định"}</div>
            <div>Trạng thái: ${e.extendedProps.status}</div>
            <div>Số slot: ${e.extendedProps.slots||1}</div>
            ${e.extendedProps.status==="cancelled"?`
                <div class="mt-2 pt-2 border-t">
                    <div>Hủy bởi: ${((o=e.extendedProps.cancelledByUser)==null?void 0:o.full_name)||"Không xác định"}</div>
                    <div>Thời gian hủy: ${V(e.extendedProps.cancelledAt)}</div>
                    ${e.extendedProps.cancellationNote?`<div>Lý do: ${e.extendedProps.cancellationNote}</div>`:""}
                </div>
            `:""}
        </div>
    `,s=Q(t,{content:a,allowHTML:!0,placement:"top",theme:"light-border",delay:[200,0],interactive:!0,zIndex:999999,appendTo:document.body,popperOptions:{modifiers:[{name:"preventOverflow",options:{altAxis:!0,padding:5}}]}});t._tippy=s}return(t,e)=>(M(),Y(U,null,{default:I(()=>[h(N(K),{title:"Lịch hẹn"}),h(W,{"is-aside-lg-active":F.value},{default:I(()=>[u("div",rt,[e[0]||(e[0]=u("span",{class:"font-semibold dark:text-slate-200"},"Trạng thái:",-1)),u("div",it,[(M(),tt(ot,null,et(B,a=>u("div",{key:a.status,class:"flex items-center gap-2 dark:text-slate-300"},[u("div",{class:"w-4 h-4 rounded",style:st({backgroundColor:a.color})},null,4),u("span",null,at(a.status),1)])),64))])]),u("div",nt,[h(N(O),{ref_key:"calendarRef",ref:y,options:L.value,class:"custom-calendar"},null,8,["options"])])]),_:1},8,["is-aside-lg-active"]),h(Z,{show:g.value,appointments:p.value,selectedTimeSlot:T.value,onClose:D,onAppointmentAdded:H,closeModal:D},null,8,["show","appointments","selectedTimeSlot"])]),_:1}))}};export{te as default};

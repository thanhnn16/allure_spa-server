import{Z as z,F as G}from"./@inertiajs-D0DMCEQB.js";import{_ as K}from"./SectionMain-BbIPmLtw.js";import{L as P}from"./LayoutAuthenticated-BvAVfgDR.js";import{r as _,c as j,e as D,b2 as M,aU as l,a0 as J,bH as E,aa as L,a3 as e,bM as X,bJ as g,bA as x,a2 as m,F as y,b0 as h,bf as c,a9 as w,a1 as C,bz as V}from"./@vue-BRgAy5zV.js";import{a as F}from"./axios-CCb-kr4I.js";import{l as Z}from"./lodash-D4AGecfG.js";import{u as Q}from"./vue-toastification-ejyjJRED.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./@mdi-BvzXeHmh.js";import"./app-Bm8xTv_r.js";import"./jspdf-Ciebq7We.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./laravel-echo-C9ppFO4I.js";import"./pusher-js-Cl-1XqxI.js";import"./laravel-vite-plugin-DEL3ZhID.js";import"./pinia-BhnhDyRZ.js";import"./firebase-DL3QX-oU.js";import"./@firebase--zA4YiqN.js";import"./idb-Bn1DMRyg.js";import"./BaseIcon-B4kwkOCn.js";import"./colors-S7_1wET5.js";import"./OverlayLayer-BSs7OF78.js";const Y={components:{Head:z,SectionMain:K,LayoutAuthenticated:P},props:{vouchers:Array,paymentMethods:Array},setup(U){const r=Q(),n=_({user_id:"",voucher_id:null,payment_method_id:"",order_items:[],note:"",total_amount:0,discount_amount:0}),s=_(""),b=_([]),I=_(null),T=Z.debounce(async()=>{if(s.value.length<2){b.value=[];return}try{const o=await F.get("/api/users/search",{params:{query:s.value}});b.value=o.data.data}catch(o){console.error("Search error:",o),b.value=[]}},300),S=o=>{n.value.user_id=o.id,I.value=o,s.value=o.full_name,b.value=[]},N=()=>{n.value.order_items.push({item_type:"product",item_id:null,service_type:"single",quantity:1,price:0,search:"",searchResults:[],selectedItem:null})},t=o=>{n.value.order_items.splice(o,1)},u=async o=>{const a=n.value.order_items[o];if(a.search.length<2){a.searchResults=[];return}try{const i=a.item_type==="product"?"/api/products/search":"/api/services/search",p=await F.get(i,{params:{query:a.search}});a.searchResults=p.data.data.map(H=>({...H,item_type:a.item_type}))}catch(i){console.error("Error searching items:",i),a.searchResults=[]}},d=(o,a)=>{const i=n.value.order_items[o];i.selectedItem=a,i.item_id=a.id,i.search=a.name||a.service_name,a.item_type==="service"?v(i):i.price=Number(a.price),i.searchResults=[],q()},f=()=>n.value.order_items.reduce((o,a)=>o+a.quantity*a.price,0),k=()=>{if(!n.value.voucher_id)return 0;const o=U.vouchers.find(i=>i.id===n.value.voucher_id);if(!o)return 0;const a=f();return o.discount_type==="percentage"?a*(o.discount_value/100):o.discount_value},R=()=>Math.max(0,f()-k()),q=()=>{n.value.total_amount=R(),n.value.discount_amount=k()},A=async()=>{var o,a;try{if(!n.value.user_id){r.error("Vui lòng chọn khách hàng");return}if(n.value.order_items.length===0){r.error("Vui lòng thêm ít nhất một sản phẩm hoặc dịch vụ");return}for(const p of n.value.order_items)if(!p.item_id||!p.selectedItem){r.error("Vui lòng chọn đầy đủ thông tin cho tất cả sản phẩm/dịch vụ");return}n.value.total_amount=f(),n.value.discount_amount=k();const i=await F.post("/orders",n.value);r.success("Đơn hàng đã được tạo thành công!"),G.visit(`/orders/${i.data.data.id}`)}catch(i){console.error("Error creating order:",i);const p=((a=(o=i.response)==null?void 0:o.data)==null?void 0:a.message)||"Có lỗi xảy ra khi tạo đơn hàng!";r.error(p)}},O=o=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(o),B=j(()=>["pending","confirmed","shipping","delivered"].includes(U.order.status));D(()=>n.value.order_items,o=>{o.forEach(a=>{a.selectedItem&&a.item_type==="service"&&v(a)})},{deep:!0});const v=o=>{if(o.selectedItem){switch(o.service_type){case"combo_5":o.price=Number(o.selectedItem.combo_5_price||0);break;case"combo_10":o.price=Number(o.selectedItem.combo_10_price||0);break;default:o.price=Number(o.selectedItem.single_price||0);break}q()}};return D(()=>n.value.order_items.map(o=>o.service_type),()=>{n.value.order_items.forEach(o=>{o.item_type==="service"&&o.selectedItem&&v(o)})},{deep:!0}),{form:n,userSearch:s,userResults:b,selectedUser:I,searchUsers:T,selectUser:S,addOrderItem:N,removeOrderItem:t,searchItems:u,selectItem:d,calculateTotal:f,calculateDiscount:k,calculateFinalTotal:R,formatCurrency:O,submitForm:A,canUpdateStatus:B,updateServicePrice:v}}},$={class:"container mx-auto px-4 py-8"},ee={class:"mb-4"},re={class:"relative"},te={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-dark-surface rounded-md shadow-lg border border-gray-200 dark:border-dark-border max-h-60 overflow-y-auto"},oe=["onClick"],se={class:"font-medium dark:text-gray-300"},ae={class:"text-sm text-gray-500 dark:text-gray-400"},ne={key:0,class:"ml-2"},de={class:"grid grid-cols-2 gap-4"},ie=["onUpdate:modelValue","onChange"],le={key:0},me=["onUpdate:modelValue"],ce={class:"mt-4"},ue=["onUpdate:modelValue","onInput","placeholder"],ge={key:0,class:"mt-1 bg-white dark:bg-dark-surface shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 dark:ring-gray-700 overflow-auto focus:outline-none sm:text-sm"},be=["onClick"],pe={class:"flex flex-col"},fe={class:"font-medium"},ye={key:0,class:"text-sm"},he={key:1,class:"text-sm"},ke={class:"mt-4 grid grid-cols-3 gap-4"},ve=["onUpdate:modelValue"],_e=["value"],xe=["value"],we=["onClick"],Ce=["value"],Ve=["value"],Ue={class:"flex justify-between items-center"},Ie={class:"text-right"},Te={class:"text-sm text-gray-600 dark:text-gray-400"},Se={class:"text-sm text-red-600 dark:text-red-400"},Ne={class:"text-lg font-bold text-indigo-600 dark:text-indigo-400"};function Me(U,r,n,s,b,I){const T=M("Head"),S=M("SectionMain"),N=M("LayoutAuthenticated");return l(),J(N,null,{default:E(()=>[L(T,{title:"Tạo đơn hàng mới"}),L(S,null,{default:E(()=>[e("div",$,[r[24]||(r[24]=e("h1",{class:"text-3xl font-bold mb-6 dark:text-gray-100"},"Tạo đơn hàng mới",-1)),e("form",{onSubmit:r[6]||(r[6]=X((...t)=>s.submitForm&&s.submitForm(...t),["prevent"])),class:"space-y-6"},[e("div",ee,[r[7]||(r[7]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"}," Khách hàng ",-1)),e("div",re,[g(e("input",{"onUpdate:modelValue":r[0]||(r[0]=t=>s.userSearch=t),onInput:r[1]||(r[1]=(...t)=>s.searchUsers&&s.searchUsers(...t)),type:"text",placeholder:"Nhập tên hoặc số điện thoại khách hàng...",class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,544),[[x,s.userSearch]]),s.userResults.length>0?(l(),m("div",te,[(l(!0),m(y,null,h(s.userResults,t=>(l(),m("div",{key:t.id,onClick:u=>s.selectUser(t),class:"p-3 hover:bg-gray-50 dark:hover:bg-dark-surface/70 cursor-pointer border-b border-gray-100 dark:border-dark-border last:border-0"},[e("div",se,c(t.full_name),1),e("div",ae,[w(" SĐT: "+c(t.phone_number)+" ",1),t.email?(l(),m("span",ne,"Email: "+c(t.email),1)):C("",!0)])],8,oe))),128))])):C("",!0)])]),e("div",null,[r[18]||(r[18]=e("h3",{class:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2"},"Sản phẩm/Dịch vụ",-1)),e("button",{type:"button",onClick:r[2]||(r[2]=(...t)=>s.addOrderItem&&s.addOrderItem(...t)),class:"mb-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Thêm sản phẩm/dịch vụ "),(l(!0),m(y,null,h(s.form.order_items,(t,u)=>(l(),m("div",{key:u,class:"mb-4 p-4 border rounded-md dark:border-dark-border dark:bg-dark-surface"},[e("div",de,[e("div",null,[r[9]||(r[9]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại:",-1)),g(e("select",{"onUpdate:modelValue":d=>t.item_type=d,onChange:d=>s.searchItems(u),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},r[8]||(r[8]=[e("option",{value:"product"},"Sản phẩm",-1),e("option",{value:"service"},"Dịch vụ",-1)]),40,ie),[[V,t.item_type]])]),t.item_type==="service"?(l(),m("div",le,[r[11]||(r[11]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Loại dịch vụ:",-1)),g(e("select",{"onUpdate:modelValue":d=>t.service_type=d,class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},r[10]||(r[10]=[e("option",{value:"single"},"Đơn lẻ",-1),e("option",{value:"combo_5"},"Combo 5",-1),e("option",{value:"combo_10"},"Combo 10",-1)]),8,me),[[V,t.service_type]])])):C("",!0)]),e("div",ce,[r[14]||(r[14]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Tìm kiếm:",-1)),g(e("input",{type:"text","onUpdate:modelValue":d=>t.search=d,onInput:d=>s.searchItems(u),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",placeholder:t.item_type==="product"?"Tìm sản phẩm":"Tìm liệu trình"},null,40,ue),[[x,t.search]]),t.searchResults.length>0?(l(),m("ul",ge,[(l(!0),m(y,null,h(t.searchResults,d=>(l(),m("li",{key:d.id,onClick:f=>s.selectItem(u,d),class:"cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white dark:hover:bg-indigo-600/80"},[e("div",pe,[e("span",fe,c(d.name||d.service_name),1),d.item_type==="service"?(l(),m("span",ye,[w(" Đơn lẻ: "+c(s.formatCurrency(d.single_price))+" ",1),r[12]||(r[12]=e("br",null,null,-1)),w(" Combo 5: "+c(s.formatCurrency(d.combo_5_price))+" ",1),r[13]||(r[13]=e("br",null,null,-1)),w(" Combo 10: "+c(s.formatCurrency(d.combo_10_price)),1)])):(l(),m("span",he,c(s.formatCurrency(d.price)),1))])],8,be))),128))])):C("",!0)]),e("div",ke,[e("div",null,[r[15]||(r[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Số lượng:",-1)),g(e("input",{"onUpdate:modelValue":d=>t.quantity=d,type:"number",min:"1",class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,8,ve),[[x,t.quantity,void 0,{number:!0}]])]),e("div",null,[r[16]||(r[16]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Đơn giá:",-1)),e("input",{value:s.formatCurrency(t.price),type:"text",class:"mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300",readonly:""},null,8,_e)]),e("div",null,[r[17]||(r[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Thành tiền:",-1)),e("input",{value:s.formatCurrency(t.quantity*t.price),readonly:"",class:"mt-1 bg-gray-100 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,8,xe)])]),e("button",{type:"button",onClick:d=>s.removeOrderItem(u),class:"mt-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Xóa ",8,we)]))),128))]),e("div",null,[r[20]||(r[20]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Voucher:",-1)),g(e("select",{"onUpdate:modelValue":r[3]||(r[3]=t=>s.form.voucher_id=t),class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[r[19]||(r[19]=e("option",{value:""},"Không áp dụng",-1)),(l(!0),m(y,null,h(n.vouchers,t=>(l(),m("option",{key:t.id,value:t.id},c(t.code)+" - "+c(t.discount_type==="percentage"?`${t.discount_value}%`:s.formatCurrency(t.discount_value)),9,Ce))),128))],512),[[V,s.form.voucher_id]])]),e("div",null,[r[21]||(r[21]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Phương thức thanh toán:",-1)),g(e("select",{"onUpdate:modelValue":r[4]||(r[4]=t=>s.form.payment_method_id=t),required:"",class:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},[(l(!0),m(y,null,h(n.paymentMethods,t=>(l(),m("option",{key:t.id,value:t.id},c(t.method_name),9,Ve))),128))],512),[[V,s.form.payment_method_id]])]),e("div",null,[r[22]||(r[22]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"Ghi chú:",-1)),g(e("textarea",{"onUpdate:modelValue":r[5]||(r[5]=t=>s.form.note=t),rows:"3",class:"mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-dark-surface dark:border-dark-border dark:text-gray-300"},null,512),[[x,s.form.note]])]),e("div",Ue,[r[23]||(r[23]=e("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," Tạo đơn hàng và hóa đơn ",-1)),e("div",Ie,[e("p",Te,"Tổng tiền: "+c(s.formatCurrency(s.calculateTotal())),1),e("p",Se,"Giảm giá: -"+c(s.formatCurrency(s.calculateDiscount())),1),e("p",Ne,"Thành tiền: "+c(s.formatCurrency(s.calculateFinalTotal())),1)])])],32)])]),_:1})]),_:1})}const vr=W(Y,[["render",Me],["__scopeId","data-v-363dfa3e"]]);export{vr as default};

import{a9 as pe,b as H,j as ve,aa as he,ab as ge,d as fe,e as be}from"./@mdi-ArhfA4cU.js";import{_ as C}from"./BaseButton-eMTGofBM.js";import{_ as I}from"./FormField-Da_P6kO8.js";import{_ as h}from"./FormControl-BSsARiYM.js";import{_ as _e}from"./CardBox-jfYP3QDG.js";import{a as F}from"./axios-CCb-kr4I.js";import{u as ye}from"./vue-toastification-ejyjJRED.js";import{C as R,A as ke,p as W,e as Y,c as xe,b as Ve,B as Ce,d as we}from"./chart.js-B5vlqDTT.js";import{c as $,b2 as Z,aU as r,a0 as k,a2 as g,a3 as o,bf as x,r as p,o as Ne,aa as n,bH as w,a9 as X,bl as N,F as O,b0 as D,a1 as $e,j as z,e as J}from"./@vue-BRgAy5zV.js";import{C as Q}from"./CardBoxModal-CC98zKJS.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./@inertiajs-D0DMCEQB.js";import"./deepmerge-CtOfIP5S.js";import"./call-bind-aBC2DkHY.js";import"./get-intrinsic-BKEvijrG.js";import"./es-errors-DzOT6E3C.js";import"./has-symbols-eVqrYdw7.js";import"./has-proto-JnoBQRdH.js";import"./function-bind-BbkWVFrm.js";import"./hasown-DYqjtFKE.js";import"./set-function-length-B5OANX0j.js";import"./define-data-property-DO9o5wXF.js";import"./es-define-property-tzmkNPou.js";import"./gopd-CEkvUycD.js";import"./has-property-descriptors-DphFXkuo.js";import"./qs-Bnt7aRCy.js";import"./side-channel-FJR906QQ.js";import"./object-inspect-D3SFxae_.js";import"./nprogress-uqLJ5xmn.js";import"./lodash.clonedeep-Bxvn-V0B.js";import"./lodash.isequal-BYpQg7Um.js";import"./colors-S7_1wET5.js";import"./BaseIcon-B4kwkOCn.js";import"./main-BNmBi4-k.js";import"./pinia-BhnhDyRZ.js";import"./@kurkle-BZxJdD1U.js";import"./BaseButtons-B17KSMwc.js";import"./OverlayLayer-BSs7OF78.js";const Te={__name:"PieChart",props:{data:{type:Object,required:!0},title:String},setup(b){R.register(ke,W,Y);const c=b,_=$(()=>({labels:Object.keys(c.data),datasets:[{data:Object.values(c.data),backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF"]}]})),v={responsive:!0,plugins:{legend:{position:"bottom"},title:{display:!0,text:c.title}}};return(f,y)=>{const V=Z("Pie");return r(),k(V,{data:_.value,options:v},null,8,["data"])}}},Ue={__name:"BarChart",props:{data:{type:Object,required:!0},title:String},setup(b){R.register(xe,Ve,Ce,we,W,Y);const c=b,_=$(()=>({labels:Object.keys(c.data),datasets:[{label:c.title,data:Object.values(c.data),backgroundColor:"#36A2EB"}]})),v={responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:c.title}}};return(f,y)=>{const V=Z("Bar");return r(),k(V,{data:_.value,options:v},null,8,["data"])}}},je={class:"p-4 bg-white dark:bg-dark-surface rounded-lg shadow"},Le={class:"flex items-center gap-3"},Be={class:"p-2 bg-primary-50 dark:bg-primary-900 rounded-full"},Se={class:"w-6 h-6 text-primary-500",viewBox:"0 0 24 24"},Ge=["d"],Oe={class:"text-sm text-gray-600 dark:text-gray-400"},De={class:"text-xl font-semibold"},A={__name:"StatCard",props:{title:String,value:[Number,String],icon:String},setup(b){const c=b,_=$(()=>pe[c.icon]);return(v,f)=>(r(),g("div",je,[o("div",Le,[o("div",Be,[(r(),g("svg",Se,[o("path",{d:_.value,fill:"currentColor"},null,8,Ge)]))]),o("div",null,[o("h4",Oe,x(b.title),1),o("p",De,x(b.value),1)])])]))}},Ae={class:"space-y-6"},Pe={class:"mb-6 flex items-center justify-between"},Ee={class:"flex items-center gap-4"},Ke={class:"flex items-center gap-2"},qe={class:"space-y-4"},Me={class:"space-y-4"},He={class:"flex items-center justify-between"},Ie={class:"flex gap-2 flex-1"},Xe={class:"grid gap-6 md:grid-cols-2 xl:grid-cols-3"},ze={class:"flex items-start justify-between"},Je={class:"text-lg font-semibold mb-1"},Qe={class:"text-sm text-gray-600 dark:text-gray-400"},Re={class:"flex items-center gap-2"},We={class:"mt-4 grid grid-cols-2 gap-4"},Ye={class:"space-y-2"},Ze={class:"space-y-2"},ea={class:"text-sm"},aa={class:"font-medium ml-1"},ta={class:"text-sm"},la={class:"font-medium ml-1"},sa={class:"mt-4 flex justify-end gap-2"},oa={key:0,class:"grid grid-cols-2 gap-6"},na={class:"col-span-1"},ra={class:"col-span-1"},ia={class:"col-span-2 grid grid-cols-3 gap-4"},ua={key:1,class:"flex justify-center items-center p-4"},ca={__name:"UserGroups",setup(b){const c=ye(),_=p([]),v=p(!1),f=p(null),y=p(!1),V=p(!1),m=p(null);p(!1);const T=p(""),j=p("all"),B=p(null),i=p({name:"",description:"",conditions:[{field:"",operator:"",value:""}]}),P=[{value:"loyalty_points",label:"Điểm tích lũy"},{value:"purchase_count",label:"Số lần mua hàng"},{value:"last_visit",label:"Lần ghé thăm cuối"},{value:"gender",label:"Giới tính"},{value:"age",label:"Độ tuổi"},{value:"skin_condition",label:"Tình trạng da"},{value:"total_spent",label:"Tổng chi tiêu"},{value:"membership_duration",label:"Thời gian là thành viên"},{value:"favorite_services",label:"Dịch vụ yêu thích"}],S={loyalty_points:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],purchase_count:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],last_visit:[{value:"within",label:"Trong vòng"},{value:"not_within",label:"Không trong vòng"},{value:"never",label:"Chưa từng ghé thăm"}],gender:[{value:"=",label:"Là"}],age:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],skin_condition:[{value:"=",label:"Là"},{value:"contains",label:"Chứa"},{value:"not_contains",label:"Không chứa"}],total_spent:[{value:">=",label:"Lớn hơn hoặc bằng"},{value:"<=",label:"Nhỏ hơn hoặc bằng"},{value:"between",label:"Trong khoảng"}],membership_duration:[{value:">=",label:"Lớn hơn hoặc bằng (tháng)"},{value:"<=",label:"Nhỏ hơn hoặc bằng (tháng)"},{value:"between",label:"Trong khoảng (tháng)"}],favorite_services:[{value:"includes",label:"Bao gồm"},{value:"excludes",label:"Không bao gồm"}]},E=(e,a)=>{switch(e){case"loyalty_points":case"purchase_count":return a==="between"?"0,100":"0";case"last_visit":return a==="never"?"true":"30";case"gender":return"male";case"age":return a==="between"?"18,60":"18";case"skin_condition":return"";case"total_spent":return a==="between"?"0,10000000":"1000000";case"membership_duration":return a==="between"?"1,12":"1";case"favorite_services":return"";default:return""}},G=e=>{J(()=>e.field,a=>{const t=typeof a=="object"?a.value:a;if(console.log("Field changed:",{actualField:t,currentOperator:e.operator,currentValue:e.value}),t){const l=S[t]||[];e.operator=l.length>0?l[0].value:"",e.value=E(t,e.operator),console.log("After field change:",{field:t,newOperator:e.operator,newValue:e.value})}else e.operator="",e.value=""}),J(()=>e.operator,(a,t)=>{const l=typeof e.field=="object"?e.field.value:e.field,s=typeof a=="object"?a.value:a,u=typeof t=="object"?t.value:t;console.log("Operator changed:",{field:l,oldOperator:u,newOperator:s,currentValue:e.value});const d=K({field:l,operator:s,value:e.value});if(console.log("Validation result:",{isValid:d,currentValue:e.value}),s!==u||!d){const U=E(l,s);console.log("Setting default value:",{from:e.value,to:U,reason:s!==u?"operator changed":"invalid value"}),e.value=U}})},ee=()=>{const e={field:"",operator:"",value:""};i.value.conditions.push(e),G(e)},ae=e=>{i.value.conditions.length>1&&i.value.conditions.splice(e,1)},L=async()=>{try{y.value=!0;const e=await F.get("/api/user-groups");console.log("Fetched groups:",e.data),_.value=e.data.data}catch(e){c.error("Lỗi khi tải nhóm: "+e.message)}finally{y.value=!1}},te=async e=>{try{y.value=!0;const a=await F.get(`/api/user-groups/${e}/stats`);m.value=a.data,V.value=!0}catch(a){c.error("Lỗi khi lấy thống kê: "+a.message)}finally{y.value=!1}},le=async()=>{try{y.value=!0,f.value?await F.put(`/api/user-groups/${f.value.id}`,i.value):await F.post("/api/user-groups",i.value),await L(),ne()}catch(e){console.error("Lỗi khi lưu nhóm:",e)}finally{y.value=!1}},se=e=>{f.value=e,i.value={name:e.name,description:e.description,conditions:Array.isArray(e.conditions)?[...e.conditions]:[{field:"",operator:"",value:""}]},i.value.conditions.forEach(a=>{G(a)}),v.value=!0},oe=async e=>{if(confirm("Bạn có chắc muốn xóa nhóm này?"))try{await F.delete(`/api/user-groups/${e}`),await L()}catch(a){console.error("Lỗi khi xóa nhóm:",a)}},ne=()=>{i.value={name:"",description:"",conditions:[{field:"",operator:"",value:""}]},f.value=null,v.value=!1},K=e=>{const a=typeof e.field=="object"?e.field.value:e.field,t=typeof e.operator=="object"?e.operator.value:e.operator,l=e.value;if(console.log("Validating condition:",{field:a,operator:t,value:l}),!l&&l!==!1)return console.log("Validation failed: empty value"),!1;let s=!1;switch(a){case"loyalty_points":case"purchase_count":case"total_spent":if(t==="between"){const[u,d]=l.split(",").map(Number);s=!isNaN(u)&&!isNaN(d)&&u<=d}else s=!isNaN(l)&&Number(l)>=0;break;case"last_visit":t==="never"?s=!0:s=!isNaN(l)&&Number(l)>0;break;case"gender":s=["male","female","other"].includes(l);break;case"skin_condition":s=l.length>0;break;case"membership_duration":if(t==="between"){const[u,d]=l.split(",").map(Number);s=!isNaN(u)&&!isNaN(d)&&u<=d&&u>0}s=!isNaN(l)&&Number(l)>0;break;case"favorite_services":s=l.length>0;break;default:s=!0}return console.log("Validation result:",{isValid:s,field:a,operator:t,value:l}),s};$(()=>i.value.name&&i.value.conditions.every(e=>e.field&&e.operator&&K(e)));const re=$(()=>e=>{const a=typeof e=="object"?e.value:e;return S[a]||[]}),ie=$(()=>{let e=_.value;return T.value&&(e=e.filter(a=>{var t;return a.name.toLowerCase().includes(T.value.toLowerCase())||((t=a.description)==null?void 0:t.toLowerCase().includes(T.value.toLowerCase()))})),j.value!=="all"&&(e=e.filter(a=>j.value==="active"?a.is_active:!a.is_active)),e}),ue=async e=>{try{B.value=e,await F.post(`/api/user-groups/${e}/sync`),await L(),c.success("Đồng bộ nhóm thành công")}catch(a){c.error("Lỗi khi đồng bộ nhóm: "+a.message)}finally{B.value=null}},ce=e=>{var l,s,u;const a=(l=P.find(d=>d.value===e.field))==null?void 0:l.label,t=(u=(s=S[e.field])==null?void 0:s.find(d=>d.value===e.operator))==null?void 0:u.label;return`${a} ${t} ${e.value}`},q=$(()=>{var e,a,t,l,s,u,d,U;return m.value?{gender:{labels:["Nam","Nữ","Khác"],datasets:[{data:[((e=m.value.gender_stats)==null?void 0:e.male)||0,((a=m.value.gender_stats)==null?void 0:a.female)||0,((t=m.value.gender_stats)==null?void 0:t.other)||0],backgroundColor:["#4CAF50","#2196F3","#9C27B0"]}]},age:{labels:["18-25","26-35","36-45","46-55","55+"],datasets:[{data:[((l=m.value.age_stats)==null?void 0:l["18-25"])||0,((s=m.value.age_stats)==null?void 0:s["26-35"])||0,((u=m.value.age_stats)==null?void 0:u["36-45"])||0,((d=m.value.age_stats)==null?void 0:d["46-55"])||0,((U=m.value.age_stats)==null?void 0:U["55+"])||0],backgroundColor:"#4CAF50"}]}}:{gender:{labels:[],datasets:[{data:[],backgroundColor:[]}]},age:{labels:[],datasets:[{data:[],backgroundColor:[]}]}}}),M=(e,a)=>{if(!e||!a||a==="between")return"text";switch(e){case"gender":return"select";case"loyalty_points":case"purchase_count":case"age":case"total_spent":case"membership_duration":return"number";case"last_visit":return a==="never"?"checkbox":"number";default:return"text"}},de=(e,a)=>{if(a==="between")switch(e){case"age":return"Ví dụ: 18,60";case"loyalty_points":return"Ví dụ: 0,1000";case"total_spent":return"Ví dụ: 0,10000000";default:return"Ví dụ: min,max"}switch(e){case"loyalty_points":return"Nhập số điểm";case"purchase_count":return"Nhập số lần mua";case"last_visit":return a==="never"?"":"Nhập số ngày";case"age":return"Nhập tuổi";case"total_spent":return"Nhập số tiền";case"membership_duration":return"Nhập số tháng";case"skin_condition":case"favorite_services":return"Nhập giá trị";default:return""}},me=(e,a)=>{switch(e){case"gender":return[{value:"male",label:"Nam"},{value:"female",label:"Nữ"},{value:"other",label:"Khác"}];case"skin_condition":return[{value:"dry",label:"Da khô"},{value:"oily",label:"Da dầu"},{value:"combination",label:"Da hỗn hợp"},{value:"sensitive",label:"Da nhạy cảm"}];default:return[]}};return Ne(()=>{L(),i.value.conditions.forEach(e=>{G(e)})}),(e,a)=>(r(),g("div",Ae,[o("div",Pe,[o("div",Ee,[n(h,{modelValue:T.value,"onUpdate:modelValue":a[0]||(a[0]=t=>T.value=t),type:"search",placeholder:"Tìm kiếm nhóm...",class:"max-w-xs"},null,8,["modelValue"]),o("div",Ke,[a[7]||(a[7]=o("span",{class:"text-sm text-gray-600 dark:text-gray-400"},"Hiển thị:",-1)),n(h,{modelValue:j.value,"onUpdate:modelValue":a[1]||(a[1]=t=>j.value=t),type:"select",options:[{value:"all",label:"Tất cả"},{value:"active",label:"Đang hoạt động"},{value:"inactive",label:"Không hoạt động"}],class:"w-40"},null,8,["modelValue"])])]),n(C,{color:"info",icon:N(H),onClick:a[2]||(a[2]=t=>v.value=!0)},{default:w(()=>a[8]||(a[8]=[X(" Tạo nhóm mới ")])),_:1},8,["icon"])]),n(Q,{modelValue:v.value,"onUpdate:modelValue":a[5]||(a[5]=t=>v.value=t),title:f.value?"Chỉnh sửa nhóm":"Tạo nhóm mới",onSubmit:le,button:f.value?"warning":"info","has-cancel":!0},{default:w(()=>[o("div",qe,[n(I,{label:"Tên nhóm"},{default:w(()=>[n(h,{modelValue:i.value.name,"onUpdate:modelValue":a[3]||(a[3]=t=>i.value.name=t),type:"text",placeholder:"Nhập tên nhóm",required:""},null,8,["modelValue"])]),_:1}),n(I,{label:"Mô tả"},{default:w(()=>[n(h,{modelValue:i.value.description,"onUpdate:modelValue":a[4]||(a[4]=t=>i.value.description=t),type:"textarea",placeholder:"Nhập mô tả nhóm"},null,8,["modelValue"])]),_:1}),o("div",Me,[o("div",He,[a[10]||(a[10]=o("h4",{class:"font-medium"},"Điều kiện",-1)),n(C,{color:"info",icon:N(H),small:"",onClick:ee},{default:w(()=>a[9]||(a[9]=[X(" Thêm điều kiện ")])),_:1},8,["icon"])]),(r(!0),g(O,null,D(i.value.conditions,(t,l)=>(r(),g("div",{key:l,class:"flex gap-4"},[n(h,{modelValue:t.field,"onUpdate:modelValue":s=>t.field=s,type:"select",options:P,class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),n(h,{modelValue:t.operator,"onUpdate:modelValue":s=>t.operator=s,type:"select",options:re.value(t.field),class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","options"]),o("div",Ie,[t.operator==="between"?(r(),k(h,{key:0,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,type:"text",placeholder:"Ví dụ: 0,100",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"])):M(t.field,t.operator)==="select"?(r(),k(h,{key:1,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,type:"select",options:me(t.field),class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","options"])):t.field==="last_visit"&&t.operator==="never"?(r(),k(h,{key:2,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,type:"checkbox",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"])):(r(),k(h,{key:3,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,type:M(t.field,t.operator),placeholder:de(t.field,t.operator),class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","type","placeholder"])),i.value.conditions.length>1?(r(),k(C,{key:4,color:"danger",icon:N(ve),small:"",onClick:s=>ae(l)},null,8,["icon","onClick"])):$e("",!0)])]))),128))])])]),_:1},8,["modelValue","title","button"]),o("div",Xe,[(r(!0),g(O,null,D(ie.value,t=>(r(),k(_e,{key:t.id,class:z(["relative hover:shadow-lg transition-shadow duration-200",{"opacity-75":!t.is_active}])},{default:w(()=>[o("div",ze,[o("div",null,[o("h3",Je,x(t.name),1),o("p",Qe,x(t.description),1)]),o("div",Re,[o("span",{class:z(["px-2 py-1 text-xs font-medium rounded-full",t.is_active?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100":"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100"])},x(t.is_active?"Đang hoạt động":"Không hoạt động"),3)])]),o("div",We,[o("div",Ye,[a[11]||(a[11]=o("div",{class:"text-sm font-medium"},"Điều kiện:",-1)),(r(!0),g(O,null,D(t.conditions,l=>(r(),g("div",{key:l.id,class:"text-sm p-2 rounded-md bg-gray-50 dark:bg-dark-surface-hover"},x(ce(l)),1))),128))]),o("div",Ze,[a[14]||(a[14]=o("div",{class:"text-sm font-medium"},"Thông tin:",-1)),o("div",ea,[a[12]||(a[12]=o("span",{class:"text-gray-600 dark:text-gray-400"},"Số thành viên:",-1)),o("span",aa,x(t.user_count),1)]),o("div",ta,[a[13]||(a[13]=o("span",{class:"text-gray-600 dark:text-gray-400"},"Đồng bộ lần cuối:",-1)),o("span",la,x(t.last_sync_at),1)])])]),o("div",sa,[n(C,{color:"info",icon:N(he),small:"",onClick:l=>te(t.id),title:"Xem thống kê"},null,8,["icon","onClick"]),n(C,{color:"success",icon:N(ge),small:"",onClick:l=>ue(t.id),loading:B.value===t.id,title:"Đồng bộ nhóm"},null,8,["icon","onClick","loading"]),n(C,{color:"warning",icon:N(fe),small:"",onClick:l=>se(t),title:"Chỉnh sửa"},null,8,["icon","onClick"]),n(C,{color:"danger",icon:N(be),small:"",onClick:l=>oe(t.id),title:"Xóa"},null,8,["icon","onClick"])])]),_:2},1032,["class"]))),128))]),n(Q,{modelValue:V.value,"onUpdate:modelValue":a[6]||(a[6]=t=>V.value=t),title:"Thống kê nhóm",button:"info","has-cancel":!0},{default:w(()=>{var t,l,s;return[m.value?(r(),g("div",oa,[o("div",na,[n(Te,{data:q.value.gender,title:"Phân bố giới tính"},null,8,["data"])]),o("div",ra,[n(Ue,{data:q.value.age,title:"Phân bố độ tuổi"},null,8,["data"])]),o("div",ia,[n(A,{title:"Tổng thành viên",value:((t=m.value)==null?void 0:t.total_users)||0,icon:"mdiAccountGroup"},null,8,["value"]),n(A,{title:"Điểm trung bình",value:((l=m.value)==null?void 0:l.loyalty_points_avg)||0,icon:"mdiStar"},null,8,["value"]),n(A,{title:"Lượt mua trung bình",value:((s=m.value)==null?void 0:s.purchase_count_avg)||0,icon:"mdiCart"},null,8,["value"])])])):(r(),g("div",ua,a[15]||(a[15]=[o("span",{class:"text-gray-500"},"Đang tải dữ liệu...",-1)])))]}),_:1},8,["modelValue"])]))}},Qa=Fe(ca,[["__scopeId","data-v-5245cb86"]]);export{Qa as default};

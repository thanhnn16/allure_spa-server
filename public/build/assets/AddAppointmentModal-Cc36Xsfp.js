import{r as v,c as m,e as n,o as ie,b as le,aU as l,a2 as r,a3 as i,bf as o,bM as J,a9 as f,bJ as g,bA as C,F as x,b0 as w,a1 as p,bz as M,j as R,bK as re,n as oe}from"./@vue-BRgAy5zV.js";import{u as ne}from"./vue-toastification-ejyjJRED.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"relative bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full m-4 transform transition-all"},ce={class:"p-6 border-b border-gray-200 dark:border-gray-700"},ve={class:"text-2xl font-semibold text-gray-800 dark:text-white"},ge={class:"mt-1 text-sm text-gray-500 dark:text-gray-400"},pe={class:"grid grid-cols-2 gap-6"},_e={class:"relative"},me={class:"relative"},fe={key:0,class:"absolute z-20 mt-1 w-full bg-white dark:bg-slate-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto"},be=["onClick"],he={class:"font-medium dark:text-gray-200"},ye={class:"text-sm text-gray-500 dark:text-gray-400"},ke=["value"],xe={class:"col-span-2 grid grid-cols-2 gap-6"},we={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Se={key:0,class:"text-sm text-gray-500"},Te=["disabled"],Ve=["value"],Ue={key:0,class:"mt-1 text-sm text-red-600"},Ce={class:"block text-sm font-medium mb-2 dark:text-gray-300"},Me={key:0,class:"text-sm text-gray-500"},Ee=["disabled"],Fe=["value"],De={key:0,class:"mt-1 text-sm text-red-600"},Le={class:"col-span-2 grid grid-cols-2 gap-6"},Ae=["value","disabled"],Ke={class:"col-span-2 grid grid-cols-2 gap-6"},$e=["value"],je=["max"],Be={key:0,class:"mt-1 text-sm text-red-600"},Ne={key:1,class:"text-xs text-gray-500 dark:text-gray-400 mt-1"},ze={class:"col-span-2"},Ie={class:"mt-8 flex justify-end space-x-4"},Ge={__name:"AddAppointmentModal",props:{show:Boolean,appointments:{type:Array,default:()=>[]},closeModal:{type:Function,required:!0},selectedTimeSlot:{type:Object,default:()=>({})}},emits:["close","save","appointmentAdded"],setup(L,{emit:Y}){var P,q;const E=ne(),d=L,A=Y,b=v(""),_=v([]),K=v(null),u=v({}),k=v([]),S=v([]),F=v([]),c=v([]),D=()=>{var a,t;e.value={user_id:"",service_id:"",staff_id:c.value.length>0?c.value[0].id:"",appointment_date:((a=d.selectedTimeSlot)==null?void 0:a.date)||"",time_slot_id:((t=d.selectedTimeSlot)==null?void 0:t.timeSlotId)||"",appointment_type:"consultation",status:"pending",note:"",slots:1},K.value=null,b.value=""},e=v({user_id:"",staff_id:"",appointment_date:((P=d.selectedTimeSlot)==null?void 0:P.date)||"",time_slot_id:((q=d.selectedTimeSlot)==null?void 0:q.id)||"",appointment_type:"service",status:"confirmed",note:"",slots:1,service_id:null,user_service_package_id:null}),$=m(()=>d.appointments&&d.appointments.length>0?"Chỉnh sửa lịch hẹn":"Thêm lịch hẹn mới"),j=m(()=>!!e.value.user_service_package_id),B=m(()=>!!e.value.service_id);m(()=>[{value:"service",label:"Thực hiện dịch vụ"},{value:"service_package",label:"Thực hiện combo"},{value:"consultation",label:"Tư vấn"},{value:"others",label:"Khác"}]),n(()=>e.value.service_id,a=>{a&&(e.value.user_service_package_id=null,e.value.appointment_type="service")}),n(()=>e.value.user_service_package_id,a=>{a&&(e.value.service_id=null,e.value.appointment_type="service_package")});const N=async()=>{try{const a=await axios.get("/api/time-slots",{params:{date:e.value.appointment_date,service_id:e.value.service_id}});a.data&&a.data.data&&(S.value=a.data.data.map(t=>({...t,available:t.current_bookings<t.max_bookings,displayText:`${t.start_time.substring(0,5)} - ${t.end_time.substring(0,5)} (${t.current_bookings}/${t.max_bookings})`})))}catch(a){console.error("Error fetching time slots:",a),S.value=[]}};n([()=>e.value.appointment_date,()=>e.value.service_id],()=>{e.value.appointment_date&&N()}),n(()=>e.value.service_id,a=>{if(a){const t=k.value.find(s=>s.id===a);t&&(e.value.appointment_type=t.service_type)}}),n(()=>d.appointments,a=>{a&&a.length>0?(D(),Object.keys(a[0]).forEach(t=>{e.value[t]!==void 0&&(e.value[t]=a[0][t])}),e.value.start_date=z(a[0].start),e.value.end_date=z(a[0].end)):D()},{immediate:!0}),n(()=>d.selectedTimeSlot,a=>{a&&a.date&&oe(()=>{e.value={...e.value,appointment_date:a.date,time_slot_id:a.timeSlotId}})},{immediate:!0});function z(a){if(!a)return"";let t=new Date(a);return t.getFullYear()+"-"+T(t.getMonth()+1)+"-"+T(t.getDate())+"T"+T(t.getHours())+":"+T(t.getMinutes())}function T(a){return a<10?"0"+a:a}const V=()=>{D(),A("close")};function Q(){b.value.length>2?axios.get(`/api/users/search?query=${b.value}`).then(a=>{a.data&&a.data.data?_.value=a.data.data:(_.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error searching users:",a.response?a.response.data:a.message),_.value=[]}):_.value=[]}function W(a){K.value=a,e.value.user_id=a.id,_.value=[],b.value=a.full_name,X(a.id)}function X(a){axios.get(`/api/user-treatment-packages/${a}`).then(t=>{F.value=t.data.data||[]}).catch(t=>{console.error("Error fetching user treatment packages:",t),F.value=[]})}ie(()=>{Z(),I(),document.addEventListener("keydown",G),c.value.length>0&&(e.staff_id=c.value[0].id),N(),I()});const Z=async()=>{try{const a=await axios.get("/api/services/appointment");a.data&&a.data.data&&(k.value=a.data.data.map(t=>({...t,service_category:t.service_category||null})))}catch(a){console.error("Error fetching services:",a),k.value=[]}};function I(){axios.get("/api/users/get-staff-list").then(a=>{a.data&&a.data.data?(c.value=a.data.data,!e.value.staff_id&&c.value.length>0&&(e.value.staff_id=c.value[0].id)):(c.value=[],console.warn("Unexpected response format:",a.data))}).catch(a=>{console.error("Error fetching staff list:",a.response?a.response.data:a.message),c.value=[]})}function G(a){a.key==="Escape"&&d.show&&V()}le(()=>{document.removeEventListener("keydown",G)});function ee(){if(console.log("validateAndSubmit called"),console.log("isFormValid:",h.value),!h.value){console.log("Form is not valid");return}const a={user_id:e.value.user_id,staff_id:e.value.staff_id,appointment_date:e.value.appointment_date,time_slot_id:e.value.time_slot_id,appointment_type:e.value.appointment_type,status:"pending",note:e.value.note||"",slots:parseInt(e.value.slots)||1,service_id:e.value.service_id||null,user_service_package_id:e.value.user_service_package_id||null};console.log("Submitting form data:",a),te(a)}function te(a){console.log("submitAppointment called with:",a),axios.post(route("appointments.store"),a).then(t=>{console.log("Submit response:",t),t.data.success?(A("appointmentAdded",t.data.data),d.closeModal(),E.success(t.data.message||"Đặt lịch hẹn thành công")):(t.data.errors&&(u.value=t.data.errors),E.error(t.data.message||"Có lỗi xảy ra khi tạo lịch hẹn"))}).catch(t=>{var s,y,O,H;console.error("Submit error:",t),(y=(s=t.response)==null?void 0:s.data)!=null&&y.errors?u.value=t.response.data.errors:u.value={general:["Đã có lỗi xảy ra khi tạo lịch hẹn"]},E.error(((H=(O=t.response)==null?void 0:O.data)==null?void 0:H.message)||"Có lỗi xảy ra khi tạo lịch hẹn")})}n(()=>k.value,()=>{},{deep:!0});const h=m(()=>!!(e.value.user_id&&e.value.staff_id&&e.value.appointment_date&&e.value.time_slot_id&&e.value.slots>=1&&e.value.slots<=U.value&&(e.value.service_id&&!e.value.user_service_package_id||!e.value.service_id&&e.value.user_service_package_id)));n(()=>e.value,()=>{u.value={}},{deep:!0});const U=m(()=>{if(!e.value.time_slot_id)return 0;const a=S.value.find(t=>t.id===e.value.time_slot_id);return a?a.max_bookings-a.current_bookings:0});n(()=>e.service_id,async a=>{var t;if(a)try{const s=await axios.get(`/api/services/${a}`);s.data.data&&(e.appointment_type=((t=s.data.data.category)==null?void 0:t.toLowerCase())||"others")}catch(s){console.error("Error fetching service details:",s)}}),n(()=>e.value.user_service_package_id,a=>{a?e.value.appointment_type="service_package":e.value.service_id||(e.value.appointment_type="consultation")});const ae=m(()=>{switch(e.value.appointment_type){case"service":return"Dịch vụ đơn lẻ";case"service_package":return"Gói điều trị";case"consultation":return"Tư vấn";default:return"Khác"}});n([()=>e.value.service_id,()=>e.value.user_service_package_id],([a,t])=>{t?e.value.appointment_type="service_package":a?e.value.appointment_type="service":e.value.appointment_type="consultation"});function se(){return e.value.user_id?e.value.staff_id?e.value.appointment_date?e.value.time_slot_id?!e.value.slots||e.value.slots<1||e.value.slots>2?"Số lượng slot không hợp lệ":!e.value.service_id&&!e.value.user_service_package_id?"Vui lòng chọn dịch vụ hoặc gói điều trị":e.value.service_id&&e.value.user_service_package_id?"Vui lòng chỉ chọn một trong hai: dịch vụ hoặc gói điều trị":"Vui lòng điền đầy đủ thông tin":"Vui lòng chọn khung giờ":"Vui lòng chọn ngày hẹn":"Vui lòng chọn nhân viên":"Vui lòng chọn khách hàng"}return n(()=>h.value,a=>{console.log("Form valid status:",a),console.log("Form values:",{user_id:e.value.user_id,staff_id:e.value.staff_id,appointment_date:e.value.appointment_date,time_slot_id:e.value.time_slot_id,slots:e.value.slots,service_id:e.value.service_id,user_service_package_id:e.value.user_service_package_id})}),(a,t)=>L.show?(l(),r("div",{key:0,class:"fixed inset-0 bg-gray-600/75 dark:bg-gray-900/90 overflow-y-auto h-full w-full flex justify-center items-center z-50 backdrop-blur-sm",onClick:J(V,["self"]),onKeydown:re(V,["esc"]),tabindex:"0"},[i("div",ue,[i("div",ce,[i("h2",ve,o($.value),1),i("p",ge," Điền thông tin để "+o($.value.toLowerCase()),1)]),i("form",{onSubmit:J(ee,["prevent"]),class:"p-6"},[i("div",pe,[i("div",_e,[t[8]||(t[8]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khách hàng "),i("span",{class:"text-red-500"},"*")],-1)),i("div",me,[g(i("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=s=>b.value=s),onInput:Q,placeholder:"Tìm theo tên hoặc số điện thoại",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,544),[[C,b.value]]),_.value.length>0?(l(),r("div",fe,[(l(!0),r(x,null,w(_.value,s=>(l(),r("div",{key:s.id,onClick:y=>W(s),class:"p-3 hover:bg-gray-50 dark:hover:bg-slate-600 cursor-pointer border-b last:border-0 dark:border-gray-600"},[i("div",he,o(s.full_name),1),i("div",ye,o(s.phone_number),1)],8,be))),128))])):p("",!0)])]),i("div",null,[t[9]||(t[9]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Nhân viên phụ trách "),i("span",{class:"text-red-500"},"*")],-1)),g(i("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>e.value.staff_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[(l(!0),r(x,null,w(c.value,s=>(l(),r("option",{key:s.id,value:s.id},o(s.full_name),9,ke))),128))],512),[[M,e.value.staff_id]])]),i("div",xe,[i("div",null,[i("label",we,[t[10]||(t[10]=f(" Gói điều trị ")),B.value?(l(),r("span",Se,"(Đã chọn dịch vụ)")):p("",!0)]),g(i("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>e.value.user_service_package_id=s),disabled:B.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[t[11]||(t[11]=i("option",{value:""},"Chọn gói điều trị",-1)),(l(!0),r(x,null,w(F.value,s=>{var y;return l(),r("option",{key:s.id,value:s.id},o(((y=s.service)==null?void 0:y.service_name)||s.service_name)+" ("+o(s.remaining_sessions)+" buổi) ",9,Ve)}),128))],8,Te),[[M,e.value.user_service_package_id]]),u.value.user_service_package_id?(l(),r("div",Ue,o(u.value.user_service_package_id[0]),1)):p("",!0)]),i("div",null,[i("label",Ce,[t[12]||(t[12]=f(" Dịch vụ ")),j.value?(l(),r("span",Me,"(Đã chọn gói)")):p("",!0)]),g(i("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>e.value.service_id=s),disabled:j.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[t[13]||(t[13]=i("option",{value:""},"Chọn dịch vụ",-1)),(l(!0),r(x,null,w(k.value,s=>(l(),r("option",{key:s.id,value:s.id},o(s.name||s.service_name),9,Fe))),128))],8,Ee),[[M,e.value.service_id]]),u.value.service_id?(l(),r("div",De,o(u.value.service_id[0]),1)):p("",!0)])]),i("div",Le,[i("div",null,[t[14]||(t[14]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Ngày hẹn "),i("span",{class:"text-red-500"},"*")],-1)),g(i("input",{type:"date","onUpdate:modelValue":t[4]||(t[4]=s=>e.value.appointment_date=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,512),[[C,e.value.appointment_date]])]),i("div",null,[t[16]||(t[16]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Khung giờ "),i("span",{class:"text-red-500"},"*")],-1)),g(i("select",{"onUpdate:modelValue":t[5]||(t[5]=s=>e.value.time_slot_id=s),class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},[t[15]||(t[15]=i("option",{value:""},"Chọn khung giờ",-1)),(l(!0),r(x,null,w(S.value,s=>(l(),r("option",{key:s.id,value:s.id,disabled:!s.available,class:R({"text-gray-400":!s.available})},o(s.displayText),11,Ae))),128))],512),[[M,e.value.time_slot_id]])])]),i("div",Ke,[i("div",null,[t[17]||(t[17]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Loại lịch hẹn",-1)),i("input",{type:"text",value:ae.value,disabled:"",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white bg-gray-100"},null,8,$e)]),i("div",null,[t[18]||(t[18]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},[f(" Số lượng slot "),i("span",{class:"text-red-500"},"*")],-1)),g(i("input",{type:"number","onUpdate:modelValue":t[6]||(t[6]=s=>e.value.slots=s),min:"1",max:U.value,class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200"},null,8,je),[[C,e.value.slots]]),u.value.slots?(l(),r("div",Be,o(u.value.slots[0]),1)):p("",!0),U.value?(l(),r("span",Ne," Còn trống: "+o(U.value)+" slot ",1)):p("",!0)])]),i("div",ze,[t[19]||(t[19]=i("label",{class:"block text-sm font-medium mb-2 dark:text-gray-300"},"Ghi chú",-1)),g(i("textarea",{"onUpdate:modelValue":t[7]||(t[7]=s=>e.value.note=s),rows:"3",class:"w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 transition-all duration-200",placeholder:"Thêm ghi chú cho lịch hẹn..."},null,512),[[C,e.value.note]])])]),i("div",Ie,[i("button",{onClick:V,type:"button",class:"px-6 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"}," Đóng "),i("button",{type:"submit",class:R(["px-6 py-2.5 rounded-lg font-medium transition-all duration-200",{"bg-indigo-600 text-white hover:bg-indigo-700":h.value,"bg-gray-300 text-gray-500 cursor-not-allowed":!h.value}])},o(h.value?"Lưu":se()),3)])],32)])],32)):p("",!0)}},He=de(Ge,[["__scopeId","data-v-a64160bd"]]);export{He as default};
